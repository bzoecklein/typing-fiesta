<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Typing Fiesta! - Learn to Type en Espanol</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --neon-pink: #ff2d95;
    --neon-blue: #00d4ff;
    --neon-green: #39ff14;
    --neon-purple: #b026ff;
    --neon-yellow: #fff700;
    --neon-orange: #ff6e00;
    --dark-bg: #0a0a2e;
    --darker-bg: #060618;
    --card-bg: rgba(255,255,255,0.04);
    --glass-bg: rgba(255,255,255,0.06);
    --glass-border: rgba(255,255,255,0.1);
  }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--darker-bg);
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
    cursor: default;
  }

  /* === CANVAS BACKGROUND === */
  #bg-canvas {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0; pointer-events: none;
  }

  /* === SCREEN TRANSITIONS === */
  .screen {
    display: none; position: relative; z-index: 1;
    min-height: 100vh;
    flex-direction: column; align-items: center; justify-content: center;
    padding: 2rem;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .screen.active {
    display: flex;
    animation: screenFadeIn 0.6s ease forwards;
  }
  @keyframes screenFadeIn {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  /* === GLASSMORPHISM MIXIN === */
  .glass {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.08);
  }

  /* === TITLE SCREEN === */
  .title-container { text-align: center; }

  .title-logo {
    font-family: 'Fredoka One', cursive;
    font-size: clamp(3rem, 9vw, 7rem);
    background: linear-gradient(135deg, var(--neon-pink), var(--neon-yellow), var(--neon-green), var(--neon-blue), var(--neon-purple));
    background-size: 400% 400%;
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientShift 4s ease infinite;
    filter: drop-shadow(0 0 40px rgba(255,45,149,0.3)) drop-shadow(0 0 80px rgba(176,38,255,0.2));
    line-height: 1.1;
    letter-spacing: -2px;
  }
  @keyframes gradientShift {
    0%,100% { background-position: 0% 50%; }
    25% { background-position: 100% 0%; }
    50% { background-position: 100% 100%; }
    75% { background-position: 0% 100%; }
  }

  .title-sub-row {
    display: flex; align-items: center; justify-content: center;
    gap: 0.8rem; margin: 0.8rem 0 0.5rem;
    flex-wrap: wrap;
  }
  .title-flag {
    font-size: 1.8rem;
    animation: flagWave 2s ease-in-out infinite;
  }
  @keyframes flagWave {
    0%,100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
  }

  .subtitle {
    font-size: 1.1rem; color: rgba(255,255,255,0.5);
    margin: 0 0 2.5rem; text-align: center;
    font-weight: 600;
  }

  .title-mascot {
    font-size: 5rem;
    animation: mascotBounce 2s ease-in-out infinite;
    margin-bottom: 1rem;
    filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
  }
  @keyframes mascotBounce {
    0%,100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-15px) scale(1.05); }
  }

  .player-select {
    display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center;
    margin-bottom: 2rem;
  }

  .player-card {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(16px);
    border: 2px solid rgba(255,255,255,0.08);
    border-radius: 24px;
    padding: 2rem 3rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-align: center;
    min-width: 200px;
    position: relative;
    overflow: hidden;
  }
  .player-card::before {
    content: '';
    position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 26px;
    background: linear-gradient(135deg, transparent, transparent);
    z-index: -1;
    transition: all 0.4s;
  }
  .player-card:hover {
    transform: translateY(-8px) scale(1.03);
    border-color: transparent;
    box-shadow: 0 20px 60px rgba(0,212,255,0.15), 0 0 0 1px rgba(0,212,255,0.3);
  }
  .player-card:hover::before {
    background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
  }
  .player-card.selected {
    border-color: transparent;
    box-shadow: 0 20px 60px rgba(57,255,20,0.15), 0 0 0 2px rgba(57,255,20,0.5);
  }
  .player-card.selected::before {
    background: linear-gradient(135deg, var(--neon-green), var(--neon-blue));
  }
  .player-card .avatar {
    font-size: 4rem; margin-bottom: 0.5rem;
    transition: transform 0.3s;
  }
  .player-card:hover .avatar { transform: scale(1.15) rotate(5deg); }
  .player-card .name {
    font-family: 'Fredoka One', cursive;
    font-size: 1.5rem;
  }
  .player-card .player-tag {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.3);
    margin-top: 0.3rem;
  }

  /* === BUTTONS === */
  .btn {
    font-family: 'Fredoka One', cursive;
    font-size: 1.3rem;
    padding: 1rem 3rem;
    border: none; border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-transform: uppercase;
    letter-spacing: 2px;
    position: relative;
    overflow: hidden;
  }
  .btn::after {
    content: '';
    position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    transition: left 0.5s;
  }
  .btn:hover::after { left: 100%; }
  .btn-play {
    background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple), var(--neon-blue));
    background-size: 200% 200%;
    animation: btnGlow 3s ease infinite;
    color: #fff;
    box-shadow: 0 8px 30px rgba(176,38,255,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  }
  @keyframes btnGlow {
    0%,100% { background-position: 0% 50%; box-shadow: 0 8px 30px rgba(176,38,255,0.3); }
    50% { background-position: 100% 50%; box-shadow: 0 8px 40px rgba(255,45,149,0.4); }
  }
  .btn-play:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 50px rgba(176,38,255,0.5);
  }
  .btn-play:active { transform: translateY(0) scale(0.98); }
  .btn-play:disabled {
    opacity: 0.3; cursor: not-allowed; transform: none;
    animation: none;
    box-shadow: none;
  }
  .btn-secondary {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(10px);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.12);
  }
  .btn-secondary:hover {
    background: rgba(255,255,255,0.12);
    border-color: var(--neon-blue);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,212,255,0.15);
  }

  /* === MODE SELECT SCREEN === */
  .mode-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.2rem; max-width: 880px; width: 100%; margin: 1.5rem 0;
  }
  .mode-card {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 20px;
    padding: 1.8rem 1.5rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .mode-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--neon-yellow), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }
  .mode-card:hover::before { opacity: 1; }
  .mode-card:hover {
    transform: translateY(-6px) scale(1.02);
    border-color: rgba(255,247,0,0.2);
    box-shadow: 0 20px 60px rgba(255,247,0,0.08), 0 0 0 1px rgba(255,247,0,0.1);
  }
  .mode-card .mode-icon {
    font-size: 3rem; margin-bottom: 0.8rem;
    display: inline-block;
    transition: transform 0.3s;
  }
  .mode-card:hover .mode-icon { transform: scale(1.2) rotate(-5deg); }
  .mode-card .mode-title {
    font-family: 'Fredoka One', cursive;
    font-size: 1.15rem; margin-bottom: 0.4rem;
  }
  .mode-card .mode-desc {
    font-size: 0.82rem; color: rgba(255,255,255,0.4);
    line-height: 1.4;
    margin-bottom: 0.6rem;
  }

  /* === DIFFICULTY BADGES === */
  .diff-badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 20px;
    font-size: 0.65rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }
  .diff-badge.easy { background: rgba(57,255,20,0.12); color: var(--neon-green); border: 1px solid rgba(57,255,20,0.2); }
  .diff-badge.medium { background: rgba(255,247,0,0.12); color: var(--neon-yellow); border: 1px solid rgba(255,247,0,0.2); }
  .diff-badge.hard { background: rgba(255,110,0,0.12); color: var(--neon-orange); border: 1px solid rgba(255,110,0,0.2); }
  .diff-badge.boss { background: rgba(255,45,149,0.12); color: var(--neon-pink); border: 1px solid rgba(255,45,149,0.2); }

  /* === GAME SCREEN === */
  .game-top-row {
    display: flex; align-items: center; gap: 1rem;
    width: 100%; max-width: 900px;
    margin-bottom: 1rem;
  }

  .mascot-box {
    flex-shrink: 0;
    width: 64px; height: 64px;
    display: flex; align-items: center; justify-content: center;
    font-size: 2.8rem;
    border-radius: 16px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    transition: all 0.3s;
  }
  .mascot-box.happy { border-color: rgba(57,255,20,0.3); box-shadow: 0 0 20px rgba(57,255,20,0.1); }
  .mascot-box.sad { border-color: rgba(255,45,149,0.3); box-shadow: 0 0 20px rgba(255,45,149,0.1); }
  .mascot-box.fire { border-color: rgba(255,110,0,0.3); box-shadow: 0 0 20px rgba(255,110,0,0.15); animation: mascotFire 0.5s ease infinite alternate; }
  @keyframes mascotFire { 0% { transform: scale(1); } 100% { transform: scale(1.08); } }

  .game-hud {
    display: flex; justify-content: space-around; align-items: center;
    flex: 1;
    padding: 0.8rem 1.2rem;
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px;
    flex-wrap: wrap; gap: 0.4rem;
  }
  .hud-item { text-align: center; min-width: 60px; }
  .hud-label {
    font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1.5px;
    color: rgba(255,255,255,0.3);
    font-weight: 700;
  }
  .hud-value {
    font-family: 'Fredoka One', cursive;
    font-size: 1.4rem;
    transition: all 0.3s;
  }
  .hud-value.score { color: var(--neon-yellow); }
  .hud-value.streak { color: var(--neon-orange); }
  .hud-value.wpm { color: var(--neon-green); }
  .hud-value.level { color: var(--neon-blue); }
  .hud-value.timer { color: var(--neon-pink); }
  .hud-value.score-pop { animation: scorePop 0.3s ease; }
  @keyframes scorePop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }

  /* XP bar */
  .xp-bar-container {
    width: 100%; max-width: 900px;
    height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    margin-bottom: 1rem;
    overflow: hidden;
    position: relative;
  }
  .xp-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--neon-green), var(--neon-blue), var(--neon-purple), var(--neon-pink));
    background-size: 300% 100%;
    animation: xpShimmer 3s linear infinite;
    border-radius: 3px;
    transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    width: 0%;
    box-shadow: 0 0 12px rgba(57,255,20,0.3);
  }
  @keyframes xpShimmer {
    0% { background-position: 0% 50%; }
    100% { background-position: 300% 50%; }
  }

  /* Spanish hint box */
  .spanish-hint {
    background: linear-gradient(135deg, rgba(200,169,97,0.08), rgba(255,247,0,0.04));
    border: 1px solid rgba(255,247,0,0.12);
    border-radius: 16px;
    padding: 1rem 2rem;
    margin-bottom: 1rem;
    text-align: center;
    max-width: 900px; width: 100%;
    position: relative;
    overflow: hidden;
  }
  .spanish-hint::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,247,0,0.4), transparent);
  }
  .hint-spanish {
    font-family: 'Fredoka One', cursive;
    font-size: 1.6rem;
    color: var(--neon-yellow);
    text-shadow: 0 0 30px rgba(255,247,0,0.2);
  }
  .hint-english {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.4);
    margin-top: 0.2rem;
  }
  .hint-category {
    display: inline-block;
    font-size: 0.65rem;
    background: rgba(255,255,255,0.06);
    padding: 3px 12px;
    border-radius: 12px;
    margin-top: 0.4rem;
    color: rgba(255,255,255,0.3);
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  /* Typing area */
  .typing-area {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 24px;
    padding: 2rem 2.5rem;
    max-width: 900px; width: 100%;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .typing-area.streak-glow {
    border-color: rgba(255,110,0,0.3);
    box-shadow: 0 0 40px rgba(255,110,0,0.08), inset 0 0 40px rgba(255,110,0,0.03);
  }
  .typing-area.big-streak-glow {
    border-color: rgba(57,255,20,0.3);
    box-shadow: 0 0 60px rgba(57,255,20,0.1), inset 0 0 60px rgba(57,255,20,0.03);
  }
  .typing-area::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
  }
  .typing-area.shake {
    animation: shake 0.4s ease;
  }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
  }

  .click-hint {
    position: absolute; bottom: 0.5rem; right: 1rem;
    font-size: 0.7rem; color: rgba(255,255,255,0.2);
    animation: pulse 2s ease infinite;
  }
  @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 0.7; } }

  .prompt-text {
    font-size: 1.6rem;
    line-height: 2.2;
    letter-spacing: 2px;
    font-family: 'Nunito', monospace;
    font-weight: 700;
    word-wrap: break-word;
    min-height: 60px;
  }
  .prompt-text .char {
    position: relative;
    display: inline-block;
    transition: all 0.15s ease;
    padding: 0 1px;
  }
  .prompt-text .char.correct {
    color: var(--neon-green);
    text-shadow: 0 0 8px rgba(57,255,20,0.3);
  }
  .prompt-text .char.incorrect {
    color: var(--neon-pink);
    background: rgba(255,45,149,0.15);
    border-radius: 3px;
    text-shadow: 0 0 8px rgba(255,45,149,0.3);
  }
  .prompt-text .char.current {
    color: #fff;
    background: rgba(0,212,255,0.25);
    border-radius: 4px;
    box-shadow: 0 0 15px rgba(0,212,255,0.2);
    animation: cursorPulse 1.2s ease-in-out infinite;
  }
  .prompt-text .char.upcoming { color: rgba(255,255,255,0.2); }
  @keyframes cursorPulse {
    0%,100% { background: rgba(0,212,255,0.25); box-shadow: 0 0 15px rgba(0,212,255,0.2); }
    50% { background: rgba(0,212,255,0.15); box-shadow: 0 0 8px rgba(0,212,255,0.1); }
  }

  .prompt-text .char.space-char.current::after {
    content: '¬∑';
    color: rgba(0,212,255,0.4);
  }

  /* Hidden input */
  .hidden-input {
    position: absolute; opacity: 0; pointer-events: none;
  }

  /* Combo popup */
  .combo-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-family: 'Fredoka One', cursive;
    font-size: 3.5rem;
    pointer-events: none;
    z-index: 100;
    text-shadow: 0 0 40px currentColor, 0 0 80px currentColor;
    animation: none;
  }
  .combo-popup.show {
    animation: comboAnim 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }
  @keyframes comboAnim {
    0% { transform: translate(-50%, -50%) scale(0) rotate(-15deg); opacity: 1; }
    25% { transform: translate(-50%, -50%) scale(1.4) rotate(5deg); opacity: 1; }
    50% { transform: translate(-50%, -55%) scale(1.1) rotate(-2deg); opacity: 1; }
    100% { transform: translate(-50%, -90%) scale(0.7); opacity: 0; }
  }

  /* Floating +points */
  .float-points {
    position: fixed;
    font-family: 'Fredoka One', cursive;
    font-size: 1.5rem;
    color: var(--neon-yellow);
    pointer-events: none;
    z-index: 99;
    text-shadow: 0 0 15px rgba(255,247,0,0.5);
    animation: floatUp 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
  }
  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-100px) scale(0.6); }
  }

  /* Perfect prompt flash */
  .perfect-flash {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-family: 'Fredoka One', cursive;
    font-size: 2.5rem;
    color: var(--neon-green);
    text-shadow: 0 0 30px rgba(57,255,20,0.5);
    pointer-events: none;
    z-index: 101;
    animation: perfectAnim 1s ease forwards;
  }
  @keyframes perfectAnim {
    0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 1; }
    30% { transform: translate(-50%, -50%) scale(1.2) rotate(3deg); opacity: 1; }
    100% { transform: translate(-50%, -70%) scale(0.9); opacity: 0; }
  }

  /* === RESULTS SCREEN === */
  .results-card {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(24px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 32px;
    padding: 3rem;
    max-width: 620px; width: 100%;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .results-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--neon-pink), var(--neon-yellow), var(--neon-green), var(--neon-blue));
    background-size: 300% 100%;
    animation: xpShimmer 3s linear infinite;
  }

  .results-rank {
    width: 100px; height: 100px;
    margin: 0 auto 1rem;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 3.5rem;
    position: relative;
  }
  .results-rank::before {
    content: '';
    position: absolute; inset: -3px;
    border-radius: 50%;
    background: conic-gradient(var(--neon-pink), var(--neon-yellow), var(--neon-green), var(--neon-blue), var(--neon-pink));
    z-index: -1;
    animation: rankSpin 4s linear infinite;
  }
  .results-rank::after {
    content: '';
    position: absolute; inset: 0;
    border-radius: 50%;
    background: var(--darker-bg);
    z-index: -1;
  }
  @keyframes rankSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .results-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2.5rem;
    margin-bottom: 0.3rem;
    background: linear-gradient(135deg, var(--neon-yellow), var(--neon-orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .results-subtitle {
    color: rgba(255,255,255,0.4);
    margin-bottom: 2rem;
    font-size: 0.95rem;
  }
  .results-stats {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 0.8rem; margin-bottom: 1.5rem;
  }
  .stat-box {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px;
    padding: 1.2rem 0.8rem;
    transition: all 0.3s;
  }
  .stat-box:hover {
    border-color: rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
  }
  .stat-box .stat-val {
    font-family: 'Fredoka One', cursive;
    font-size: 2.2rem;
  }
  .stat-box .stat-label {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.3);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 700;
  }

  /* Star rating */
  .star-rating {
    margin: 0.5rem 0 1.5rem;
    font-size: 2rem;
    letter-spacing: 4px;
  }
  .star-rating .star { display: inline-block; opacity: 0; animation: starAppear 0.4s ease forwards; }
  .star-rating .star.filled { filter: drop-shadow(0 0 8px rgba(255,247,0,0.5)); }
  .star-rating .star.empty { filter: grayscale(1) opacity(0.2); }
  @keyframes starAppear {
    0% { opacity: 0; transform: scale(0) rotate(-30deg); }
    100% { opacity: 1; transform: scale(1) rotate(0deg); }
  }

  /* Achievements */
  .achievements {
    display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }
  .achievement {
    display: flex; align-items: center; gap: 0.4rem;
    background: rgba(255,247,0,0.06);
    border: 1px solid rgba(255,247,0,0.12);
    border-radius: 20px;
    padding: 0.3rem 0.8rem;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--neon-yellow);
    opacity: 0;
    animation: achieveSlide 0.5s ease forwards;
  }
  @keyframes achieveSlide {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  .spanish-learned {
    background: rgba(255,247,0,0.03);
    border: 1px solid rgba(255,247,0,0.1);
    border-radius: 16px;
    padding: 1rem 1.2rem; margin-bottom: 1.5rem;
    text-align: left;
  }
  .spanish-learned h3 {
    font-family: 'Fredoka One', cursive;
    color: var(--neon-yellow);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  .spanish-learned .word-list {
    display: flex; flex-wrap: wrap; gap: 0.4rem;
  }
  .spanish-learned .word-chip {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 0.25rem 0.7rem;
    border-radius: 20px;
    font-size: 0.8rem;
    transition: all 0.2s;
  }
  .spanish-learned .word-chip:hover {
    background: rgba(255,247,0,0.1);
    border-color: rgba(255,247,0,0.2);
  }
  .spanish-learned .word-chip span {
    color: rgba(255,255,255,0.35);
    font-size: 0.7rem;
  }

  .results-actions {
    display: flex; gap: 0.8rem; justify-content: center; flex-wrap: wrap;
  }

  /* === KEYBOARD VISUAL === */
  .keyboard {
    display: flex; flex-direction: column;
    align-items: center; gap: 5px;
    max-width: 900px; width: 100%;
    margin-top: 0.5rem;
    padding: 1rem;
    background: rgba(255,255,255,0.02);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.04);
  }
  .kb-row { display: flex; gap: 4px; }
  .kb-key {
    width: 48px; height: 44px;
    background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
    border: 1px solid rgba(255,255,255,0.08);
    border-bottom: 3px solid rgba(255,255,255,0.04);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Nunito', sans-serif;
    font-size: 0.8rem; font-weight: 800;
    color: rgba(255,255,255,0.4);
    transition: all 0.12s ease;
    position: relative;
  }
  /* Finger color guides - subtle bottom accent */
  .kb-key.finger-left-pinky { box-shadow: inset 0 -2px 0 rgba(255,107,107,0.4); }
  .kb-key.finger-left-ring { box-shadow: inset 0 -2px 0 rgba(255,169,77,0.4); }
  .kb-key.finger-left-middle { box-shadow: inset 0 -2px 0 rgba(255,212,59,0.4); }
  .kb-key.finger-left-index { box-shadow: inset 0 -2px 0 rgba(105,219,124,0.4); }
  .kb-key.finger-right-index { box-shadow: inset 0 -2px 0 rgba(105,219,124,0.4); }
  .kb-key.finger-right-middle { box-shadow: inset 0 -2px 0 rgba(255,212,59,0.4); }
  .kb-key.finger-right-ring { box-shadow: inset 0 -2px 0 rgba(255,169,77,0.4); }
  .kb-key.finger-right-pinky { box-shadow: inset 0 -2px 0 rgba(255,107,107,0.4); }
  .kb-key.finger-thumb { box-shadow: inset 0 -2px 0 rgba(0,212,255,0.4); }

  .kb-key.active {
    background: linear-gradient(180deg, rgba(0,212,255,0.25) 0%, rgba(0,212,255,0.1) 100%);
    border-color: rgba(0,212,255,0.4);
    color: #fff;
    box-shadow: 0 0 20px rgba(0,212,255,0.2), inset 0 -2px 0 rgba(0,212,255,0.5);
    transform: translateY(-2px);
  }
  .kb-key.pressed-correct {
    background: linear-gradient(180deg, rgba(57,255,20,0.25) 0%, rgba(57,255,20,0.08) 100%);
    border-color: rgba(57,255,20,0.4);
    color: var(--neon-green);
    transform: translateY(1px);
    box-shadow: 0 0 15px rgba(57,255,20,0.2);
  }
  .kb-key.pressed-wrong {
    background: linear-gradient(180deg, rgba(255,45,149,0.25) 0%, rgba(255,45,149,0.08) 100%);
    border-color: rgba(255,45,149,0.4);
    color: var(--neon-pink);
    box-shadow: 0 0 15px rgba(255,45,149,0.2);
  }
  .kb-key.space { width: 280px; }
  .kb-key.wide { width: 72px; font-size: 0.6rem; }
  .kb-key.wider { width: 96px; font-size: 0.6rem; }

  /* Home row dots */
  .kb-key.home-row::after {
    content: '';
    position: absolute;
    bottom: 6px;
    width: 4px; height: 4px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
  }

  /* === PARTICLES === */
  .particle {
    position: fixed;
    pointer-events: none;
    z-index: 200;
    border-radius: 50%;
    animation: particleFly 0.8s ease-out forwards;
  }
  @keyframes particleFly {
    0% { opacity: 1; transform: translate(0,0) scale(1); }
    100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0); }
  }

  /* === CONFETTI === */
  .confetti {
    position: fixed;
    z-index: 300;
    pointer-events: none;
    animation: confettiFall var(--dur, 3s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }
  @keyframes confettiFall {
    0% { opacity: 1; transform: translateY(0) rotate(0deg) translateX(0); }
    25% { transform: translateY(25vh) rotate(180deg) translateX(var(--sway, 30px)); }
    50% { transform: translateY(50vh) rotate(360deg) translateX(calc(var(--sway, 30px) * -1)); }
    75% { transform: translateY(75vh) rotate(540deg) translateX(var(--sway, 30px)); }
    100% { opacity: 0; transform: translateY(105vh) rotate(720deg) translateX(0); }
  }

  /* Level up overlay */
  .level-up-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center; justify-content: center;
    z-index: 500;
  }
  .level-up-overlay.show { display: flex; }
  .level-up-box {
    text-align: center;
    animation: levelUpBounce 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .level-up-box .lu-emoji { font-size: 5rem; filter: drop-shadow(0 0 30px rgba(255,247,0,0.5)); }
  .level-up-box .lu-text {
    font-family: 'Fredoka One', cursive;
    font-size: 3.5rem;
    background: linear-gradient(135deg, var(--neon-yellow), var(--neon-orange), var(--neon-pink));
    background-size: 200% 200%;
    animation: gradientShift 2s ease infinite;
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .level-up-box .lu-sub {
    color: rgba(255,255,255,0.5);
    margin-top: 0.5rem;
    font-weight: 600;
  }
  @keyframes levelUpBounce {
    0% { transform: scale(0) rotate(-20deg); }
    50% { transform: scale(1.15) rotate(5deg); }
    70% { transform: scale(0.95) rotate(-2deg); }
    100% { transform: scale(1) rotate(0deg); }
  }

  .screen-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2rem;
    margin-bottom: 0.3rem;
    text-align: center;
  }

  /* === RESPONSIVE === */
  @media (max-width: 600px) {
    .kb-key { width: 30px; height: 34px; font-size: 0.65rem; }
    .kb-key.space { width: 150px; }
    .kb-key.wide { width: 44px; }
    .kb-key.wider { width: 60px; }
    .prompt-text { font-size: 1.2rem; letter-spacing: 1px; }
    .game-hud { padding: 0.6rem 0.8rem; }
    .typing-area { padding: 1.5rem; }
    .title-logo { font-size: clamp(2.5rem, 12vw, 4rem); }
    .mascot-box { width: 48px; height: 48px; font-size: 2rem; }
    .results-card { padding: 2rem 1.5rem; }
  }

  /* === PROGRESS DOTS === */
  .progress-dots {
    display: flex; gap: 4px; justify-content: center;
    max-width: 900px; width: 100%;
    margin-bottom: 0.8rem;
    flex-wrap: wrap;
  }
  .progress-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.08);
    transition: all 0.3s;
  }
  .progress-dot.done { background: var(--neon-green); box-shadow: 0 0 6px rgba(57,255,20,0.3); }
  .progress-dot.current { background: var(--neon-blue); box-shadow: 0 0 8px rgba(0,212,255,0.4); transform: scale(1.3); }
  .progress-dot.upcoming { background: rgba(255,255,255,0.06); }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div id="combo-popup" class="combo-popup"></div>
<div id="level-up-overlay" class="level-up-overlay">
  <div class="level-up-box">
    <div class="lu-emoji" id="lu-emoji"></div>
    <div class="lu-text" id="lu-text"></div>
    <div class="lu-sub" id="lu-sub"></div>
  </div>
</div>

<!-- ==================== TITLE SCREEN ==================== -->
<div id="screen-title" class="screen active">
  <div class="title-container">
    <div class="title-mascot">üéâ</div>
    <div class="title-logo">TYPING FIESTA!</div>
    <div class="title-sub-row">
      <span class="title-flag">üá∫üá∏</span>
      <span style="color:rgba(255,255,255,0.3); font-weight:800;">+</span>
      <span class="title-flag">üá™üá∏</span>
    </div>
    <div class="subtitle">Learn to type + learn Spanish = double W no cap</div>
  </div>

  <div class="player-select">
    <div class="player-card" data-player="Bryson" onclick="selectPlayer(this)">
      <div class="avatar">üéÆ</div>
      <div class="name">Bryson</div>
      <div class="player-tag">Player 1</div>
    </div>
    <div class="player-card" data-player="Angelina" onclick="selectPlayer(this)">
      <div class="avatar">üåü</div>
      <div class="name">Angelina</div>
      <div class="player-tag">Player 2</div>
    </div>
  </div>

  <button class="btn btn-play" id="btn-start" disabled onclick="showModeSelect()">
    Let's Go!
  </button>
</div>

<!-- ==================== MODE SELECT ==================== -->
<div id="screen-modes" class="screen">
  <div class="screen-title">Choose Your Vibe</div>
  <div class="subtitle" id="mode-greeting"></div>

  <div class="mode-grid">
    <div class="mode-card" onclick="startGame('vocab')">
      <div class="mode-icon">üìö</div>
      <div class="mode-title">Vocab Grind</div>
      <div class="mode-desc">Type Spanish words one at a time. Perfect for beginners!</div>
      <div class="diff-badge easy">Easy</div>
    </div>
    <div class="mode-card" onclick="startGame('phrases')">
      <div class="mode-icon">üí¨</div>
      <div class="mode-title">Frases Mode</div>
      <div class="mode-desc">Full Spanish phrases with English meanings. Mas dificil!</div>
      <div class="diff-badge medium">Medium</div>
    </div>
    <div class="mode-card" onclick="startGame('spanglish')">
      <div class="mode-icon">üî•</div>
      <div class="mode-title">Spanglish Remix</div>
      <div class="mode-desc">English sentences with Spanish words mixed in. Bussin!</div>
      <div class="diff-badge medium">Medium</div>
    </div>
    <div class="mode-card" onclick="startGame('boss')">
      <div class="mode-icon">üëë</div>
      <div class="mode-title">Boss Level</div>
      <div class="mode-desc">Full Spanish sentences. Only for the real ones. Sigma grindset!</div>
      <div class="diff-badge boss">Boss</div>
    </div>
    <div class="mode-card" onclick="startGame('race')">
      <div class="mode-icon">üèéÔ∏è</div>
      <div class="mode-title">Speed Race</div>
      <div class="mode-desc">60-second speed run! How many words can you type?</div>
      <div class="diff-badge hard">Timed</div>
    </div>
    <div class="mode-card" onclick="startGame('story')">
      <div class="mode-icon">üìñ</div>
      <div class="mode-title">Story Mode</div>
      <div class="mode-desc">Type through a bilingual adventure! New story each time!</div>
      <div class="diff-badge medium">Adventure</div>
    </div>
  </div>

  <button class="btn btn-secondary" onclick="showScreen('screen-title')" style="margin-top:1rem;">
    Back
  </button>
</div>

<!-- ==================== GAME SCREEN ==================== -->
<div id="screen-game" class="screen">
  <div class="game-top-row">
    <div class="mascot-box" id="mascot-box">üòä</div>
    <div class="game-hud">
      <div class="hud-item">
        <div class="hud-label">Score</div>
        <div class="hud-value score" id="hud-score">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Streak</div>
        <div class="hud-value streak" id="hud-streak">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">WPM</div>
        <div class="hud-value wpm" id="hud-wpm">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Level</div>
        <div class="hud-value level" id="hud-level">1</div>
      </div>
      <div class="hud-item" id="hud-timer-box" style="display:none;">
        <div class="hud-label">Time</div>
        <div class="hud-value timer" id="hud-timer">60</div>
      </div>
    </div>
  </div>

  <div class="xp-bar-container">
    <div class="xp-bar" id="xp-bar"></div>
  </div>

  <div class="progress-dots" id="progress-dots"></div>

  <div class="spanish-hint" id="spanish-hint">
    <div class="hint-spanish" id="hint-spanish"></div>
    <div class="hint-english" id="hint-english"></div>
    <div class="hint-category" id="hint-category"></div>
  </div>

  <div class="typing-area" id="typing-area" tabindex="0">
    <div class="prompt-text" id="prompt-text"></div>
    <div class="click-hint" id="click-hint">click here or start typing</div>
  </div>

  <input type="text" class="hidden-input" id="hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

  <div class="keyboard" id="keyboard"></div>
</div>

<!-- ==================== RESULTS SCREEN ==================== -->
<div id="screen-results" class="screen">
  <div class="results-card">
    <div class="results-rank" id="results-rank">üèÜ</div>
    <div class="results-title" id="results-title">GG!</div>
    <div class="results-subtitle" id="results-subtitle"></div>

    <div class="star-rating" id="star-rating"></div>

    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val score" id="res-score">0</div>
        <div class="stat-label">Score</div>
      </div>
      <div class="stat-box">
        <div class="stat-val wpm" id="res-wpm">0</div>
        <div class="stat-label">WPM</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" style="color:var(--neon-green)" id="res-accuracy">0%</div>
        <div class="stat-label">Accuracy</div>
      </div>
      <div class="stat-box">
        <div class="stat-val streak" id="res-streak">0</div>
        <div class="stat-label">Best Streak</div>
      </div>
    </div>

    <div class="achievements" id="achievements"></div>

    <div class="spanish-learned" id="spanish-learned">
      <h3>Spanish Words Practiced</h3>
      <div class="word-list" id="words-learned"></div>
    </div>

    <div class="results-actions">
      <button class="btn btn-play" onclick="startGame(currentMode)">Play Again</button>
      <button class="btn btn-secondary" onclick="showModeSelect()">Change Mode</button>
      <button class="btn btn-secondary" onclick="showScreen('screen-title')">Home</button>
    </div>
  </div>
</div>

<script>
// ============================================================
//  ANIMATED CANVAS BACKGROUND
// ============================================================
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');
let orbs = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function createOrbs() {
  orbs = [];
  const colors = [
    { r: 255, g: 45, b: 149 },   // pink
    { r: 0, g: 212, b: 255 },    // blue
    { r: 176, g: 38, b: 255 },   // purple
    { r: 57, g: 255, b: 20 },    // green
    { r: 255, g: 110, b: 0 },    // orange
  ];
  for (let i = 0; i < 6; i++) {
    const c = colors[i % colors.length];
    orbs.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.4,
      vy: (Math.random() - 0.5) * 0.4,
      radius: 200 + Math.random() * 200,
      color: c,
      opacity: 0.03 + Math.random() * 0.04,
    });
  }
}
createOrbs();

function drawBackground() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw orbs
  for (const orb of orbs) {
    orb.x += orb.vx;
    orb.y += orb.vy;
    if (orb.x < -orb.radius) orb.x = canvas.width + orb.radius;
    if (orb.x > canvas.width + orb.radius) orb.x = -orb.radius;
    if (orb.y < -orb.radius) orb.y = canvas.height + orb.radius;
    if (orb.y > canvas.height + orb.radius) orb.y = -orb.radius;

    const gradient = ctx.createRadialGradient(orb.x, orb.y, 0, orb.x, orb.y, orb.radius);
    gradient.addColorStop(0, `rgba(${orb.color.r},${orb.color.g},${orb.color.b},${orb.opacity})`);
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.fillRect(orb.x - orb.radius, orb.y - orb.radius, orb.radius * 2, orb.radius * 2);
  }

  // Draw stars
  if (!drawBackground._stars) {
    drawBackground._stars = [];
    for (let i = 0; i < 80; i++) {
      drawBackground._stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 1.5,
        phase: Math.random() * Math.PI * 2,
        speed: 0.5 + Math.random() * 1.5,
      });
    }
  }
  const t = Date.now() / 1000;
  for (const star of drawBackground._stars) {
    const alpha = 0.2 + 0.3 * Math.sin(t * star.speed + star.phase);
    ctx.beginPath();
    ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
    ctx.fill();
  }

  requestAnimationFrame(drawBackground);
}
drawBackground();

// ============================================================
//  GAME DATA
// ============================================================
let currentPlayer = null;
let currentMode = null;
let gameState = {};

const VOCAB = {
  animals: [
    { es: "gato", en: "cat" }, { es: "perro", en: "dog" }, { es: "pajaro", en: "bird" },
    { es: "pez", en: "fish" }, { es: "caballo", en: "horse" }, { es: "mariposa", en: "butterfly" },
    { es: "tortuga", en: "turtle" }, { es: "conejo", en: "rabbit" }, { es: "tigre", en: "tiger" },
    { es: "lobo", en: "wolf" }, { es: "serpiente", en: "snake" }, { es: "oso", en: "bear" },
    { es: "mono", en: "monkey" }, { es: "ballena", en: "whale" }, { es: "aguila", en: "eagle" },
    { es: "delfin", en: "dolphin" }, { es: "leon", en: "lion" }, { es: "elefante", en: "elephant" },
  ],
  colors: [
    { es: "rojo", en: "red" }, { es: "azul", en: "blue" }, { es: "verde", en: "green" },
    { es: "amarillo", en: "yellow" }, { es: "morado", en: "purple" }, { es: "naranja", en: "orange" },
    { es: "blanco", en: "white" }, { es: "negro", en: "black" }, { es: "rosa", en: "pink" },
    { es: "dorado", en: "gold" }, { es: "plateado", en: "silver" }, { es: "gris", en: "gray" },
  ],
  food: [
    { es: "agua", en: "water" }, { es: "comida", en: "food" }, { es: "manzana", en: "apple" },
    { es: "arroz", en: "rice" }, { es: "pollo", en: "chicken" }, { es: "queso", en: "cheese" },
    { es: "pan", en: "bread" }, { es: "leche", en: "milk" }, { es: "helado", en: "ice cream" },
    { es: "fresa", en: "strawberry" }, { es: "platano", en: "banana" }, { es: "chocolate", en: "chocolate" },
    { es: "tacos", en: "tacos" }, { es: "pizza", en: "pizza" }, { es: "galleta", en: "cookie" },
  ],
  family: [
    { es: "familia", en: "family" }, { es: "mama", en: "mom" }, { es: "papa", en: "dad" },
    { es: "hermano", en: "brother" }, { es: "hermana", en: "sister" }, { es: "abuelo", en: "grandpa" },
    { es: "abuela", en: "grandma" }, { es: "amigo", en: "friend" }, { es: "hijo", en: "son" },
    { es: "hija", en: "daughter" }, { es: "primo", en: "cousin" }, { es: "tio", en: "uncle" },
  ],
  greetings: [
    { es: "hola", en: "hello" }, { es: "adios", en: "goodbye" }, { es: "gracias", en: "thank you" },
    { es: "por favor", en: "please" }, { es: "buenos dias", en: "good morning" },
    { es: "buenas noches", en: "good night" }, { es: "como estas", en: "how are you" },
    { es: "muy bien", en: "very good" }, { es: "de nada", en: "you're welcome" },
    { es: "lo siento", en: "I'm sorry" }, { es: "con permiso", en: "excuse me" },
  ],
  gaming: [
    { es: "juego", en: "game" }, { es: "ganar", en: "to win" }, { es: "perder", en: "to lose" },
    { es: "rapido", en: "fast" }, { es: "fuerte", en: "strong" }, { es: "equipo", en: "team" },
    { es: "victoria", en: "victory" }, { es: "estrella", en: "star" }, { es: "poder", en: "power" },
    { es: "nivel", en: "level" }, { es: "mundo", en: "world" }, { es: "batalla", en: "battle" },
    { es: "campeon", en: "champion" }, { es: "escudo", en: "shield" }, { es: "espada", en: "sword" },
  ],
  school: [
    { es: "escuela", en: "school" }, { es: "libro", en: "book" }, { es: "maestro", en: "teacher" },
    { es: "estudiante", en: "student" }, { es: "clase", en: "class" }, { es: "tarea", en: "homework" },
    { es: "examen", en: "exam" }, { es: "lapiz", en: "pencil" }, { es: "papel", en: "paper" },
    { es: "mochila", en: "backpack" }, { es: "matematicas", en: "math" }, { es: "ciencias", en: "science" },
  ],
  everyday: [
    { es: "casa", en: "house" }, { es: "carro", en: "car" }, { es: "grande", en: "big" },
    { es: "bonito", en: "pretty" }, { es: "feliz", en: "happy" }, { es: "triste", en: "sad" },
    { es: "tiempo", en: "time" }, { es: "dinero", en: "money" }, { es: "musica", en: "music" },
    { es: "baile", en: "dance" }, { es: "sol", en: "sun" }, { es: "luna", en: "moon" },
    { es: "lluvia", en: "rain" }, { es: "nieve", en: "snow" }, { es: "fuego", en: "fire" },
    { es: "cielo", en: "sky" }, { es: "tierra", en: "earth" }, { es: "rio", en: "river" },
  ]
};

const SPANGLISH = [
  { text: "that sunset was so bonito no cap", spanish: [{ es: "bonito", en: "pretty/beautiful" }] },
  { text: "my hermano just got a victory royale", spanish: [{ es: "hermano", en: "brother" }] },
  { text: "we need more agua its caliente outside", spanish: [{ es: "agua", en: "water" }, { es: "caliente", en: "hot" }] },
  { text: "this comida from abuela hits different", spanish: [{ es: "comida", en: "food" }, { es: "abuela", en: "grandma" }] },
  { text: "the gato is sleeping on my mochila again", spanish: [{ es: "gato", en: "cat" }, { es: "mochila", en: "backpack" }] },
  { text: "lets go to the playa this verano", spanish: [{ es: "playa", en: "beach" }, { es: "verano", en: "summer" }] },
  { text: "that musica at the fiesta was fire", spanish: [{ es: "musica", en: "music" }, { es: "fiesta", en: "party" }] },
  { text: "mi amigo said the pelicula was amazing", spanish: [{ es: "amigo", en: "friend" }, { es: "pelicula", en: "movie" }] },
  { text: "the estrella in the cielo look so cool tonight", spanish: [{ es: "estrella", en: "star" }, { es: "cielo", en: "sky" }] },
  { text: "the maestro said the examen is on viernes", spanish: [{ es: "maestro", en: "teacher" }, { es: "examen", en: "exam" }, { es: "viernes", en: "Friday" }] },
  { text: "that equipo played with so much corazon", spanish: [{ es: "equipo", en: "team" }, { es: "corazon", en: "heart" }] },
  { text: "my familia went to a restaurante for tacos", spanish: [{ es: "familia", en: "family" }, { es: "restaurante", en: "restaurant" }] },
  { text: "the perro ran rapido through the jardin", spanish: [{ es: "perro", en: "dog" }, { es: "rapido", en: "fast" }, { es: "jardin", en: "garden" }] },
  { text: "i need a nuevo telefono mine is so lento", spanish: [{ es: "nuevo", en: "new" }, { es: "telefono", en: "phone" }, { es: "lento", en: "slow" }] },
  { text: "she wore a vestido color rosa to the baile", spanish: [{ es: "vestido", en: "dress" }, { es: "rosa", en: "pink" }, { es: "baile", en: "dance" }] },
  { text: "the leon at the zoologico was durmiendo", spanish: [{ es: "leon", en: "lion" }, { es: "zoologico", en: "zoo" }, { es: "durmiendo", en: "sleeping" }] },
  { text: "vamos to get helado after escuela today", spanish: [{ es: "vamos", en: "let's go" }, { es: "helado", en: "ice cream" }, { es: "escuela", en: "school" }] },
  { text: "that diamante skin in the juego is so raro", spanish: [{ es: "diamante", en: "diamond" }, { es: "juego", en: "game" }, { es: "raro", en: "rare" }] },
  { text: "the mariposa in the jardin was azul and morado", spanish: [{ es: "mariposa", en: "butterfly" }, { es: "jardin", en: "garden" }, { es: "azul", en: "blue" }, { es: "morado", en: "purple" }] },
  { text: "we built a castillo in minecraft with fuego", spanish: [{ es: "castillo", en: "castle" }, { es: "fuego", en: "fire" }] },
  { text: "bro that was so chistoso i cant stop laughing", spanish: [{ es: "chistoso", en: "funny" }] },
  { text: "my primo got first lugar in the carrera", spanish: [{ es: "primo", en: "cousin" }, { es: "lugar", en: "place" }, { es: "carrera", en: "race" }] },
];

const PHRASES = [
  { text: "yo quiero jugar", en: "I want to play" },
  { text: "el gato es negro", en: "the cat is black" },
  { text: "me gusta la musica", en: "I like music" },
  { text: "donde esta la comida", en: "where is the food" },
  { text: "el sol esta brillando", en: "the sun is shining" },
  { text: "mi casa es grande", en: "my house is big" },
  { text: "el perro corre rapido", en: "the dog runs fast" },
  { text: "quiero agua por favor", en: "I want water please" },
  { text: "la luna es bonita", en: "the moon is pretty" },
  { text: "hoy es un buen dia", en: "today is a good day" },
  { text: "vamos a la playa", en: "let's go to the beach" },
  { text: "el libro es interesante", en: "the book is interesting" },
  { text: "mi hermana es muy feliz", en: "my sister is very happy" },
  { text: "tengo un gato y un perro", en: "I have a cat and a dog" },
  { text: "el cielo es azul hoy", en: "the sky is blue today" },
  { text: "me gusta el helado de fresa", en: "I like strawberry ice cream" },
  { text: "mi amigo es muy fuerte", en: "my friend is very strong" },
  { text: "la mariposa es de muchos colores", en: "the butterfly is many colors" },
  { text: "necesito hacer la tarea", en: "I need to do homework" },
  { text: "estoy aprendiendo espanol", en: "I am learning Spanish" },
];

const BOSS_SENTENCES = [
  { text: "mi familia y yo fuimos al parque y jugamos todo el dia", en: "my family and I went to the park and played all day" },
  { text: "el maestro nos dijo que el examen es muy importante", en: "the teacher told us the exam is very important" },
  { text: "quiero aprender a cocinar como mi abuela porque su comida es la mejor", en: "I want to learn to cook like my grandma because her food is the best" },
  { text: "mi hermano y yo construimos un castillo de arena en la playa", en: "my brother and I built a sandcastle at the beach" },
  { text: "la musica de la fiesta estaba tan buena que todos bailaron", en: "the party music was so good that everyone danced" },
  { text: "los animales del zoologico son muy grandes y bonitos", en: "the animals at the zoo are very big and pretty" },
  { text: "cuando llueve me gusta quedarme en casa y leer un libro", en: "when it rains I like to stay home and read a book" },
  { text: "mi color favorito es el azul como el color del cielo", en: "my favorite color is blue like the color of the sky" },
  { text: "el equipo gano el campeonato y todos estaban muy felices", en: "the team won the championship and everyone was very happy" },
  { text: "vamos a la tienda a comprar frutas y verduras frescas", en: "let's go to the store to buy fresh fruits and vegetables" },
];

const STORIES = [
  {
    title: "The Minecraft Aventura",
    lines: [
      { text: "hola amigos vamos a jugar", en: "hello friends let's play", hint: "The adventure begins..." },
      { text: "we spawned in a bosque oscuro", en: null, hint: "bosque oscuro = dark forest" },
      { text: "necesitamos madera y piedra", en: "we need wood and stone", hint: "Time to gather resources!" },
      { text: "cuidado there is a creeper verde", en: null, hint: "verde = green (classic creeper!)" },
      { text: "construimos una casa grande", en: "we built a big house", hint: "Base building time!" },
      { text: "the noche is coming rapido", en: null, hint: "noche = night, rapido = fast" },
      { text: "tenemos espadas y escudos", en: "we have swords and shields", hint: "Ready for battle!" },
      { text: "victoria the dragon is defeated", en: null, hint: "victoria = victory! GG!" },
    ]
  },
  {
    title: "La Gran Carrera Espacial",
    lines: [
      { text: "tres dos uno despegamos", en: "three two one we blast off", hint: "Liftoff!" },
      { text: "the nave espacial goes so rapido", en: null, hint: "nave espacial = spaceship" },
      { text: "las estrellas son muy brillantes", en: "the stars are very bright", hint: "So beautiful up here..." },
      { text: "we found a planeta nuevo y bonito", en: null, hint: "planeta nuevo = new planet" },
      { text: "hay agua y arboles verdes aqui", en: "there is water and green trees here", hint: "A habitable world!" },
      { text: "the alien said hola amigo welcome", en: null, hint: "Even aliens speak Spanglish!" },
      { text: "compartimos comida y musica", en: "we shared food and music", hint: "Universal language of friendship" },
      { text: "regresamos a la tierra como heroes", en: "we returned to earth as heroes", hint: "What a W!" },
    ]
  },
  {
    title: "El Torneo de Gaming",
    lines: [
      { text: "hoy es el gran dia del torneo", en: "today is the big tournament day", hint: "Game day!" },
      { text: "my equipo is looking muy fuerte", en: null, hint: "equipo = team, fuerte = strong" },
      { text: "practicamos todos los dias", en: "we practiced every day", hint: "That grind paid off!" },
      { text: "the first batalla was so intense", en: null, hint: "batalla = battle" },
      { text: "ganamos tres juegos seguidos", en: "we won three games in a row", hint: "On a streak!" },
      { text: "the final round mi corazon beat so rapido", en: null, hint: "corazon = heart" },
      { text: "somos los campeones del mundo", en: "we are the champions of the world", hint: "CHAMPIONS!" },
      { text: "celebramos con una gran fiesta", en: "we celebrated with a big party", hint: "Time to celebrate!" },
    ]
  }
];

const COMBO_MESSAGES = [
  { min: 5, text: "Nice! üî•", color: "var(--neon-orange)" },
  { min: 10, text: "Sheeeesh! ü•∂", color: "var(--neon-blue)" },
  { min: 15, text: "No Cap! üíØ", color: "var(--neon-yellow)" },
  { min: 20, text: "Sigma Mode! üê∫", color: "var(--neon-purple)" },
  { min: 30, text: "GOATED! üêê", color: "var(--neon-green)" },
  { min: 40, text: "ABSOLUTELY BUSSIN! ü§Ø", color: "var(--neon-pink)" },
  { min: 50, text: "LEGENDARY! üëë", color: "var(--neon-yellow)" },
];

const RESULT_TITLES = [
  { minWpm: 0, title: "Keep Grinding!", sub: "Practice makes perfect, fam", emoji: "üí™", stars: 1 },
  { minWpm: 15, title: "Getting There!", sub: "Your fingers are warming up", emoji: "üå±", stars: 2 },
  { minWpm: 25, title: "Solid Run!", sub: "You're lowkey cracked at this", emoji: "üî•", stars: 3 },
  { minWpm: 35, title: "Sheeeesh!", sub: "Ice cold typing skills fr fr", emoji: "ü•∂", stars: 4 },
  { minWpm: 45, title: "GOATED!", sub: "You just unlocked sigma typing", emoji: "üêê", stars: 5 },
  { minWpm: 60, title: "LEGENDARY!", sub: "Bro you're the final boss of typing", emoji: "üëë", stars: 5 },
];

const MASCOT_FACES = {
  idle: 'üòä', typing: 'üòÑ', streak: 'üòé', bigStreak: 'ü§©', fire: 'üî•',
  wrong: 'üò¨', sad: 'üò¢', perfect: 'ü§Ø', complete: 'ü•≥', thinking: 'ü§î'
};

// ---- KEYBOARD LAYOUT ----
const KB_ROWS = [
  [
    { key: "`", finger: "finger-left-pinky" }, { key: "1", finger: "finger-left-pinky" },
    { key: "2", finger: "finger-left-ring" }, { key: "3", finger: "finger-left-middle" },
    { key: "4", finger: "finger-left-index" }, { key: "5", finger: "finger-left-index" },
    { key: "6", finger: "finger-right-index" }, { key: "7", finger: "finger-right-index" },
    { key: "8", finger: "finger-right-middle" }, { key: "9", finger: "finger-right-ring" },
    { key: "0", finger: "finger-right-pinky" }, { key: "-", finger: "finger-right-pinky" },
    { key: "=", finger: "finger-right-pinky" },
  ],
  [
    { key: "Q", finger: "finger-left-pinky" }, { key: "W", finger: "finger-left-ring" },
    { key: "E", finger: "finger-left-middle" }, { key: "R", finger: "finger-left-index" },
    { key: "T", finger: "finger-left-index" }, { key: "Y", finger: "finger-right-index" },
    { key: "U", finger: "finger-right-index" }, { key: "I", finger: "finger-right-middle" },
    { key: "O", finger: "finger-right-ring" }, { key: "P", finger: "finger-right-pinky" },
  ],
  [
    { key: "A", finger: "finger-left-pinky" }, { key: "S", finger: "finger-left-ring" },
    { key: "D", finger: "finger-left-middle" }, { key: "F", finger: "finger-left-index", home: true },
    { key: "G", finger: "finger-left-index" }, { key: "H", finger: "finger-right-index" },
    { key: "J", finger: "finger-right-index", home: true }, { key: "K", finger: "finger-right-middle" },
    { key: "L", finger: "finger-right-ring" }, { key: ";", finger: "finger-right-pinky" },
  ],
  [
    { key: "Z", finger: "finger-left-pinky" }, { key: "X", finger: "finger-left-ring" },
    { key: "C", finger: "finger-left-middle" }, { key: "V", finger: "finger-left-index" },
    { key: "B", finger: "finger-left-index" }, { key: "N", finger: "finger-right-index" },
    { key: "M", finger: "finger-right-index" }, { key: ",", finger: "finger-right-middle" },
    { key: ".", finger: "finger-right-ring" },
  ],
  [
    { key: "SPACE", finger: "finger-thumb", wide: "space" },
  ]
];

// ============================================================
//  AUDIO
// ============================================================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function ensureAudio() { if (!audioCtx) audioCtx = new AudioCtx(); }

function playTone(freq, duration, type = 'sine', vol = 0.06) {
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.setValueAtTime(vol, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + duration);
}

function sfxCorrect() { playTone(880, 0.06, 'sine', 0.04); }
function sfxWrong() { playTone(200, 0.12, 'sawtooth', 0.03); }
function sfxCombo() { playTone(660, 0.08); setTimeout(() => playTone(880, 0.08), 60); setTimeout(() => playTone(1100, 0.12), 120); }
function sfxLevelUp() { [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => playTone(f, 0.18, 'sine', 0.05), i * 90)); }
function sfxComplete() { [523, 659, 784, 1047, 1319].forEach((f, i) => setTimeout(() => playTone(f, 0.22, 'triangle', 0.05), i * 110)); }
function sfxPerfect() { [784, 988, 1175, 1319, 1568].forEach((f, i) => setTimeout(() => playTone(f, 0.15, 'sine', 0.04), i * 70)); }

// ============================================================
//  UI HELPERS
// ============================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
  const screen = document.getElementById(id);
  screen.style.display = 'flex';
  // Trigger reflow before adding active class for animation
  void screen.offsetWidth;
  screen.classList.add('active');
}

function selectPlayer(el) {
  document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  currentPlayer = el.dataset.player;
  document.getElementById('btn-start').disabled = false;
}

function showModeSelect() {
  const greetings = [
    `What's good ${currentPlayer}? Pick your challenge!`,
    `${currentPlayer} is in the building! Choose wisely:`,
    `Alright ${currentPlayer}, time to level up!`,
    `${currentPlayer} said bet, let's go!`,
  ];
  document.getElementById('mode-greeting').textContent = greetings[Math.floor(Math.random() * greetings.length)];
  showScreen('screen-modes');
}

// Build keyboard
function buildKeyboard() {
  const kb = document.getElementById('keyboard');
  kb.innerHTML = '';
  KB_ROWS.forEach(row => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'kb-row';
    row.forEach(k => {
      const keyDiv = document.createElement('div');
      keyDiv.className = `kb-key ${k.finger}${k.wide ? ' ' + k.wide : ''}${k.home ? ' home-row' : ''}`;
      keyDiv.textContent = k.key === 'SPACE' ? 'SPACE' : k.key;
      keyDiv.dataset.key = k.key;
      rowDiv.appendChild(keyDiv);
    });
    kb.appendChild(rowDiv);
  });
}
buildKeyboard();

function highlightKey(char, correct) {
  const keyStr = char === ' ' ? 'SPACE' : char.toUpperCase();
  const keyEl = document.querySelector(`.kb-key[data-key="${keyStr}"]`);
  if (!keyEl) return;
  keyEl.classList.add(correct ? 'pressed-correct' : 'pressed-wrong');
  setTimeout(() => keyEl.classList.remove('pressed-correct', 'pressed-wrong'), 180);
}

function showNextKey(char) {
  document.querySelectorAll('.kb-key').forEach(k => k.classList.remove('active'));
  const keyStr = char === ' ' ? 'SPACE' : char.toUpperCase();
  const keyEl = document.querySelector(`.kb-key[data-key="${keyStr}"]`);
  if (keyEl) keyEl.classList.add('active');
}

// Mascot
function setMascot(face, extraClass) {
  const box = document.getElementById('mascot-box');
  box.textContent = MASCOT_FACES[face] || MASCOT_FACES.idle;
  box.className = 'mascot-box';
  if (extraClass) box.classList.add(extraClass);
}

// Particles
function spawnParticles(x, y, color, count = 8) {
  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const angle = (Math.PI * 2 / count) * i + Math.random() * 0.5;
    const dist = 30 + Math.random() * 50;
    const size = 3 + Math.random() * 5;
    p.style.cssText = `left:${x}px;top:${y}px;width:${size}px;height:${size}px;background:${color};--dx:${Math.cos(angle)*dist}px;--dy:${Math.sin(angle)*dist}px;`;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 800);
  }
}

// Confetti (enhanced with sway)
function launchConfetti() {
  const colors = ['#ff2d95','#00d4ff','#39ff14','#b026ff','#fff700','#ff6e00'];
  const shapes = ['50%', '3px', '0'];
  for (let i = 0; i < 80; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    const w = 5 + Math.random() * 10;
    const h = 5 + Math.random() * 10;
    c.style.cssText = `
      left:${Math.random()*100}%;top:-20px;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      width:${w}px;height:${h}px;
      border-radius:${shapes[Math.floor(Math.random()*shapes.length)]};
      --dur:${2.5+Math.random()*3}s;
      --sway:${(Math.random()-0.5)*80}px;
      animation-delay:${Math.random()*2}s;
      animation-duration:var(--dur);
    `;
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 6000);
  }
}

// Combo popup
function showCombo(text, color) {
  const popup = document.getElementById('combo-popup');
  popup.textContent = text;
  popup.style.color = color;
  popup.classList.remove('show');
  void popup.offsetWidth;
  popup.classList.add('show');
  sfxCombo();
}

// Float points
function showFloatPoints(points, x, y) {
  const el = document.createElement('div');
  el.className = 'float-points';
  el.textContent = `+${points}`;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1200);
}

// Perfect prompt flash
function showPerfect() {
  const el = document.createElement('div');
  el.className = 'perfect-flash';
  el.textContent = 'PERFECT! ‚ú®';
  document.body.appendChild(el);
  sfxPerfect();
  setTimeout(() => el.remove(), 1000);
}

// Screen shake
function screenShake() {
  const area = document.getElementById('typing-area');
  area.classList.remove('shake');
  void area.offsetWidth;
  area.classList.add('shake');
}

// Level up overlay
function showLevelUp(level) {
  const emojis = ['üéØ','‚ö°','üî•','üíé','üåü','üëë','üèÜ','üêê'];
  document.getElementById('lu-emoji').textContent = emojis[Math.min(level-1, emojis.length-1)];
  document.getElementById('lu-text').textContent = `LEVEL ${level}!`;
  const subs = [
    "You're just getting started!",
    "Warming up fr fr!",
    "Okay okay I see you!",
    "Straight bussin!",
    "No cap you're cracked!",
    "Built different!",
    "Main character energy!",
    "GOAT status unlocked!",
  ];
  document.getElementById('lu-sub').textContent = subs[Math.min(level-1, subs.length-1)];
  document.getElementById('level-up-overlay').classList.add('show');
  sfxLevelUp();
  launchConfetti();
  setTimeout(() => document.getElementById('level-up-overlay').classList.remove('show'), 2000);
}

// Progress dots
function updateProgressDots() {
  const container = document.getElementById('progress-dots');
  container.innerHTML = '';
  const total = gameState.prompts.length;
  // Cap visible dots
  const maxDots = Math.min(total, 30);
  for (let i = 0; i < maxDots; i++) {
    const dot = document.createElement('div');
    dot.className = 'progress-dot';
    if (i < gameState.currentIndex) dot.classList.add('done');
    else if (i === gameState.currentIndex) dot.classList.add('current');
    else dot.classList.add('upcoming');
    container.appendChild(dot);
  }
}

// ============================================================
//  GAME ENGINE
// ============================================================
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function getAllVocab() {
  return Object.entries(VOCAB).flatMap(([cat, words]) => words.map(w => ({ ...w, category: cat })));
}

function generatePrompts(mode) {
  switch(mode) {
    case 'vocab': {
      const all = shuffle(getAllVocab()).slice(0, 15);
      return all.map(w => ({
        text: w.es, hintSpanish: w.es, hintEnglish: w.en,
        hintCategory: w.category, spanishWords: [{ es: w.es, en: w.en }],
      }));
    }
    case 'phrases': {
      const all = shuffle(PHRASES).slice(0, 12);
      return all.map(p => ({
        text: p.text, hintSpanish: p.text, hintEnglish: p.en,
        hintCategory: 'Spanish phrase', spanishWords: p.text.split(' ').map(w => ({ es: w, en: '' })),
      }));
    }
    case 'spanglish': {
      const all = shuffle(SPANGLISH).slice(0, 12);
      return all.map(s => ({
        text: s.text, hintSpanish: s.spanish.map(w => w.es).join(', '),
        hintEnglish: s.spanish.map(w => `${w.es} = ${w.en}`).join(' | '),
        hintCategory: 'Spanglish remix', spanishWords: s.spanish,
      }));
    }
    case 'boss': {
      const all = shuffle(BOSS_SENTENCES).slice(0, 8);
      return all.map(s => ({
        text: s.text, hintSpanish: s.text.slice(0, 40) + '...',
        hintEnglish: s.en, hintCategory: 'Boss level - full Spanish!', spanishWords: [],
      }));
    }
    case 'race': {
      const vocabItems = shuffle(getAllVocab()).slice(0, 20).map(w => ({
        text: w.es, hintSpanish: w.es, hintEnglish: w.en,
        hintCategory: w.category, spanishWords: [{ es: w.es, en: w.en }],
      }));
      const phraseItems = shuffle(SPANGLISH).slice(0, 10).map(s => ({
        text: s.text, hintSpanish: s.spanish.map(w => w.es).join(', '),
        hintEnglish: s.spanish.map(w => `${w.es} = ${w.en}`).join(' | '),
        hintCategory: 'Spanglish remix', spanishWords: s.spanish,
      }));
      return shuffle([...vocabItems, ...phraseItems]);
    }
    case 'story': {
      const story = STORIES[Math.floor(Math.random() * STORIES.length)];
      return story.lines.map(line => ({
        text: line.text, hintSpanish: story.title,
        hintEnglish: line.en || line.hint, hintCategory: line.hint || 'Story mode', spanishWords: [],
      }));
    }
  }
}

function startGame(mode) {
  currentMode = mode;
  const prompts = generatePrompts(mode);

  gameState = {
    mode, prompts, currentIndex: 0, charIndex: 0,
    score: 0, streak: 0, bestStreak: 0,
    totalCorrect: 0, totalTyped: 0,
    promptCorrect: 0, promptTyped: 0,
    level: 1, xp: 0, xpNeeded: 50,
    startTime: null, wordsCompleted: 0,
    allSpanishWords: [], timerInterval: null,
    timeLeft: 60, raceActive: mode === 'race',
    charResults: {},
  };

  showScreen('screen-game');
  setMascot('idle');
  updateHUD();
  updateProgressDots();

  document.getElementById('hud-timer-box').style.display = mode === 'race' ? 'block' : 'none';
  document.getElementById('click-hint').style.display = 'block';

  // Reset typing area glow
  const area = document.getElementById('typing-area');
  area.className = 'typing-area';

  loadPrompt();

  const input = document.getElementById('hidden-input');
  input.value = '';
  input.focus();
  document.getElementById('typing-area').onclick = () => { input.focus(); document.getElementById('click-hint').style.display = 'none'; };
}

function loadPrompt() {
  const prompt = gameState.prompts[gameState.currentIndex];
  if (!prompt) { endGame(); return; }

  gameState.charIndex = 0;
  gameState.promptCorrect = 0;
  gameState.promptTyped = 0;
  gameState.charResults = {};

  document.getElementById('hint-spanish').textContent = prompt.hintSpanish;
  document.getElementById('hint-english').textContent = prompt.hintEnglish;
  document.getElementById('hint-category').textContent = prompt.hintCategory;

  if (prompt.spanishWords) {
    prompt.spanishWords.forEach(w => {
      if (w.es && !gameState.allSpanishWords.find(x => x.es === w.es)) {
        gameState.allSpanishWords.push(w);
      }
    });
  }

  renderChars();
  updateProgressDots();

  if (prompt.text.length > 0) showNextKey(prompt.text[0]);
}

function renderChars() {
  const prompt = gameState.prompts[gameState.currentIndex];
  const container = document.getElementById('prompt-text');
  container.innerHTML = '';

  for (let i = 0; i < prompt.text.length; i++) {
    const span = document.createElement('span');
    span.className = 'char';
    if (prompt.text[i] === ' ') span.classList.add('space-char');
    span.textContent = prompt.text[i] === ' ' ? '\u00A0' : prompt.text[i];

    if (i < gameState.charIndex) {
      span.classList.add(gameState.charResults[i] ? 'correct' : 'incorrect');
    } else if (i === gameState.charIndex) {
      span.classList.add('current');
    } else {
      span.classList.add('upcoming');
    }
    container.appendChild(span);
  }
}

function updateHUD() {
  const scoreEl = document.getElementById('hud-score');
  const oldScore = scoreEl.textContent;
  scoreEl.textContent = gameState.score;
  if (scoreEl.textContent !== oldScore) {
    scoreEl.classList.remove('score-pop');
    void scoreEl.offsetWidth;
    scoreEl.classList.add('score-pop');
  }

  document.getElementById('hud-streak').textContent = gameState.streak > 0 ? `${gameState.streak} üî•` : '0';
  document.getElementById('hud-level').textContent = gameState.level;

  let wpm = 0;
  if (gameState.startTime) {
    const elapsed = (Date.now() - gameState.startTime) / 1000 / 60;
    if (elapsed > 0) wpm = Math.round(gameState.wordsCompleted / elapsed);
  }
  document.getElementById('hud-wpm').textContent = wpm;

  document.getElementById('xp-bar').style.width =
    Math.min(100, (gameState.xp / gameState.xpNeeded) * 100) + '%';

  if (gameState.raceActive) {
    document.getElementById('hud-timer').textContent = gameState.timeLeft;
  }

  // Typing area glow based on streak
  const area = document.getElementById('typing-area');
  area.classList.remove('streak-glow', 'big-streak-glow');
  if (gameState.streak >= 20) area.classList.add('big-streak-glow');
  else if (gameState.streak >= 10) area.classList.add('streak-glow');

  // Mascot reaction
  if (gameState.streak >= 20) setMascot('fire', 'fire');
  else if (gameState.streak >= 10) setMascot('bigStreak', 'happy');
  else if (gameState.streak >= 5) setMascot('streak', 'happy');
  else if (gameState.streak > 0) setMascot('typing', 'happy');
}

function addXP(amount) {
  gameState.xp += amount;
  while (gameState.xp >= gameState.xpNeeded) {
    gameState.xp -= gameState.xpNeeded;
    gameState.level++;
    gameState.xpNeeded = Math.floor(gameState.xpNeeded * 1.4);
    showLevelUp(gameState.level);
  }
}

// ---- INPUT HANDLING ----
document.getElementById('hidden-input').addEventListener('input', function(e) {
  document.getElementById('click-hint').style.display = 'none';

  if (!gameState.startTime) {
    gameState.startTime = Date.now();
    if (gameState.raceActive) startRaceTimer();
  }

  const typed = e.data;
  if (!typed) return;

  const prompt = gameState.prompts[gameState.currentIndex];
  if (!prompt) return;

  const expected = prompt.text[gameState.charIndex];
  if (expected === undefined) return;

  gameState.totalTyped++;
  gameState.promptTyped++;

  if (typed === expected) {
    gameState.charResults[gameState.charIndex] = true;
    gameState.totalCorrect++;
    gameState.promptCorrect++;
    gameState.streak++;
    if (gameState.streak > gameState.bestStreak) gameState.bestStreak = gameState.streak;

    let points = 10;
    const multiplier = Math.min(5, 1 + Math.floor(gameState.streak / 5));
    points *= multiplier;
    gameState.score += points;
    addXP(points / 2);

    sfxCorrect();
    highlightKey(expected, true);

    if (gameState.streak % 5 === 0 && gameState.streak > 0) {
      const rect = document.getElementById('typing-area').getBoundingClientRect();
      showFloatPoints(points, rect.left + Math.random() * rect.width * 0.8 + rect.width * 0.1, rect.top);
    }

    for (let i = COMBO_MESSAGES.length - 1; i >= 0; i--) {
      if (gameState.streak === COMBO_MESSAGES[i].min) {
        showCombo(COMBO_MESSAGES[i].text, COMBO_MESSAGES[i].color);
        break;
      }
    }

    if (gameState.streak > 0 && gameState.streak % 10 === 0) {
      const rect = document.getElementById('hud-streak').getBoundingClientRect();
      spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, 'var(--neon-orange)', 12);
    }

    gameState.charIndex++;

    if (gameState.charIndex >= prompt.text.length) {
      completePrompt();
    } else {
      renderChars();
      showNextKey(prompt.text[gameState.charIndex]);
    }

  } else {
    gameState.charResults[gameState.charIndex] = false;
    gameState.streak = 0;
    sfxWrong();
    highlightKey(expected, false);
    screenShake();
    setMascot('wrong', 'sad');
    setTimeout(() => { if (gameState.streak === 0) setMascot('idle'); }, 600);

    gameState.charIndex++;
    if (gameState.charIndex >= prompt.text.length) {
      completePrompt();
    } else {
      renderChars();
      showNextKey(prompt.text[gameState.charIndex]);
    }
  }

  updateHUD();
  this.value = '';
});

document.getElementById('hidden-input').addEventListener('keydown', function(e) {
  if (e.key === 'Backspace') {
    e.preventDefault();
    if (gameState.charIndex > 0) {
      gameState.charIndex--;
      delete gameState.charResults[gameState.charIndex];
      renderChars();
      const prompt = gameState.prompts[gameState.currentIndex];
      showNextKey(prompt.text[gameState.charIndex]);
    }
  }
  if (e.key === 'Tab') e.preventDefault();
  if (e.key === 'Escape') {
    if (confirm('Quit this round?')) {
      if (gameState.timerInterval) clearInterval(gameState.timerInterval);
      showModeSelect();
    }
  }
});

function completePrompt() {
  const prompt = gameState.prompts[gameState.currentIndex];
  const words = prompt.text.split(' ').length;
  gameState.wordsCompleted += words;

  // Check for perfect prompt
  const isPerfect = gameState.promptCorrect === gameState.promptTyped && gameState.promptTyped > 0;
  if (isPerfect && prompt.text.length > 3) {
    gameState.score += 50;
    addXP(30);
    showPerfect();
    setMascot('perfect');
  } else {
    setMascot('complete');
  }

  setTimeout(() => { if (gameState.streak >= 5) setMascot('streak', 'happy'); else setMascot('idle'); }, 800);

  gameState.currentIndex++;

  if (gameState.currentIndex >= gameState.prompts.length && !gameState.raceActive) {
    endGame();
  } else if (gameState.raceActive && gameState.currentIndex >= gameState.prompts.length) {
    gameState.prompts = [...gameState.prompts, ...generatePrompts(currentMode)];
    loadPrompt();
  } else {
    loadPrompt();
  }
}

function startRaceTimer() {
  gameState.timerInterval = setInterval(() => {
    gameState.timeLeft--;
    const timerEl = document.getElementById('hud-timer');
    timerEl.textContent = gameState.timeLeft;
    if (gameState.timeLeft <= 10) {
      timerEl.style.color = gameState.timeLeft % 2 === 0 ? 'var(--neon-pink)' : '#fff';
      timerEl.style.transform = gameState.timeLeft % 2 === 0 ? 'scale(1.2)' : 'scale(1)';
    }
    if (gameState.timeLeft <= 0) {
      clearInterval(gameState.timerInterval);
      endGame();
    }
  }, 1000);
}

function endGame() {
  if (gameState.timerInterval) clearInterval(gameState.timerInterval);

  sfxComplete();
  setTimeout(() => launchConfetti(), 300);

  const elapsed = gameState.startTime ? (Date.now() - gameState.startTime) / 1000 / 60 : 1;
  const wpm = elapsed > 0 ? Math.round(gameState.wordsCompleted / elapsed) : 0;
  const accuracy = gameState.totalTyped > 0 ? Math.round((gameState.totalCorrect / gameState.totalTyped) * 100) : 0;

  let resultInfo = RESULT_TITLES[0];
  for (const r of RESULT_TITLES) {
    if (wpm >= r.minWpm) resultInfo = r;
  }

  // Rank emoji
  document.getElementById('results-rank').textContent = resultInfo.emoji;
  document.getElementById('results-title').textContent = resultInfo.title;
  document.getElementById('results-subtitle').textContent = `${resultInfo.sub} ‚Äî ${currentPlayer}`;

  // Stars
  const starContainer = document.getElementById('star-rating');
  starContainer.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const star = document.createElement('span');
    star.className = `star ${i < resultInfo.stars ? 'filled' : 'empty'}`;
    star.textContent = i < resultInfo.stars ? '‚≠ê' : '‚òÜ';
    star.style.animationDelay = `${i * 0.15}s`;
    starContainer.appendChild(star);
  }

  // Animated stat counters
  animateCounter('res-score', gameState.score, 1000);
  animateCounter('res-wpm', wpm, 800);
  document.getElementById('res-accuracy').textContent = accuracy + '%';
  animateCounter('res-streak', gameState.bestStreak, 600);

  // Achievements
  const achieveContainer = document.getElementById('achievements');
  achieveContainer.innerHTML = '';
  const achievements = [];
  if (accuracy >= 100) achievements.push({ icon: 'üéØ', text: 'Perfect Accuracy!' });
  if (accuracy >= 90) achievements.push({ icon: 'üíé', text: '90%+ Accuracy' });
  if (gameState.bestStreak >= 20) achievements.push({ icon: 'üî•', text: 'Hot Streak (20+)' });
  if (gameState.bestStreak >= 10) achievements.push({ icon: '‚ö°', text: 'On Fire (10+ streak)' });
  if (wpm >= 40) achievements.push({ icon: 'üèéÔ∏è', text: 'Speed Demon' });
  if (wpm >= 25) achievements.push({ icon: 'üí®', text: 'Quick Fingers' });
  if (gameState.allSpanishWords.length >= 10) achievements.push({ icon: 'üá™üá∏', text: '10+ Spanish Words' });
  if (gameState.score >= 1000) achievements.push({ icon: 'üèÜ', text: '1000+ Points' });

  achievements.forEach((a, i) => {
    const el = document.createElement('div');
    el.className = 'achievement';
    el.textContent = `${a.icon} ${a.text}`;
    el.style.animationDelay = `${0.3 + i * 0.15}s`;
    achieveContainer.appendChild(el);
  });

  // Spanish words
  const wordsDiv = document.getElementById('words-learned');
  wordsDiv.innerHTML = '';
  const uniqueWords = gameState.allSpanishWords.slice(0, 20);
  if (uniqueWords.length > 0) {
    uniqueWords.forEach(w => {
      const chip = document.createElement('div');
      chip.className = 'word-chip';
      chip.innerHTML = `${w.es} <span>= ${w.en}</span>`;
      wordsDiv.appendChild(chip);
    });
    document.getElementById('spanish-learned').style.display = 'block';
  } else {
    document.getElementById('spanish-learned').style.display = 'none';
  }

  showScreen('screen-results');
  setTimeout(() => launchConfetti(), 1500);
}

// Animated counter
function animateCounter(elementId, target, duration) {
  const el = document.getElementById(elementId);
  const start = 0;
  const startTime = performance.now();

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    // Ease out cubic
    const eased = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.round(start + (target - start) * eased);
    if (progress < 1) requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
}

// Keep input focused
document.addEventListener('keydown', function(e) {
  const gameScreen = document.getElementById('screen-game');
  if (gameScreen.classList.contains('active')) {
    const input = document.getElementById('hidden-input');
    if (document.activeElement !== input) input.focus();
  }
});
</script>
</body>
</html>