<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Typing Fiesta! - Learn to Type en Espanol</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --neon-pink: #ff2d95;
    --neon-blue: #00d4ff;
    --neon-green: #39ff14;
    --neon-purple: #b026ff;
    --neon-yellow: #fff700;
    --neon-orange: #ff6e00;
    --dark-bg: #0a0a2e;
    --darker-bg: #060618;
    --card-bg: rgba(255,255,255,0.04);
    --glass-bg: rgba(255,255,255,0.06);
    --glass-border: rgba(255,255,255,0.1);
  }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--darker-bg);
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
    cursor: default;
  }

  /* === CANVAS BACKGROUND === */
  #bg-canvas {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0; pointer-events: none;
  }

  /* === SCREEN TRANSITIONS === */
  .screen {
    display: none; position: relative; z-index: 1;
    min-height: 100vh;
    flex-direction: column; align-items: center; justify-content: center;
    padding: 2rem;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .screen.active {
    display: flex;
    animation: screenFadeIn 0.6s ease forwards;
  }
  @keyframes screenFadeIn {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  /* === GLASSMORPHISM MIXIN === */
  .glass {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.08);
  }

  /* === TITLE SCREEN === */
  .title-container { text-align: center; }

  .title-logo {
    font-family: 'Fredoka One', cursive;
    font-size: clamp(3rem, 9vw, 7rem);
    background: linear-gradient(135deg, var(--neon-pink), var(--neon-yellow), var(--neon-green), var(--neon-blue), var(--neon-purple));
    background-size: 400% 400%;
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientShift 4s ease infinite;
    filter: drop-shadow(0 0 40px rgba(255,45,149,0.3)) drop-shadow(0 0 80px rgba(176,38,255,0.2));
    line-height: 1.1;
    letter-spacing: -2px;
  }
  @keyframes gradientShift {
    0%,100% { background-position: 0% 50%; }
    25% { background-position: 100% 0%; }
    50% { background-position: 100% 100%; }
    75% { background-position: 0% 100%; }
  }

  .title-sub-row {
    display: flex; align-items: center; justify-content: center;
    gap: 0.8rem; margin: 0.8rem 0 0.5rem;
    flex-wrap: wrap;
  }
  .title-flag {
    font-size: 1.8rem;
    animation: flagWave 2s ease-in-out infinite;
  }
  @keyframes flagWave {
    0%,100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
  }

  .subtitle {
    font-size: 1.1rem; color: rgba(255,255,255,0.5);
    margin: 0 0 2.5rem; text-align: center;
    font-weight: 600;
  }

  .title-mascot {
    font-size: 5rem;
    animation: mascotBounce 2s ease-in-out infinite;
    margin-bottom: 1rem;
    filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
  }
  @keyframes mascotBounce {
    0%,100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-15px) scale(1.05); }
  }

  .player-select {
    display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center;
    margin-bottom: 2rem;
  }

  .player-card {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(16px);
    border: 2px solid rgba(255,255,255,0.08);
    border-radius: 24px;
    padding: 2rem 3rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-align: center;
    min-width: 200px;
    position: relative;
    overflow: hidden;
  }
  .player-card::before {
    content: '';
    position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 26px;
    background: linear-gradient(135deg, transparent, transparent);
    z-index: -1;
    transition: all 0.4s;
  }
  .player-card:hover {
    transform: translateY(-8px) scale(1.03);
    border-color: transparent;
    box-shadow: 0 20px 60px rgba(0,212,255,0.15), 0 0 0 1px rgba(0,212,255,0.3);
  }
  .player-card:hover::before {
    background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
  }
  .player-card.selected {
    border-color: transparent;
    box-shadow: 0 20px 60px rgba(57,255,20,0.15), 0 0 0 2px rgba(57,255,20,0.5);
  }
  .player-card.selected::before {
    background: linear-gradient(135deg, var(--neon-green), var(--neon-blue));
  }
  .player-card .avatar {
    font-size: 4rem; margin-bottom: 0.5rem;
    transition: transform 0.3s;
  }
  .player-card:hover .avatar { transform: scale(1.15) rotate(5deg); }
  .player-card .name {
    font-family: 'Fredoka One', cursive;
    font-size: 1.5rem;
  }
  .player-card .player-tag {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.3);
    margin-top: 0.3rem;
  }

  /* === BUTTONS === */
  .btn {
    font-family: 'Fredoka One', cursive;
    font-size: 1.3rem;
    padding: 1rem 3rem;
    border: none; border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-transform: uppercase;
    letter-spacing: 2px;
    position: relative;
    overflow: hidden;
  }
  .btn::after {
    content: '';
    position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    transition: left 0.5s;
  }
  .btn:hover::after { left: 100%; }
  .btn-play {
    background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple), var(--neon-blue));
    background-size: 200% 200%;
    animation: btnGlow 3s ease infinite;
    color: #fff;
    box-shadow: 0 8px 30px rgba(176,38,255,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  }
  @keyframes btnGlow {
    0%,100% { background-position: 0% 50%; box-shadow: 0 8px 30px rgba(176,38,255,0.3); }
    50% { background-position: 100% 50%; box-shadow: 0 8px 40px rgba(255,45,149,0.4); }
  }
  .btn-play:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 50px rgba(176,38,255,0.5);
  }
  .btn-play:active { transform: translateY(0) scale(0.98); }
  .btn-play:disabled {
    opacity: 0.3; cursor: not-allowed; transform: none;
    animation: none;
    box-shadow: none;
  }
  .btn-secondary {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(10px);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.12);
  }
  .btn-secondary:hover {
    background: rgba(255,255,255,0.12);
    border-color: var(--neon-blue);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,212,255,0.15);
  }

  /* === MODE SELECT SCREEN === */
  .mode-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.2rem; max-width: 880px; width: 100%; margin: 1.5rem 0;
  }
  .mode-card {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 20px;
    padding: 1.8rem 1.5rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .mode-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--neon-yellow), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }
  .mode-card:hover::before { opacity: 1; }
  .mode-card:hover {
    transform: translateY(-6px) scale(1.02);
    border-color: rgba(255,247,0,0.2);
    box-shadow: 0 20px 60px rgba(255,247,0,0.08), 0 0 0 1px rgba(255,247,0,0.1);
  }
  .mode-card .mode-icon {
    font-size: 3rem; margin-bottom: 0.8rem;
    display: inline-block;
    transition: transform 0.3s;
  }
  .mode-card:hover .mode-icon { transform: scale(1.2) rotate(-5deg); }
  .mode-card .mode-title {
    font-family: 'Fredoka One', cursive;
    font-size: 1.15rem; margin-bottom: 0.4rem;
  }
  .mode-card .mode-desc {
    font-size: 0.82rem; color: rgba(255,255,255,0.4);
    line-height: 1.4;
    margin-bottom: 0.6rem;
  }

  /* === DIFFICULTY BADGES === */
  .diff-badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 20px;
    font-size: 0.65rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }
  .diff-badge.easy { background: rgba(57,255,20,0.12); color: var(--neon-green); border: 1px solid rgba(57,255,20,0.2); }
  .diff-badge.medium { background: rgba(255,247,0,0.12); color: var(--neon-yellow); border: 1px solid rgba(255,247,0,0.2); }
  .diff-badge.hard { background: rgba(255,110,0,0.12); color: var(--neon-orange); border: 1px solid rgba(255,110,0,0.2); }
  .diff-badge.boss { background: rgba(255,45,149,0.12); color: var(--neon-pink); border: 1px solid rgba(255,45,149,0.2); }

  /* === GAME SCREEN === */
  .game-top-row {
    display: flex; align-items: center; gap: 1rem;
    width: 100%; max-width: 900px;
    margin-bottom: 1rem;
  }

  .mascot-box {
    flex-shrink: 0;
    width: 64px; height: 64px;
    display: flex; align-items: center; justify-content: center;
    font-size: 2.8rem;
    border-radius: 16px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    transition: all 0.3s;
  }
  .mascot-box.happy { border-color: rgba(57,255,20,0.3); box-shadow: 0 0 20px rgba(57,255,20,0.1); }
  .mascot-box.sad { border-color: rgba(255,45,149,0.3); box-shadow: 0 0 20px rgba(255,45,149,0.1); }
  .mascot-box.fire { border-color: rgba(255,110,0,0.3); box-shadow: 0 0 20px rgba(255,110,0,0.15); animation: mascotFire 0.5s ease infinite alternate; }
  @keyframes mascotFire { 0% { transform: scale(1); } 100% { transform: scale(1.08); } }

  .game-hud {
    display: flex; justify-content: space-around; align-items: center;
    flex: 1;
    padding: 0.8rem 1.2rem;
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px;
    flex-wrap: wrap; gap: 0.4rem;
  }
  .hud-item { text-align: center; min-width: 60px; }
  .hud-label {
    font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1.5px;
    color: rgba(255,255,255,0.3);
    font-weight: 700;
  }
  .hud-value {
    font-family: 'Fredoka One', cursive;
    font-size: 1.4rem;
    transition: all 0.3s;
  }
  .hud-value.score { color: var(--neon-yellow); }
  .hud-value.streak { color: var(--neon-orange); }
  .hud-value.wpm { color: var(--neon-green); }
  .hud-value.level { color: var(--neon-blue); }
  .hud-value.timer { color: var(--neon-pink); }
  .hud-value.score-pop { animation: scorePop 0.3s ease; }
  @keyframes scorePop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }

  /* XP bar */
  .xp-bar-container {
    width: 100%; max-width: 900px;
    height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    margin-bottom: 1rem;
    overflow: hidden;
    position: relative;
  }
  .xp-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--neon-green), var(--neon-blue), var(--neon-purple), var(--neon-pink));
    background-size: 300% 100%;
    animation: xpShimmer 3s linear infinite;
    border-radius: 3px;
    transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    width: 0%;
    box-shadow: 0 0 12px rgba(57,255,20,0.3);
  }
  @keyframes xpShimmer {
    0% { background-position: 0% 50%; }
    100% { background-position: 300% 50%; }
  }

  /* Spanish hint box */
  .spanish-hint {
    background: linear-gradient(135deg, rgba(200,169,97,0.08), rgba(255,247,0,0.04));
    border: 1px solid rgba(255,247,0,0.12);
    border-radius: 16px;
    padding: 1rem 2rem;
    margin-bottom: 1rem;
    text-align: center;
    max-width: 900px; width: 100%;
    position: relative;
    overflow: hidden;
  }
  .spanish-hint::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,247,0,0.4), transparent);
  }
  .hint-spanish {
    font-family: 'Fredoka One', cursive;
    font-size: 1.6rem;
    color: var(--neon-yellow);
    text-shadow: 0 0 30px rgba(255,247,0,0.2);
  }
  .hint-english {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.4);
    margin-top: 0.2rem;
  }
  .hint-category {
    display: inline-block;
    font-size: 0.65rem;
    background: rgba(255,255,255,0.06);
    padding: 3px 12px;
    border-radius: 12px;
    margin-top: 0.4rem;
    color: rgba(255,255,255,0.3);
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  /* Typing area */
  .typing-area {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 24px;
    padding: 2rem 2.5rem;
    max-width: 900px; width: 100%;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .typing-area.streak-glow {
    border-color: rgba(255,110,0,0.3);
    box-shadow: 0 0 40px rgba(255,110,0,0.08), inset 0 0 40px rgba(255,110,0,0.03);
  }
  .typing-area.big-streak-glow {
    border-color: rgba(57,255,20,0.3);
    box-shadow: 0 0 60px rgba(57,255,20,0.1), inset 0 0 60px rgba(57,255,20,0.03);
  }
  .typing-area::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
  }
  .typing-area.shake {
    animation: shake 0.4s ease;
  }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
  }

  .click-hint {
    position: absolute; bottom: 0.5rem; right: 1rem;
    font-size: 0.7rem; color: rgba(255,255,255,0.2);
    animation: pulse 2s ease infinite;
  }
  @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 0.7; } }

  .prompt-text {
    font-size: 1.6rem;
    line-height: 2.2;
    letter-spacing: 2px;
    font-family: 'Nunito', monospace;
    font-weight: 700;
    word-wrap: break-word;
    min-height: 60px;
  }
  .prompt-text .char {
    position: relative;
    display: inline-block;
    transition: all 0.15s ease;
    padding: 0 1px;
  }
  .prompt-text .char.correct {
    color: var(--neon-green);
    text-shadow: 0 0 8px rgba(57,255,20,0.3);
  }
  .prompt-text .char.incorrect {
    color: var(--neon-pink);
    background: rgba(255,45,149,0.15);
    border-radius: 3px;
    text-shadow: 0 0 8px rgba(255,45,149,0.3);
  }
  .prompt-text .char.current {
    color: #fff;
    background: rgba(0,212,255,0.25);
    border-radius: 4px;
    box-shadow: 0 0 15px rgba(0,212,255,0.2);
    animation: cursorPulse 1.2s ease-in-out infinite;
  }
  .prompt-text .char.upcoming { color: rgba(255,255,255,0.2); }
  @keyframes cursorPulse {
    0%,100% { background: rgba(0,212,255,0.25); box-shadow: 0 0 15px rgba(0,212,255,0.2); }
    50% { background: rgba(0,212,255,0.15); box-shadow: 0 0 8px rgba(0,212,255,0.1); }
  }

  .prompt-text .char.space-char.current::after {
    content: '¬∑';
    color: rgba(0,212,255,0.4);
  }

  /* Hidden input */
  .hidden-input {
    position: absolute; opacity: 0; pointer-events: none;
  }

  /* Combo popup */
  .combo-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-family: 'Fredoka One', cursive;
    font-size: 3.5rem;
    pointer-events: none;
    z-index: 100;
    text-shadow: 0 0 40px currentColor, 0 0 80px currentColor;
    animation: none;
  }
  .combo-popup.show {
    animation: comboAnim 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }
  @keyframes comboAnim {
    0% { transform: translate(-50%, -50%) scale(0) rotate(-15deg); opacity: 1; }
    25% { transform: translate(-50%, -50%) scale(1.4) rotate(5deg); opacity: 1; }
    50% { transform: translate(-50%, -55%) scale(1.1) rotate(-2deg); opacity: 1; }
    100% { transform: translate(-50%, -90%) scale(0.7); opacity: 0; }
  }

  /* Floating +points */
  .float-points {
    position: fixed;
    font-family: 'Fredoka One', cursive;
    font-size: 1.5rem;
    color: var(--neon-yellow);
    pointer-events: none;
    z-index: 99;
    text-shadow: 0 0 15px rgba(255,247,0,0.5);
    animation: floatUp 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
  }
  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-100px) scale(0.6); }
  }

  /* Perfect prompt flash */
  .perfect-flash {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-family: 'Fredoka One', cursive;
    font-size: 2.5rem;
    color: var(--neon-green);
    text-shadow: 0 0 30px rgba(57,255,20,0.5);
    pointer-events: none;
    z-index: 101;
    animation: perfectAnim 1s ease forwards;
  }
  @keyframes perfectAnim {
    0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 1; }
    30% { transform: translate(-50%, -50%) scale(1.2) rotate(3deg); opacity: 1; }
    100% { transform: translate(-50%, -70%) scale(0.9); opacity: 0; }
  }

  /* === RESULTS SCREEN === */
  .results-card {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(24px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 32px;
    padding: 3rem;
    max-width: 620px; width: 100%;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .results-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--neon-pink), var(--neon-yellow), var(--neon-green), var(--neon-blue));
    background-size: 300% 100%;
    animation: xpShimmer 3s linear infinite;
  }

  .results-rank {
    width: 100px; height: 100px;
    margin: 0 auto 1rem;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 3.5rem;
    position: relative;
  }
  .results-rank::before {
    content: '';
    position: absolute; inset: -3px;
    border-radius: 50%;
    background: conic-gradient(var(--neon-pink), var(--neon-yellow), var(--neon-green), var(--neon-blue), var(--neon-pink));
    z-index: -1;
    animation: rankSpin 4s linear infinite;
  }
  .results-rank::after {
    content: '';
    position: absolute; inset: 0;
    border-radius: 50%;
    background: var(--darker-bg);
    z-index: -1;
  }
  @keyframes rankSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .results-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2.5rem;
    margin-bottom: 0.3rem;
    background: linear-gradient(135deg, var(--neon-yellow), var(--neon-orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .results-subtitle {
    color: rgba(255,255,255,0.4);
    margin-bottom: 2rem;
    font-size: 0.95rem;
  }
  .results-stats {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 0.8rem; margin-bottom: 1.5rem;
  }
  .stat-box {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px;
    padding: 1.2rem 0.8rem;
    transition: all 0.3s;
  }
  .stat-box:hover {
    border-color: rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
  }
  .stat-box .stat-val {
    font-family: 'Fredoka One', cursive;
    font-size: 2.2rem;
  }
  .stat-box .stat-label {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.3);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 700;
  }

  /* Star rating */
  .star-rating {
    margin: 0.5rem 0 1.5rem;
    font-size: 2rem;
    letter-spacing: 4px;
  }
  .star-rating .star { display: inline-block; opacity: 0; animation: starAppear 0.4s ease forwards; }
  .star-rating .star.filled { filter: drop-shadow(0 0 8px rgba(255,247,0,0.5)); }
  .star-rating .star.empty { filter: grayscale(1) opacity(0.2); }
  @keyframes starAppear {
    0% { opacity: 0; transform: scale(0) rotate(-30deg); }
    100% { opacity: 1; transform: scale(1) rotate(0deg); }
  }

  /* Achievements */
  .achievements {
    display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }
  .achievement {
    display: flex; align-items: center; gap: 0.4rem;
    background: rgba(255,247,0,0.06);
    border: 1px solid rgba(255,247,0,0.12);
    border-radius: 20px;
    padding: 0.3rem 0.8rem;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--neon-yellow);
    opacity: 0;
    animation: achieveSlide 0.5s ease forwards;
  }
  @keyframes achieveSlide {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  .spanish-learned {
    background: rgba(255,247,0,0.03);
    border: 1px solid rgba(255,247,0,0.1);
    border-radius: 16px;
    padding: 1rem 1.2rem; margin-bottom: 1.5rem;
    text-align: left;
  }
  .spanish-learned h3 {
    font-family: 'Fredoka One', cursive;
    color: var(--neon-yellow);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  .spanish-learned .word-list {
    display: flex; flex-wrap: wrap; gap: 0.4rem;
  }
  .spanish-learned .word-chip {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 0.25rem 0.7rem;
    border-radius: 20px;
    font-size: 0.8rem;
    transition: all 0.2s;
  }
  .spanish-learned .word-chip:hover {
    background: rgba(255,247,0,0.1);
    border-color: rgba(255,247,0,0.2);
  }
  .spanish-learned .word-chip span {
    color: rgba(255,255,255,0.35);
    font-size: 0.7rem;
  }

  .results-actions {
    display: flex; gap: 0.8rem; justify-content: center; flex-wrap: wrap;
  }

  /* === KEYBOARD VISUAL === */
  .keyboard {
    display: flex; flex-direction: column;
    align-items: center; gap: 5px;
    max-width: 900px; width: 100%;
    margin-top: 0.5rem;
    padding: 1rem;
    background: rgba(255,255,255,0.02);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.04);
  }
  .kb-row { display: flex; gap: 4px; }
  .kb-key {
    width: 48px; height: 44px;
    background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
    border: 1px solid rgba(255,255,255,0.08);
    border-bottom: 3px solid rgba(255,255,255,0.04);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Nunito', sans-serif;
    font-size: 0.8rem; font-weight: 800;
    color: rgba(255,255,255,0.4);
    transition: all 0.12s ease;
    position: relative;
  }
  /* Finger color guides - subtle bottom accent */
  .kb-key.finger-left-pinky { box-shadow: inset 0 -2px 0 rgba(255,107,107,0.4); }
  .kb-key.finger-left-ring { box-shadow: inset 0 -2px 0 rgba(255,169,77,0.4); }
  .kb-key.finger-left-middle { box-shadow: inset 0 -2px 0 rgba(255,212,59,0.4); }
  .kb-key.finger-left-index { box-shadow: inset 0 -2px 0 rgba(105,219,124,0.4); }
  .kb-key.finger-right-index { box-shadow: inset 0 -2px 0 rgba(105,219,124,0.4); }
  .kb-key.finger-right-middle { box-shadow: inset 0 -2px 0 rgba(255,212,59,0.4); }
  .kb-key.finger-right-ring { box-shadow: inset 0 -2px 0 rgba(255,169,77,0.4); }
  .kb-key.finger-right-pinky { box-shadow: inset 0 -2px 0 rgba(255,107,107,0.4); }
  .kb-key.finger-thumb { box-shadow: inset 0 -2px 0 rgba(0,212,255,0.4); }

  .kb-key.active {
    background: linear-gradient(180deg, rgba(0,212,255,0.25) 0%, rgba(0,212,255,0.1) 100%);
    border-color: rgba(0,212,255,0.4);
    color: #fff;
    box-shadow: 0 0 20px rgba(0,212,255,0.2), inset 0 -2px 0 rgba(0,212,255,0.5);
    transform: translateY(-2px);
  }
  .kb-key.pressed-correct {
    background: linear-gradient(180deg, rgba(57,255,20,0.25) 0%, rgba(57,255,20,0.08) 100%);
    border-color: rgba(57,255,20,0.4);
    color: var(--neon-green);
    transform: translateY(1px);
    box-shadow: 0 0 15px rgba(57,255,20,0.2);
  }
  .kb-key.pressed-wrong {
    background: linear-gradient(180deg, rgba(255,45,149,0.25) 0%, rgba(255,45,149,0.08) 100%);
    border-color: rgba(255,45,149,0.4);
    color: var(--neon-pink);
    box-shadow: 0 0 15px rgba(255,45,149,0.2);
  }
  .kb-key.space { width: 280px; }
  .kb-key.wide { width: 72px; font-size: 0.6rem; }
  .kb-key.wider { width: 96px; font-size: 0.6rem; }

  /* Home row dots */
  .kb-key.home-row::after {
    content: '';
    position: absolute;
    bottom: 6px;
    width: 4px; height: 4px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
  }

  /* === PARTICLES === */
  .particle {
    position: fixed;
    pointer-events: none;
    z-index: 200;
    border-radius: 50%;
    animation: particleFly 0.8s ease-out forwards;
  }
  @keyframes particleFly {
    0% { opacity: 1; transform: translate(0,0) scale(1); }
    100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0); }
  }

  /* === CONFETTI === */
  .confetti {
    position: fixed;
    z-index: 300;
    pointer-events: none;
    animation: confettiFall var(--dur, 3s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }
  @keyframes confettiFall {
    0% { opacity: 1; transform: translateY(0) rotate(0deg) translateX(0); }
    25% { transform: translateY(25vh) rotate(180deg) translateX(var(--sway, 30px)); }
    50% { transform: translateY(50vh) rotate(360deg) translateX(calc(var(--sway, 30px) * -1)); }
    75% { transform: translateY(75vh) rotate(540deg) translateX(var(--sway, 30px)); }
    100% { opacity: 0; transform: translateY(105vh) rotate(720deg) translateX(0); }
  }

  /* Level up overlay */
  .level-up-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center; justify-content: center;
    z-index: 500;
  }
  .level-up-overlay.show { display: flex; }
  .level-up-box {
    text-align: center;
    animation: levelUpBounce 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .level-up-box .lu-emoji { font-size: 5rem; filter: drop-shadow(0 0 30px rgba(255,247,0,0.5)); }
  .level-up-box .lu-text {
    font-family: 'Fredoka One', cursive;
    font-size: 3.5rem;
    background: linear-gradient(135deg, var(--neon-yellow), var(--neon-orange), var(--neon-pink));
    background-size: 200% 200%;
    animation: gradientShift 2s ease infinite;
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .level-up-box .lu-sub {
    color: rgba(255,255,255,0.5);
    margin-top: 0.5rem;
    font-weight: 600;
  }
  @keyframes levelUpBounce {
    0% { transform: scale(0) rotate(-20deg); }
    50% { transform: scale(1.15) rotate(5deg); }
    70% { transform: scale(0.95) rotate(-2deg); }
    100% { transform: scale(1) rotate(0deg); }
  }

  .screen-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2rem;
    margin-bottom: 0.3rem;
    text-align: center;
  }

  /* === AUDIO CONTROLS === */
  .audio-controls {
    position: fixed; top: 1rem; right: 1rem;
    z-index: 600;
    display: flex; gap: 0.5rem; align-items: center;
  }
  .audio-btn {
    width: 44px; height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
  }
  .audio-btn:hover {
    background: rgba(255,255,255,0.12);
    border-color: rgba(0,212,255,0.3);
    transform: scale(1.1);
  }
  .audio-btn.muted { opacity: 0.4; }
  .vol-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 80px; height: 4px;
    background: rgba(255,255,255,0.15);
    border-radius: 2px;
    outline: none;
    opacity: 0;
    transition: opacity 0.3s, width 0.3s;
    width: 0;
    pointer-events: none;
  }
  .audio-controls:hover .vol-slider,
  .audio-controls:focus-within .vol-slider {
    opacity: 1; width: 80px; pointer-events: auto;
  }
  .vol-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--neon-blue);
    cursor: pointer;
    box-shadow: 0 0 8px rgba(0,212,255,0.4);
  }
  .vol-slider::-moz-range-thumb {
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--neon-blue);
    cursor: pointer;
    border: none;
  }

  /* === RESPONSIVE === */
  @media (max-width: 600px) {
    .kb-key { width: 30px; height: 34px; font-size: 0.65rem; }
    .kb-key.space { width: 150px; }
    .kb-key.wide { width: 44px; }
    .kb-key.wider { width: 60px; }
    .prompt-text { font-size: 1.2rem; letter-spacing: 1px; }
    .game-hud { padding: 0.6rem 0.8rem; }
    .typing-area { padding: 1.5rem; }
    .title-logo { font-size: clamp(2.5rem, 12vw, 4rem); }
    .mascot-box { width: 48px; height: 48px; font-size: 2rem; }
    .results-card { padding: 2rem 1.5rem; }
  }

  /* === PROGRESS DOTS === */
  .progress-dots {
    display: flex; gap: 4px; justify-content: center;
    max-width: 900px; width: 100%;
    margin-bottom: 0.8rem;
    flex-wrap: wrap;
  }
  .progress-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.08);
    transition: all 0.3s;
  }
  .progress-dot.done { background: var(--neon-green); box-shadow: 0 0 6px rgba(57,255,20,0.3); }
  .progress-dot.current { background: var(--neon-blue); box-shadow: 0 0 8px rgba(0,212,255,0.4); transform: scale(1.3); }
  .progress-dot.upcoming { background: rgba(255,255,255,0.06); }

  /* === GIVE BONE BUTTON (Copper only) === */
  .bone-btn {
    position: fixed; bottom: 1.5rem; right: 1.5rem;
    z-index: 550;
    font-size: 1rem;
    font-family: 'Fredoka One', cursive;
    padding: 0.8rem 1.5rem;
    border-radius: 50px;
    border: 2px solid rgba(255,247,0,0.3);
    background: linear-gradient(135deg, rgba(200,169,97,0.2), rgba(255,247,0,0.1));
    backdrop-filter: blur(12px);
    color: var(--neon-yellow);
    cursor: pointer;
    transition: all 0.3s;
    display: none;
    animation: boneFloat 3s ease-in-out infinite;
  }
  .bone-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 30px rgba(255,247,0,0.2);
    border-color: rgba(255,247,0,0.5);
  }
  @keyframes boneFloat {
    0%,100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }

  /* === RIDDLE SCREEN === */
  .riddle-card {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(24px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 32px;
    padding: 2.5rem;
    max-width: 650px; width: 100%;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .riddle-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--neon-yellow), var(--neon-orange), var(--neon-yellow));
    background-size: 200% 100%;
    animation: xpShimmer 3s linear infinite;
  }
  .riddle-icon { font-size: 4rem; margin-bottom: 1rem; }
  .riddle-title {
    font-family: 'Fredoka One', cursive;
    font-size: 1.8rem;
    color: var(--neon-yellow);
    margin-bottom: 0.3rem;
  }
  .riddle-subtitle {
    color: rgba(255,255,255,0.4);
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
  }
  .riddle-progress {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.3);
    margin-bottom: 1.5rem;
    font-weight: 700;
  }
  .riddle-question {
    font-size: 1.2rem;
    font-weight: 700;
    line-height: 1.5;
    margin-bottom: 1.5rem;
    color: rgba(255,255,255,0.85);
    min-height: 60px;
  }
  .riddle-options {
    display: flex; flex-direction: column;
    gap: 0.6rem; margin-bottom: 1.5rem;
  }
  .riddle-opt {
    padding: 0.9rem 1.2rem;
    border-radius: 14px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-align: left;
    font-family: 'Nunito', sans-serif;
  }
  .riddle-opt:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(0,212,255,0.3);
    transform: translateX(4px);
  }
  .riddle-opt.correct {
    background: rgba(57,255,20,0.15);
    border-color: rgba(57,255,20,0.4);
    color: var(--neon-green);
  }
  .riddle-opt.wrong {
    background: rgba(255,45,149,0.15);
    border-color: rgba(255,45,149,0.4);
    color: var(--neon-pink);
  }
  .riddle-opt.disabled { pointer-events: none; opacity: 0.5; }
  .riddle-feedback {
    font-family: 'Fredoka One', cursive;
    font-size: 1.3rem;
    min-height: 40px;
    margin-bottom: 1rem;
    transition: all 0.3s;
  }

  /* Prize reveal */
  .prize-card {
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(24px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 32px;
    padding: 3rem;
    max-width: 550px; width: 100%;
    text-align: center;
  }
  .prize-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--neon-green), var(--neon-yellow), var(--neon-green));
    background-size: 200% 100%;
    animation: xpShimmer 2s linear infinite;
  }
  .prize-emoji { font-size: 5rem; margin-bottom: 1rem; animation: mascotBounce 2s ease-in-out infinite; }
  .prize-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2rem;
    background: linear-gradient(135deg, var(--neon-yellow), var(--neon-orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
  }
  .prize-desc {
    font-size: 1.1rem;
    color: rgba(255,255,255,0.6);
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }
  .prize-coupon {
    display: inline-block;
    background: linear-gradient(135deg, rgba(255,247,0,0.1), rgba(255,110,0,0.1));
    border: 2px dashed rgba(255,247,0,0.3);
    border-radius: 16px;
    padding: 1.2rem 2rem;
    margin: 1.5rem 0;
    font-family: 'Fredoka One', cursive;
    font-size: 1.1rem;
    color: var(--neon-yellow);
  }
  .prize-coupon .prize-code {
    display: block;
    font-size: 0.7rem;
    color: rgba(255,255,255,0.3);
    margin-top: 0.3rem;
    letter-spacing: 2px;
  }
  .prize-fine-print {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.25);
    margin-top: 1rem;
    font-style: italic;
  }

  /* === SCREEN FADE TRANSITION === */
  .screen-fade-out {
    animation: screenFadeOut 0.3s ease forwards !important;
  }
  @keyframes screenFadeOut {
    0% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* === THEME OVERLAY === */
  #theme-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 2; pointer-events: none;
  }
  #theme-overlay > * { pointer-events: auto; }

  /* === MOM DANCE FLOOR GAME === */
  [data-theme="mom"] { --accent: var(--neon-pink); }

  .dance-screen { text-align: center; }
  .dance-stage {
    position: relative;
    width: 340px; height: 500px;
    margin: 0 auto;
    overflow: hidden;
    border-radius: 24px;
    background: radial-gradient(ellipse at 50% 80%, rgba(255,45,149,0.12) 0%, transparent 70%),
                linear-gradient(180deg, rgba(10,10,46,0.95) 0%, rgba(20,10,40,0.98) 100%);
    border: 1px solid rgba(255,45,149,0.15);
  }
  .dance-hit-zone {
    position: absolute; top: 60px; left: 0; right: 0; height: 56px;
    border-top: 3px solid rgba(255,45,149,0.5);
    border-bottom: 3px solid rgba(255,45,149,0.5);
    background: rgba(255,45,149,0.06);
    display: flex; justify-content: center; gap: 36px; align-items: center;
    z-index: 5;
  }
  .dance-hit-zone .hit-slot {
    width: 50px; height: 50px; border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.15);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; color: rgba(255,255,255,0.2);
  }
  .dance-arrow {
    position: absolute; width: 50px; height: 50px;
    border-radius: 12px; font-size: 1.8rem;
    display: flex; align-items: center; justify-content: center;
    transition: none; z-index: 4;
    text-shadow: 0 0 12px currentColor;
  }
  .dance-arrow.left { color: var(--neon-green); background: rgba(57,255,20,0.12); border: 1px solid rgba(57,255,20,0.3); }
  .dance-arrow.up { color: var(--neon-blue); background: rgba(0,212,255,0.12); border: 1px solid rgba(0,212,255,0.3); }
  .dance-arrow.down { color: var(--neon-purple); background: rgba(176,38,255,0.12); border: 1px solid rgba(176,38,255,0.3); }
  .dance-arrow.right { color: var(--neon-orange); background: rgba(255,110,0,0.12); border: 1px solid rgba(255,110,0,0.3); }
  .dance-arrow.hit-perfect { animation: arrowPerfect 0.3s ease forwards; }
  .dance-arrow.hit-good { animation: arrowGood 0.3s ease forwards; }
  .dance-arrow.hit-miss { animation: arrowMiss 0.3s ease forwards; }
  @keyframes arrowPerfect { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.6); opacity: 0; } }
  @keyframes arrowGood { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
  @keyframes arrowMiss { 0% { opacity: 0.5; } 100% { opacity: 0; transform: translateY(-20px); } }

  .dance-score-hud {
    display: flex; justify-content: space-around; align-items: center;
    max-width: 400px; margin: 1rem auto; padding: 0.6rem 1rem;
    background: rgba(255,255,255,0.03); border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.06);
  }
  .dance-lyrics {
    max-width: 500px; margin: 0.8rem auto 0;
    font-style: italic; color: rgba(255,45,149,0.5);
    font-size: 0.85rem; min-height: 1.2em;
    transition: opacity 0.3s;
  }
  .dance-judgment {
    position: absolute; top: 30%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-family: 'Fredoka One', cursive; font-size: 2rem;
    pointer-events: none; z-index: 10;
    animation: judgmentPop 0.6s ease forwards;
  }
  @keyframes judgmentPop {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
    30% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
    100% { transform: translate(-50%, -70%) scale(0.8); opacity: 0; }
  }
  .rose-particle {
    position: fixed; pointer-events: none; z-index: 200;
    font-size: 1.2rem;
    animation: roseFloat 1.5s ease-out forwards;
  }
  @keyframes roseFloat {
    0% { opacity: 1; transform: translate(0,0) rotate(0deg) scale(1); }
    100% { opacity: 0; transform: translate(var(--rx), var(--ry)) rotate(180deg) scale(0.3); }
  }

  /* === BRYSON/ANGELINA LESSON SYSTEM === */
  .lesson-screen { text-align: center; max-width: 700px; margin: 0 auto; }
  .lesson-progress-bar {
    width: 100%; max-width: 500px; height: 10px;
    background: rgba(255,255,255,0.06); border-radius: 5px;
    margin: 1rem auto; overflow: hidden;
  }
  .lesson-progress-fill {
    height: 100%; border-radius: 5px;
    background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
    transition: width 0.5s ease;
  }
  .lesson-badge {
    display: inline-block; padding: 4px 14px; border-radius: 20px;
    font-size: 0.7rem; font-weight: 800; text-transform: uppercase;
    letter-spacing: 1.5px; margin-bottom: 1rem;
    background: rgba(0,212,255,0.1); color: var(--neon-blue);
    border: 1px solid rgba(0,212,255,0.2);
  }
  .mystery-narrative {
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
    border-radius: 20px; padding: 2rem; margin: 1rem 0;
    text-align: left; position: relative; overflow: hidden;
  }
  .mystery-narrative::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, rgba(176,38,255,0.4), transparent);
  }
  .mystery-text {
    font-size: 1.05rem; line-height: 1.7;
    color: rgba(255,255,255,0.8); margin-bottom: 1.2rem;
  }
  .mystery-choice-prompt {
    font-family: 'Fredoka One', cursive; color: var(--neon-purple);
    margin-bottom: 0.8rem; font-size: 0.9rem;
  }
  .mystery-typing-area {
    background: rgba(176,38,255,0.06); border: 1px solid rgba(176,38,255,0.2);
    border-radius: 14px; padding: 1rem 1.5rem;
    font-size: 1.1rem; color: var(--neon-purple);
    min-height: 44px; text-align: center;
    font-family: 'Fredoka One', cursive;
  }
  .mystery-particle {
    position: fixed; pointer-events: none; z-index: 150;
    font-size: 1.5rem; opacity: 0.15;
    animation: mysteryFloat 8s ease-in-out infinite;
  }
  @keyframes mysteryFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.1; }
    50% { transform: translateY(-30px) rotate(180deg); opacity: 0.25; }
  }

  /* === DAD BRIEFCASE GAME === */
  [data-theme="dad"] { --accent: var(--neon-green); }
  .dad-screen { text-align: center; max-width: 800px; margin: 0 auto; }
  .dad-money-counter {
    font-family: 'Fredoka One', cursive; font-size: 2.5rem;
    color: var(--neon-green); text-shadow: 0 0 30px rgba(57,255,20,0.3);
    margin-bottom: 0.5rem;
  }
  .dad-briefcase-meter {
    width: 100%; max-width: 500px; height: 24px;
    background: rgba(255,255,255,0.06); border-radius: 12px;
    margin: 0.5rem auto 1rem; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.08); position: relative;
  }
  .dad-briefcase-fill {
    height: 100%; border-radius: 12px;
    background: linear-gradient(90deg, rgba(57,255,20,0.3), var(--neon-green));
    transition: width 0.4s ease; position: relative;
  }
  .dad-briefcase-fill::after {
    content: 'üíº'; position: absolute; right: -8px; top: -2px; font-size: 1.3rem;
  }
  .dad-news-ticker {
    width: 100%; overflow: hidden; height: 32px;
    background: rgba(255,45,149,0.08); border-radius: 8px;
    margin-top: 1rem; position: relative;
    border: 1px solid rgba(255,45,149,0.15);
  }
  .dad-news-ticker-label {
    position: absolute; left: 0; top: 0; bottom: 0;
    background: var(--neon-pink); color: #fff;
    font-family: 'Fredoka One', cursive; font-size: 0.65rem;
    padding: 0 10px; display: flex; align-items: center;
    z-index: 2; letter-spacing: 1px;
  }
  .dad-news-ticker-text {
    white-space: nowrap; position: absolute; top: 50%;
    transform: translateY(-50%); font-size: 0.8rem;
    color: rgba(255,255,255,0.6); font-weight: 600;
    animation: tickerScroll 20s linear infinite;
  }
  @keyframes tickerScroll {
    0% { left: 100%; }
    100% { left: -200%; }
  }
  .dad-breaking-news {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,45,149,0.15); backdrop-filter: blur(20px);
    border: 2px solid var(--neon-pink); border-radius: 24px;
    padding: 2rem 3rem; text-align: center; z-index: 500;
    animation: breakingPulse 0.5s ease;
    display: none;
  }
  .dad-breaking-news.show { display: block; }
  @keyframes breakingPulse {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  }

  /* === ALICE BATTLE SYSTEM === */
  [data-theme="alice"] { --accent: var(--neon-purple); }
  .alice-screen { text-align: center; }
  .alice-demon {
    font-size: 6rem; margin: 1rem 0;
    transition: transform 0.1s, filter 0.1s;
    filter: drop-shadow(0 0 20px rgba(255,45,149,0.3));
  }
  .alice-demon.hit {
    animation: demonHit 0.3s ease;
    filter: drop-shadow(0 0 30px rgba(255,45,149,0.6)) brightness(1.5);
  }
  .alice-demon.defeated {
    animation: demonDefeat 0.8s ease forwards;
  }
  @keyframes demonHit {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-10px) rotate(-5deg); }
    40% { transform: translateX(10px) rotate(5deg); }
    60% { transform: translateX(-6px); }
    80% { transform: translateX(6px); }
  }
  @keyframes demonDefeat {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3) rotate(15deg); opacity: 0.5; filter: brightness(3); }
    100% { transform: scale(0) rotate(360deg); opacity: 0; }
  }
  .alice-hp-bar {
    width: 250px; height: 18px; margin: 0 auto 0.5rem;
    background: rgba(255,255,255,0.08); border-radius: 9px;
    overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
  }
  .alice-hp-fill {
    height: 100%; border-radius: 9px;
    background: linear-gradient(90deg, var(--neon-pink), #ff4444);
    transition: width 0.3s ease;
  }
  .alice-hp-text {
    font-family: 'Fredoka One', cursive; font-size: 0.8rem;
    color: var(--neon-pink); margin-bottom: 0.5rem;
  }
  .alice-prompt-display {
    font-family: 'Fredoka One', cursive; font-size: 3rem;
    letter-spacing: 8px; margin: 1.5rem 0;
    min-height: 80px;
  }
  .alice-prompt-display .char { display: inline-block; transition: all 0.15s; padding: 0 4px; }
  .alice-prompt-display .char.correct { color: var(--neon-green); text-shadow: 0 0 12px rgba(57,255,20,0.4); }
  .alice-prompt-display .char.incorrect { color: var(--neon-pink); }
  .alice-prompt-display .char.current { color: #fff; background: rgba(176,38,255,0.25); border-radius: 6px; }
  .alice-prompt-display .char.upcoming { color: rgba(255,255,255,0.2); }
  .alice-prize-screen {
    text-align: center; padding: 2rem;
  }
  .alice-toy-reveal {
    font-size: 5rem; margin: 1rem 0;
    animation: mascotBounce 1.5s ease-in-out infinite;
  }
  .alice-wave-counter {
    font-family: 'Fredoka One', cursive; font-size: 0.9rem;
    color: rgba(255,255,255,0.4); margin-bottom: 0.5rem;
  }

  /* === COPPER YARD GRID === */
  [data-theme="copper"] { --accent: var(--neon-yellow); }
  .copper-screen { text-align: center; }
  .yard-grid {
    display: grid; grid-template-columns: repeat(3, 100px);
    gap: 8px; justify-content: center; margin: 1rem auto;
  }
  .yard-spot {
    width: 100px; height: 100px; border-radius: 16px;
    background: linear-gradient(135deg, rgba(57,255,20,0.08), rgba(57,255,20,0.03));
    border: 2px solid rgba(57,255,20,0.15);
    display: flex; align-items: center; justify-content: center;
    font-size: 2.5rem; cursor: pointer; transition: all 0.3s;
    position: relative;
  }
  .yard-spot:hover {
    border-color: rgba(57,255,20,0.4);
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(57,255,20,0.1);
  }
  .yard-spot.dug {
    background: linear-gradient(135deg, rgba(139,90,43,0.2), rgba(101,67,33,0.15));
    border-color: rgba(139,90,43,0.3);
  }
  .yard-spot.found-bone {
    animation: boneReveal 0.6s ease;
    border-color: rgba(255,247,0,0.5);
    box-shadow: 0 0 30px rgba(255,247,0,0.2);
  }
  @keyframes boneReveal {
    0% { transform: scale(1); }
    50% { transform: scale(1.2) rotate(10deg); }
    100% { transform: scale(1); }
  }
  .yard-spot .spot-number {
    position: absolute; top: 4px; right: 8px;
    font-size: 0.6rem; color: rgba(255,255,255,0.2);
    font-weight: 800;
  }
  .copper-hint-display {
    font-family: 'Fredoka One', cursive; font-size: 1.3rem;
    margin: 0.8rem 0; min-height: 2em;
    color: var(--neon-yellow);
  }
  .copper-sniff-prompt {
    background: rgba(255,247,0,0.06); border: 1px solid rgba(255,247,0,0.15);
    border-radius: 16px; padding: 1rem 2rem;
    max-width: 500px; margin: 0.8rem auto;
  }
  .copper-round-info {
    font-family: 'Fredoka One', cursive; font-size: 0.85rem;
    color: rgba(255,255,255,0.35); margin-bottom: 0.5rem;
  }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div id="theme-overlay"></div>

<!-- AUDIO CONTROLS -->
<div class="audio-controls">
  <button class="audio-btn" id="btn-music" onclick="toggleMusic()" title="Toggle Music">üéµ</button>
  <button class="audio-btn" id="btn-sfx" onclick="toggleSFX()" title="Toggle Sound Effects">üîä</button>
  <input type="range" class="vol-slider" id="vol-slider" min="0" max="100" value="50" oninput="setVolume(this.value)">
</div>

<div id="combo-popup" class="combo-popup"></div>
<div id="level-up-overlay" class="level-up-overlay">
  <div class="level-up-box">
    <div class="lu-emoji" id="lu-emoji"></div>
    <div class="lu-text" id="lu-text"></div>
    <div class="lu-sub" id="lu-sub"></div>
  </div>
</div>

<!-- ==================== TITLE SCREEN ==================== -->
<div id="screen-title" class="screen active">
  <div class="title-container">
    <div class="title-mascot">üéâ</div>
    <div class="title-logo">TYPING FIESTA!</div>
    <div class="title-sub-row">
      <span class="title-flag">üá∫üá∏</span>
      <span style="color:rgba(255,255,255,0.3); font-weight:800;">+</span>
      <span class="title-flag">üá™üá∏</span>
    </div>
    <div class="subtitle">Learn to type + learn Spanish = double W no cap</div>
  </div>

  <div class="player-select">
    <div class="player-card" data-player="Bryson" onclick="selectPlayer(this)">
      <div class="avatar">üéÆ</div>
      <div class="name">Bryson</div>
      <div class="player-tag">Player 1</div>
    </div>
    <div class="player-card" data-player="Angelina" onclick="selectPlayer(this)">
      <div class="avatar">üåü</div>
      <div class="name">Angelina</div>
      <div class="player-tag">Player 2</div>
    </div>
    <div class="player-card" data-player="Alice" onclick="selectPlayer(this)">
      <div class="avatar">üéÄ</div>
      <div class="name">Alice</div>
      <div class="player-tag">K-Pop Hunter</div>
    </div>
    <div class="player-card" data-player="Copper" onclick="selectPlayer(this)">
      <div class="avatar">üêï</div>
      <div class="name">Copper</div>
      <div class="player-tag">Good Boy</div>
    </div>
    <div class="player-card" data-player="Dad" onclick="selectPlayer(this)">
      <div class="avatar">üíº</div>
      <div class="name">Dad</div>
      <div class="player-tag">Dad</div>
    </div>
    <div class="player-card" data-player="Mom" onclick="selectPlayer(this)">
      <div class="avatar">üåπ</div>
      <div class="name">Mom</div>
      <div class="player-tag">Reggaeton Queen</div>
    </div>
  </div>

  <button class="btn btn-play" id="btn-start" disabled onclick="showModeSelect()">
    Let's Go!
  </button>
</div>

<!-- ==================== MODE SELECT ==================== -->
<div id="screen-modes" class="screen">
  <div class="screen-title">Choose Your Vibe</div>
  <div class="subtitle" id="mode-greeting"></div>

  <div class="mode-grid">
    <div class="mode-card" onclick="startGame('vocab')">
      <div class="mode-icon">üìö</div>
      <div class="mode-title">Vocab Grind</div>
      <div class="mode-desc">Type Spanish words one at a time. Perfect for beginners!</div>
      <div class="diff-badge easy">Easy</div>
    </div>
    <div class="mode-card" onclick="startGame('phrases')">
      <div class="mode-icon">üí¨</div>
      <div class="mode-title">Frases Mode</div>
      <div class="mode-desc">Full Spanish phrases with English meanings. Mas dificil!</div>
      <div class="diff-badge medium">Medium</div>
    </div>
    <div class="mode-card" onclick="startGame('spanglish')">
      <div class="mode-icon">üî•</div>
      <div class="mode-title">Spanglish Remix</div>
      <div class="mode-desc">English sentences with Spanish words mixed in. Bussin!</div>
      <div class="diff-badge medium">Medium</div>
    </div>
    <div class="mode-card" onclick="startGame('boss')">
      <div class="mode-icon">üëë</div>
      <div class="mode-title">Boss Level</div>
      <div class="mode-desc">Full Spanish sentences. Only for the real ones. Sigma grindset!</div>
      <div class="diff-badge boss">Boss</div>
    </div>
    <div class="mode-card" onclick="startGame('race')">
      <div class="mode-icon">üèéÔ∏è</div>
      <div class="mode-title">Speed Race</div>
      <div class="mode-desc">60-second speed run! How many words can you type?</div>
      <div class="diff-badge hard">Timed</div>
    </div>
    <div class="mode-card" onclick="startGame('story')">
      <div class="mode-icon">üìñ</div>
      <div class="mode-title">Story Mode</div>
      <div class="mode-desc">Type through a bilingual adventure! New story each time!</div>
      <div class="diff-badge medium">Adventure</div>
    </div>
  </div>

  <button class="btn btn-secondary" onclick="showScreen('screen-title')" style="margin-top:1rem;">
    Back
  </button>
</div>

<!-- ==================== GAME SCREEN ==================== -->
<div id="screen-game" class="screen">
  <div class="game-top-row">
    <div class="mascot-box" id="mascot-box">üòä</div>
    <div class="game-hud">
      <div class="hud-item">
        <div class="hud-label">Score</div>
        <div class="hud-value score" id="hud-score">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Streak</div>
        <div class="hud-value streak" id="hud-streak">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">WPM</div>
        <div class="hud-value wpm" id="hud-wpm">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Level</div>
        <div class="hud-value level" id="hud-level">1</div>
      </div>
      <div class="hud-item" id="hud-timer-box" style="display:none;">
        <div class="hud-label">Time</div>
        <div class="hud-value timer" id="hud-timer">60</div>
      </div>
    </div>
  </div>

  <div class="xp-bar-container">
    <div class="xp-bar" id="xp-bar"></div>
  </div>

  <div class="progress-dots" id="progress-dots"></div>

  <div class="spanish-hint" id="spanish-hint">
    <div class="hint-spanish" id="hint-spanish"></div>
    <div class="hint-english" id="hint-english"></div>
    <div class="hint-category" id="hint-category"></div>
  </div>

  <div class="typing-area" id="typing-area" tabindex="0">
    <div class="prompt-text" id="prompt-text"></div>
    <div class="click-hint" id="click-hint">click here or start typing</div>
  </div>

  <input type="text" class="hidden-input" id="hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

  <div class="keyboard" id="keyboard"></div>
</div>

<!-- GIVE BONE BUTTON (Copper only) -->
<button class="bone-btn" id="bone-btn" onclick="startRiddleGame()">ü¶¥ Give Bone</button>

<!-- ==================== RIDDLE SCREEN ==================== -->
<div id="screen-riddle" class="screen">
  <div class="riddle-card">
    <div class="riddle-icon" id="riddle-icon">ü¶¥</div>
    <div class="riddle-title">Copper's Bone Riddles</div>
    <div class="riddle-subtitle">Answer the riddles to unlock a Dad Prize!</div>
    <div class="riddle-progress" id="riddle-progress">Riddle 1 of 3</div>
    <div class="riddle-question" id="riddle-question"></div>
    <div class="riddle-options" id="riddle-options"></div>
    <div class="riddle-feedback" id="riddle-feedback"></div>
  </div>
</div>

<!-- ==================== PRIZE SCREEN ==================== -->
<div id="screen-prize" class="screen">
  <div class="prize-card" style="position:relative;">
    <div class="prize-emoji" id="prize-emoji">üéÅ</div>
    <div class="prize-title" id="prize-title">Dad Prize Unlocked!</div>
    <div class="prize-desc" id="prize-desc"></div>
    <div class="prize-coupon" id="prize-coupon">
      <span id="prize-text"></span>
      <span class="prize-code" id="prize-code"></span>
    </div>
    <div class="prize-fine-print" id="prize-fine-print"></div>
    <div style="margin-top:1.5rem; display:flex; gap:0.8rem; justify-content:center; flex-wrap:wrap;">
      <button class="btn btn-play" onclick="startRiddleGame()">Another Riddle!</button>
      <button class="btn btn-secondary" onclick="closePrize()">Back to Typing</button>
      <button class="btn btn-secondary" onclick="showScreen('screen-title')">Home</button>
    </div>
  </div>
</div>

<!-- ==================== MOM DANCE GAME ==================== -->
<div id="screen-mom" class="screen">
  <div class="dance-screen">
    <div class="screen-title" style="margin-bottom:0.3rem;">üåπ Dance Floor üåπ</div>
    <div class="subtitle" style="margin-bottom:0.5rem;">Hit the arrows on beat!</div>
    <div class="dance-score-hud">
      <div class="hud-item">
        <div class="hud-label">Score</div>
        <div class="hud-value score" id="dance-score">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Combo</div>
        <div class="hud-value streak" id="dance-combo">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Rating</div>
        <div class="hud-value" id="dance-rating" style="color:var(--neon-yellow);">‚Äî</div>
      </div>
    </div>
    <div class="dance-stage" id="dance-stage">
      <div class="dance-hit-zone" id="dance-hit-zone">
        <div class="hit-slot">‚Üê</div>
        <div class="hit-slot">‚Üë</div>
        <div class="hit-slot">‚Üì</div>
        <div class="hit-slot">‚Üí</div>
      </div>
    </div>
    <div class="dance-lyrics" id="dance-lyrics"></div>
  </div>
</div>

<!-- ==================== BRYSON/ANGELINA LESSON SCREEN ==================== -->
<div id="screen-lesson" class="screen">
  <div class="lesson-screen">
    <div class="screen-title" id="lesson-title">Lesson 1</div>
    <div class="lesson-badge" id="lesson-badge">HOME ROW</div>
    <div class="lesson-progress-bar">
      <div class="lesson-progress-fill" id="lesson-progress-fill" style="width:0%"></div>
    </div>
    <div class="subtitle" id="lesson-subtitle" style="margin-bottom:1rem;">Type the letters below</div>
    <div class="typing-area" id="lesson-typing-area" tabindex="0">
      <div class="prompt-text" id="lesson-prompt-text"></div>
    </div>
    <input type="text" class="hidden-input" id="lesson-hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <div class="keyboard" id="lesson-keyboard"></div>
    <div style="margin-top:1rem;">
      <div class="hud-item" style="display:inline-block; margin: 0 1rem;">
        <div class="hud-label">Accuracy</div>
        <div class="hud-value" id="lesson-accuracy" style="color:var(--neon-green);">100%</div>
      </div>
      <div class="hud-item" style="display:inline-block; margin: 0 1rem;">
        <div class="hud-label">Progress</div>
        <div class="hud-value" id="lesson-progress-text" style="color:var(--neon-blue);">0/10</div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MYSTERY NARRATIVE SCREEN ==================== -->
<div id="screen-mystery" class="screen">
  <div class="lesson-screen">
    <div class="screen-title" id="mystery-title">üîÆ Mystery Unfolds...</div>
    <div class="mystery-narrative">
      <div class="mystery-text" id="mystery-text"></div>
      <div class="mystery-choice-prompt" id="mystery-choice-prompt"></div>
      <div class="mystery-typing-area" id="mystery-typing-area"></div>
    </div>
    <input type="text" class="hidden-input" id="mystery-hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <div style="margin-top:1rem;">
      <button class="btn btn-secondary" id="mystery-continue-btn" onclick="continueFromMystery()" style="display:none;">Continue to Next Lesson</button>
    </div>
  </div>
</div>

<!-- ==================== DAD BRIEFCASE GAME ==================== -->
<div id="screen-dad" class="screen">
  <div class="dad-screen">
    <div class="screen-title" style="margin-bottom:0.3rem;">üíº Briefcase Collector üíº</div>
    <div class="dad-money-counter" id="dad-money">$0.00</div>
    <div class="dad-briefcase-meter">
      <div class="dad-briefcase-fill" id="dad-briefcase-fill" style="width:0%"></div>
    </div>
    <div class="dance-score-hud" style="max-width:500px;">
      <div class="hud-item">
        <div class="hud-label">Briefcases</div>
        <div class="hud-value" id="dad-briefcases" style="color:var(--neon-yellow);">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Streak</div>
        <div class="hud-value streak" id="dad-streak">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">WPM</div>
        <div class="hud-value wpm" id="dad-wpm">0</div>
      </div>
    </div>
    <div class="spanish-hint" id="dad-hint-box" style="max-width:600px;">
      <div class="hint-spanish" id="dad-hint" style="font-size:1.2rem;"></div>
      <div class="hint-category" id="dad-category"></div>
    </div>
    <div class="typing-area" id="dad-typing-area" style="max-width:600px;" tabindex="0">
      <div class="prompt-text" id="dad-prompt-text"></div>
    </div>
    <input type="text" class="hidden-input" id="dad-hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <div class="dad-news-ticker">
      <div class="dad-news-ticker-label">BREAKING</div>
      <div class="dad-news-ticker-text" id="dad-ticker-text" style="left:100%;">
        Markets rally on strong earnings... Fed holds rates steady... Local attorney wins landmark case... Kumon enrollment up 200%...
      </div>
    </div>
  </div>
  <div class="dad-breaking-news" id="dad-breaking-news">
    <div style="font-family:'Fredoka One',cursive; color:var(--neon-pink); font-size:1.5rem;">‚ö° BREAKING NEWS ‚ö°</div>
    <div id="dad-breaking-text" style="margin:0.8rem 0; font-size:1rem; color:rgba(255,255,255,0.8);"></div>
    <div style="font-size:0.8rem; color:var(--neon-yellow);">Type it fast for 2x bonus!</div>
  </div>
</div>

<!-- ==================== ALICE BATTLE SCREEN ==================== -->
<div id="screen-alice" class="screen">
  <div class="alice-screen">
    <div class="screen-title" style="margin-bottom:0.2rem;">‚öîÔ∏è K-Pop Demon Hunters ‚öîÔ∏è</div>
    <div class="alice-wave-counter" id="alice-wave">Wave 1 / 3</div>
    <div class="alice-demon" id="alice-demon">üëæ</div>
    <div class="alice-hp-text" id="alice-hp-text">HP: 100 / 100</div>
    <div class="alice-hp-bar">
      <div class="alice-hp-fill" id="alice-hp-fill" style="width:100%"></div>
    </div>
    <div class="alice-prompt-display" id="alice-prompt-text"></div>
    <input type="text" class="hidden-input" id="alice-hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <div style="margin-top:0.5rem;">
      <div class="hud-item" style="display:inline-block; margin:0 1rem;">
        <div class="hud-label">Damage</div>
        <div class="hud-value" id="alice-damage" style="color:var(--neon-pink);">0</div>
      </div>
      <div class="hud-item" style="display:inline-block; margin:0 1rem;">
        <div class="hud-label">Combo</div>
        <div class="hud-value streak" id="alice-combo">0</div>
      </div>
    </div>
    <div class="keyboard" id="alice-keyboard" style="margin-top:1rem;"></div>
  </div>
</div>

<!-- ==================== ALICE PRIZE SCREEN ==================== -->
<div id="screen-alice-prize" class="screen">
  <div class="alice-prize-screen">
    <div class="alice-toy-reveal" id="alice-toy-emoji">üéÅ</div>
    <div class="screen-title" style="background:linear-gradient(135deg,var(--neon-pink),var(--neon-purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">
      Prize Unlocked!
    </div>
    <div id="alice-toy-name" style="font-family:'Fredoka One',cursive; font-size:1.5rem; color:var(--neon-yellow); margin:0.5rem 0;"></div>
    <div id="alice-toy-desc" style="color:rgba(255,255,255,0.5); margin-bottom:1.5rem;"></div>
    <div style="display:flex; gap:0.8rem; justify-content:center; flex-wrap:wrap;">
      <button class="btn btn-play" onclick="startAliceGame()">Fight More Demons!</button>
      <button class="btn btn-secondary" onclick="showScreen('screen-title')">Home</button>
    </div>
  </div>
</div>

<!-- ==================== COPPER YARD GRID SCREEN ==================== -->
<div id="screen-copper" class="screen">
  <div class="copper-screen">
    <div class="screen-title" style="margin-bottom:0.3rem;">üêï Find the Bone! ü¶¥</div>
    <div class="copper-round-info" id="copper-round">Round 1 of 3</div>
    <div class="copper-hint-display" id="copper-hint">Type the sniff prompt to start searching!</div>
    <div class="copper-sniff-prompt" id="copper-sniff-area">
      <div class="prompt-text" id="copper-prompt-text" style="font-size:1.2rem;"></div>
    </div>
    <input type="text" class="hidden-input" id="copper-hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <div class="yard-grid" id="yard-grid"></div>
    <div style="margin-top:1rem;">
      <div class="hud-item" style="display:inline-block; margin:0 1rem;">
        <div class="hud-label">Bones Found</div>
        <div class="hud-value" id="copper-bones" style="color:var(--neon-yellow);">0</div>
      </div>
      <div class="hud-item" style="display:inline-block; margin:0 1rem;">
        <div class="hud-label">Digs</div>
        <div class="hud-value" id="copper-digs" style="color:var(--neon-orange);">0</div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== RESULTS SCREEN ==================== -->
<div id="screen-results" class="screen">
  <div class="results-card">
    <div class="results-rank" id="results-rank">üèÜ</div>
    <div class="results-title" id="results-title">GG!</div>
    <div class="results-subtitle" id="results-subtitle"></div>

    <div class="star-rating" id="star-rating"></div>

    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val score" id="res-score">0</div>
        <div class="stat-label">Score</div>
      </div>
      <div class="stat-box">
        <div class="stat-val wpm" id="res-wpm">0</div>
        <div class="stat-label">WPM</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" style="color:var(--neon-green)" id="res-accuracy">0%</div>
        <div class="stat-label">Accuracy</div>
      </div>
      <div class="stat-box">
        <div class="stat-val streak" id="res-streak">0</div>
        <div class="stat-label">Best Streak</div>
      </div>
    </div>

    <div class="achievements" id="achievements"></div>

    <div class="spanish-learned" id="spanish-learned">
      <h3>Spanish Words Practiced</h3>
      <div class="word-list" id="words-learned"></div>
    </div>

    <div class="results-actions">
      <button class="btn btn-play" onclick="startGame(currentMode)">Play Again</button>
      <button class="btn btn-secondary" onclick="showModeSelect()">Change Mode</button>
      <button class="btn btn-secondary" onclick="showScreen('screen-title')">Home</button>
    </div>
  </div>
</div>

<script>
// ============================================================
//  ANIMATED CANVAS BACKGROUND
// ============================================================
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');
let orbs = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function createOrbs() {
  orbs = [];
  const colors = [
    { r: 255, g: 45, b: 149 },   // pink
    { r: 0, g: 212, b: 255 },    // blue
    { r: 176, g: 38, b: 255 },   // purple
    { r: 57, g: 255, b: 20 },    // green
    { r: 255, g: 110, b: 0 },    // orange
  ];
  for (let i = 0; i < 6; i++) {
    const c = colors[i % colors.length];
    orbs.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.4,
      vy: (Math.random() - 0.5) * 0.4,
      radius: 200 + Math.random() * 200,
      color: c,
      opacity: 0.03 + Math.random() * 0.04,
    });
  }
}
createOrbs();

function drawBackground() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw orbs
  for (const orb of orbs) {
    orb.x += orb.vx;
    orb.y += orb.vy;
    if (orb.x < -orb.radius) orb.x = canvas.width + orb.radius;
    if (orb.x > canvas.width + orb.radius) orb.x = -orb.radius;
    if (orb.y < -orb.radius) orb.y = canvas.height + orb.radius;
    if (orb.y > canvas.height + orb.radius) orb.y = -orb.radius;

    const gradient = ctx.createRadialGradient(orb.x, orb.y, 0, orb.x, orb.y, orb.radius);
    gradient.addColorStop(0, `rgba(${orb.color.r},${orb.color.g},${orb.color.b},${orb.opacity})`);
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.fillRect(orb.x - orb.radius, orb.y - orb.radius, orb.radius * 2, orb.radius * 2);
  }

  // Draw stars
  if (!drawBackground._stars) {
    drawBackground._stars = [];
    for (let i = 0; i < 80; i++) {
      drawBackground._stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 1.5,
        phase: Math.random() * Math.PI * 2,
        speed: 0.5 + Math.random() * 1.5,
      });
    }
  }
  const t = Date.now() / 1000;
  for (const star of drawBackground._stars) {
    const alpha = 0.2 + 0.3 * Math.sin(t * star.speed + star.phase);
    ctx.beginPath();
    ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
    ctx.fill();
  }

  requestAnimationFrame(drawBackground);
}
drawBackground();

// ============================================================
//  GAME DATA
// ============================================================
let currentPlayer = null;
let currentMode = null;
let gameState = {};

const VOCAB = {
  animals: [
    { es: "gato", en: "cat" }, { es: "perro", en: "dog" }, { es: "pajaro", en: "bird" },
    { es: "pez", en: "fish" }, { es: "caballo", en: "horse" }, { es: "mariposa", en: "butterfly" },
    { es: "tortuga", en: "turtle" }, { es: "conejo", en: "rabbit" }, { es: "tigre", en: "tiger" },
    { es: "lobo", en: "wolf" }, { es: "serpiente", en: "snake" }, { es: "oso", en: "bear" },
    { es: "mono", en: "monkey" }, { es: "ballena", en: "whale" }, { es: "aguila", en: "eagle" },
    { es: "delfin", en: "dolphin" }, { es: "leon", en: "lion" }, { es: "elefante", en: "elephant" },
  ],
  colors: [
    { es: "rojo", en: "red" }, { es: "azul", en: "blue" }, { es: "verde", en: "green" },
    { es: "amarillo", en: "yellow" }, { es: "morado", en: "purple" }, { es: "naranja", en: "orange" },
    { es: "blanco", en: "white" }, { es: "negro", en: "black" }, { es: "rosa", en: "pink" },
    { es: "dorado", en: "gold" }, { es: "plateado", en: "silver" }, { es: "gris", en: "gray" },
  ],
  food: [
    { es: "agua", en: "water" }, { es: "comida", en: "food" }, { es: "manzana", en: "apple" },
    { es: "arroz", en: "rice" }, { es: "pollo", en: "chicken" }, { es: "queso", en: "cheese" },
    { es: "pan", en: "bread" }, { es: "leche", en: "milk" }, { es: "helado", en: "ice cream" },
    { es: "fresa", en: "strawberry" }, { es: "platano", en: "banana" }, { es: "chocolate", en: "chocolate" },
    { es: "tacos", en: "tacos" }, { es: "pizza", en: "pizza" }, { es: "galleta", en: "cookie" },
  ],
  family: [
    { es: "familia", en: "family" }, { es: "mama", en: "mom" }, { es: "papa", en: "dad" },
    { es: "hermano", en: "brother" }, { es: "hermana", en: "sister" }, { es: "abuelo", en: "grandpa" },
    { es: "abuela", en: "grandma" }, { es: "amigo", en: "friend" }, { es: "hijo", en: "son" },
    { es: "hija", en: "daughter" }, { es: "primo", en: "cousin" }, { es: "tio", en: "uncle" },
  ],
  greetings: [
    { es: "hola", en: "hello" }, { es: "adios", en: "goodbye" }, { es: "gracias", en: "thank you" },
    { es: "por favor", en: "please" }, { es: "buenos dias", en: "good morning" },
    { es: "buenas noches", en: "good night" }, { es: "como estas", en: "how are you" },
    { es: "muy bien", en: "very good" }, { es: "de nada", en: "you're welcome" },
    { es: "lo siento", en: "I'm sorry" }, { es: "con permiso", en: "excuse me" },
  ],
  gaming: [
    { es: "juego", en: "game" }, { es: "ganar", en: "to win" }, { es: "perder", en: "to lose" },
    { es: "rapido", en: "fast" }, { es: "fuerte", en: "strong" }, { es: "equipo", en: "team" },
    { es: "victoria", en: "victory" }, { es: "estrella", en: "star" }, { es: "poder", en: "power" },
    { es: "nivel", en: "level" }, { es: "mundo", en: "world" }, { es: "batalla", en: "battle" },
    { es: "campeon", en: "champion" }, { es: "escudo", en: "shield" }, { es: "espada", en: "sword" },
  ],
  school: [
    { es: "escuela", en: "school" }, { es: "libro", en: "book" }, { es: "maestro", en: "teacher" },
    { es: "estudiante", en: "student" }, { es: "clase", en: "class" }, { es: "tarea", en: "homework" },
    { es: "examen", en: "exam" }, { es: "lapiz", en: "pencil" }, { es: "papel", en: "paper" },
    { es: "mochila", en: "backpack" }, { es: "matematicas", en: "math" }, { es: "ciencias", en: "science" },
  ],
  everyday: [
    { es: "casa", en: "house" }, { es: "carro", en: "car" }, { es: "grande", en: "big" },
    { es: "bonito", en: "pretty" }, { es: "feliz", en: "happy" }, { es: "triste", en: "sad" },
    { es: "tiempo", en: "time" }, { es: "dinero", en: "money" }, { es: "musica", en: "music" },
    { es: "baile", en: "dance" }, { es: "sol", en: "sun" }, { es: "luna", en: "moon" },
    { es: "lluvia", en: "rain" }, { es: "nieve", en: "snow" }, { es: "fuego", en: "fire" },
    { es: "cielo", en: "sky" }, { es: "tierra", en: "earth" }, { es: "rio", en: "river" },
  ]
};

const SPANGLISH = [
  { text: "that sunset was so bonito no cap", spanish: [{ es: "bonito", en: "pretty/beautiful" }] },
  { text: "my hermano just got a victory royale", spanish: [{ es: "hermano", en: "brother" }] },
  { text: "we need more agua its caliente outside", spanish: [{ es: "agua", en: "water" }, { es: "caliente", en: "hot" }] },
  { text: "this comida from abuela hits different", spanish: [{ es: "comida", en: "food" }, { es: "abuela", en: "grandma" }] },
  { text: "the gato is sleeping on my mochila again", spanish: [{ es: "gato", en: "cat" }, { es: "mochila", en: "backpack" }] },
  { text: "lets go to the playa this verano", spanish: [{ es: "playa", en: "beach" }, { es: "verano", en: "summer" }] },
  { text: "that musica at the fiesta was fire", spanish: [{ es: "musica", en: "music" }, { es: "fiesta", en: "party" }] },
  { text: "mi amigo said the pelicula was amazing", spanish: [{ es: "amigo", en: "friend" }, { es: "pelicula", en: "movie" }] },
  { text: "the estrella in the cielo look so cool tonight", spanish: [{ es: "estrella", en: "star" }, { es: "cielo", en: "sky" }] },
  { text: "the maestro said the examen is on viernes", spanish: [{ es: "maestro", en: "teacher" }, { es: "examen", en: "exam" }, { es: "viernes", en: "Friday" }] },
  { text: "that equipo played with so much corazon", spanish: [{ es: "equipo", en: "team" }, { es: "corazon", en: "heart" }] },
  { text: "my familia went to a restaurante for tacos", spanish: [{ es: "familia", en: "family" }, { es: "restaurante", en: "restaurant" }] },
  { text: "the perro ran rapido through the jardin", spanish: [{ es: "perro", en: "dog" }, { es: "rapido", en: "fast" }, { es: "jardin", en: "garden" }] },
  { text: "i need a nuevo telefono mine is so lento", spanish: [{ es: "nuevo", en: "new" }, { es: "telefono", en: "phone" }, { es: "lento", en: "slow" }] },
  { text: "she wore a vestido color rosa to the baile", spanish: [{ es: "vestido", en: "dress" }, { es: "rosa", en: "pink" }, { es: "baile", en: "dance" }] },
  { text: "the leon at the zoologico was durmiendo", spanish: [{ es: "leon", en: "lion" }, { es: "zoologico", en: "zoo" }, { es: "durmiendo", en: "sleeping" }] },
  { text: "vamos to get helado after escuela today", spanish: [{ es: "vamos", en: "let's go" }, { es: "helado", en: "ice cream" }, { es: "escuela", en: "school" }] },
  { text: "that diamante skin in the juego is so raro", spanish: [{ es: "diamante", en: "diamond" }, { es: "juego", en: "game" }, { es: "raro", en: "rare" }] },
  { text: "the mariposa in the jardin was azul and morado", spanish: [{ es: "mariposa", en: "butterfly" }, { es: "jardin", en: "garden" }, { es: "azul", en: "blue" }, { es: "morado", en: "purple" }] },
  { text: "we built a castillo in minecraft with fuego", spanish: [{ es: "castillo", en: "castle" }, { es: "fuego", en: "fire" }] },
  { text: "bro that was so chistoso i cant stop laughing", spanish: [{ es: "chistoso", en: "funny" }] },
  { text: "my primo got first lugar in the carrera", spanish: [{ es: "primo", en: "cousin" }, { es: "lugar", en: "place" }, { es: "carrera", en: "race" }] },
];

const PHRASES = [
  { text: "yo quiero jugar", en: "I want to play" },
  { text: "el gato es negro", en: "the cat is black" },
  { text: "me gusta la musica", en: "I like music" },
  { text: "donde esta la comida", en: "where is the food" },
  { text: "el sol esta brillando", en: "the sun is shining" },
  { text: "mi casa es grande", en: "my house is big" },
  { text: "el perro corre rapido", en: "the dog runs fast" },
  { text: "quiero agua por favor", en: "I want water please" },
  { text: "la luna es bonita", en: "the moon is pretty" },
  { text: "hoy es un buen dia", en: "today is a good day" },
  { text: "vamos a la playa", en: "let's go to the beach" },
  { text: "el libro es interesante", en: "the book is interesting" },
  { text: "mi hermana es muy feliz", en: "my sister is very happy" },
  { text: "tengo un gato y un perro", en: "I have a cat and a dog" },
  { text: "el cielo es azul hoy", en: "the sky is blue today" },
  { text: "me gusta el helado de fresa", en: "I like strawberry ice cream" },
  { text: "mi amigo es muy fuerte", en: "my friend is very strong" },
  { text: "la mariposa es de muchos colores", en: "the butterfly is many colors" },
  { text: "necesito hacer la tarea", en: "I need to do homework" },
  { text: "estoy aprendiendo espanol", en: "I am learning Spanish" },
];

const BOSS_SENTENCES = [
  { text: "mi familia y yo fuimos al parque y jugamos todo el dia", en: "my family and I went to the park and played all day" },
  { text: "el maestro nos dijo que el examen es muy importante", en: "the teacher told us the exam is very important" },
  { text: "quiero aprender a cocinar como mi abuela porque su comida es la mejor", en: "I want to learn to cook like my grandma because her food is the best" },
  { text: "mi hermano y yo construimos un castillo de arena en la playa", en: "my brother and I built a sandcastle at the beach" },
  { text: "la musica de la fiesta estaba tan buena que todos bailaron", en: "the party music was so good that everyone danced" },
  { text: "los animales del zoologico son muy grandes y bonitos", en: "the animals at the zoo are very big and pretty" },
  { text: "cuando llueve me gusta quedarme en casa y leer un libro", en: "when it rains I like to stay home and read a book" },
  { text: "mi color favorito es el azul como el color del cielo", en: "my favorite color is blue like the color of the sky" },
  { text: "el equipo gano el campeonato y todos estaban muy felices", en: "the team won the championship and everyone was very happy" },
  { text: "vamos a la tienda a comprar frutas y verduras frescas", en: "let's go to the store to buy fresh fruits and vegetables" },
];

const STORIES = [
  {
    title: "The Minecraft Aventura",
    lines: [
      { text: "hola amigos vamos a jugar", en: "hello friends let's play", hint: "The adventure begins..." },
      { text: "we spawned in a bosque oscuro", en: null, hint: "bosque oscuro = dark forest" },
      { text: "necesitamos madera y piedra", en: "we need wood and stone", hint: "Time to gather resources!" },
      { text: "cuidado there is a creeper verde", en: null, hint: "verde = green (classic creeper!)" },
      { text: "construimos una casa grande", en: "we built a big house", hint: "Base building time!" },
      { text: "the noche is coming rapido", en: null, hint: "noche = night, rapido = fast" },
      { text: "tenemos espadas y escudos", en: "we have swords and shields", hint: "Ready for battle!" },
      { text: "victoria the dragon is defeated", en: null, hint: "victoria = victory! GG!" },
    ]
  },
  {
    title: "La Gran Carrera Espacial",
    lines: [
      { text: "tres dos uno despegamos", en: "three two one we blast off", hint: "Liftoff!" },
      { text: "the nave espacial goes so rapido", en: null, hint: "nave espacial = spaceship" },
      { text: "las estrellas son muy brillantes", en: "the stars are very bright", hint: "So beautiful up here..." },
      { text: "we found a planeta nuevo y bonito", en: null, hint: "planeta nuevo = new planet" },
      { text: "hay agua y arboles verdes aqui", en: "there is water and green trees here", hint: "A habitable world!" },
      { text: "the alien said hola amigo welcome", en: null, hint: "Even aliens speak Spanglish!" },
      { text: "compartimos comida y musica", en: "we shared food and music", hint: "Universal language of friendship" },
      { text: "regresamos a la tierra como heroes", en: "we returned to earth as heroes", hint: "What a W!" },
    ]
  },
  {
    title: "El Torneo de Gaming",
    lines: [
      { text: "hoy es el gran dia del torneo", en: "today is the big tournament day", hint: "Game day!" },
      { text: "my equipo is looking muy fuerte", en: null, hint: "equipo = team, fuerte = strong" },
      { text: "practicamos todos los dias", en: "we practiced every day", hint: "That grind paid off!" },
      { text: "the first batalla was so intense", en: null, hint: "batalla = battle" },
      { text: "ganamos tres juegos seguidos", en: "we won three games in a row", hint: "On a streak!" },
      { text: "the final round mi corazon beat so rapido", en: null, hint: "corazon = heart" },
      { text: "somos los campeones del mundo", en: "we are the champions of the world", hint: "CHAMPIONS!" },
      { text: "celebramos con una gran fiesta", en: "we celebrated with a big party", hint: "Time to celebrate!" },
    ]
  }
];

// ============================================================
//  SPECIAL PROFILES
// ============================================================

// --- COPPER THE DOG (INT: 0 / Fallout garbled mode) ---
const COPPER_PROMPTS = [
  // Garbled dog thoughts
  { text: "bork bork bork bork bork", hint: "woof woof woof", category: "bork language" },
  { text: "wof wooof wroof bork yap", hint: "*tail wagging intensifies*", category: "advanced bork" },
  { text: "bnoe bnoe i smel a bnoe", hint: "BONE!! B O N E !!", category: "bnoe detection" },
  { text: "skirrel skirrel skirrel run", hint: "SQUIRREL!!! MUST. CHASE.", category: "threat assessment" },
  { text: "hooman giv treet pls pls pls", hint: "I deserve a treat right now", category: "negotiations" },
  { text: "cat cat cat cat bark bark", hint: "INTRUDER ALERT", category: "security patrol" },
  { text: "zzzz bork zzz bork zzzzzz", hint: "*dreaming of chasing rabbits*", category: "nap time" },
  { text: "wlak wlak go outsied pls", hint: "WALK?? DID YOU SAY WALK??", category: "w-a-l-k" },
  { text: "fech bal bal bal thro bal", hint: "throw the ball THROW IT", category: "ball operations" },
  { text: "snif snif snif butt snif", hint: "just saying hello", category: "social skills" },
  { text: "dig dig dig hol in yrad", hint: "making improvements to the yard", category: "landscaping" },
  { text: "chimken chimken i smel chimken", hint: "IS THAT CHICKEN??", category: "kitchen recon" },
  { text: "mud mud rol in mud hehe", hint: "bath time? never heard of it", category: "spa day" },
  { text: "mai hooman iz best hooman", hint: "*stares lovingly*", category: "feelings" },
  { text: "bely rub bely rub now pls", hint: "this is not a request", category: "demands" },
  { text: "car rid car rid hed out windo", hint: "EARS FLAPPING IN THE WIND", category: "transportation" },
  { text: "posmin iz here bark bark bark", hint: "RED ALERT!! MAILMAN!!", category: "home defense" },
  { text: "i eet shoo i eet ur shoo", hint: "it was delicious thank you", category: "fine dining" },
  { text: "thunderr scray hid undr bed", hint: "the sky is angry at me", category: "weather report" },
  { text: "sit sit i sit giv treet now", hint: "I did the thing. Pay up.", category: "contract law" },
  { text: "vakoom iz scaree monstr help", hint: "THE LOUD FLOOR MONSTER", category: "existential dread" },
  { text: "leesh leesh outsied go go go", hint: "OUTSIDE OUTSIDE OUTSIDE", category: "expedition prep" },
  { text: "i luv u i luv u i luv u", hint: "*entire body wagging*", category: "pure love" },
  { text: "goldun doodl iz best doodl", hint: "this is simply a fact", category: "science" },
  { text: "copr iz gud boi vry gud boi", hint: "the goodest boy actually", category: "self assessment" },
];

const COPPER_COMBOS = [
  { min: 3, text: "BORK! üêï", color: "var(--neon-orange)" },
  { min: 6, text: "GOOD BOY!! ü¶¥", color: "var(--neon-yellow)" },
  { min: 10, text: "ZOOMIES!!! üí®", color: "var(--neon-green)" },
  { min: 15, text: "TREAT TIME! üçñ", color: "var(--neon-blue)" },
  { min: 20, text: "BEST BOI!!! üêï‚Äçü¶∫", color: "var(--neon-purple)" },
  { min: 30, text: "LEGENDARY GOOD BOY! üëëüêï", color: "var(--neon-pink)" },
];

const COPPER_MASCOTS = {
  idle: 'üêï', typing: 'üê∂', streak: 'üêï‚Äçü¶∫', bigStreak: 'ü¶Æ', fire: 'üêæ',
  wrong: 'üêï', sad: 'üêï', perfect: 'ü¶¥', complete: 'üê∂', thinking: 'üêï'
};

// --- DAD (Brice - Managing Attorney) ---
const DAD_PROMPTS = [
  { text: "billable hours billable hours billable hours", hint: "the grind never stops", category: "attorney life" },
  { text: "per my last email as previously discussed", hint: "I ALREADY TOLD YOU THIS", category: "passive aggressive" },
  { text: "the retainer has been depleted please remit", hint: "pay up buttercup", category: "collections" },
  { text: "objection your honor that is hearsay", hint: "classic courtroom move", category: "litigation" },
  { text: "please see the attached invoice for services", hint: "ka-ching", category: "revenue" },
  { text: "the dow jones is up three hundred points", hint: "portfolio goes brrr", category: "markets" },
  { text: "pursuant to florida statute section seven four two", hint: "lawyering intensifies", category: "statutes" },
  { text: "have the kids finished their kumon packets yet", hint: "education is important", category: "parenting" },
  { text: "the kumon worksheets are on the kitchen table", hint: "no screen time until done", category: "kumon life" },
  { text: "compound interest is the eighth wonder of the world", hint: "- Albert Einstein (maybe)", category: "finance wisdom" },
  { text: "i need to review this contract by end of day", hint: "another day another doc", category: "deadlines" },
  { text: "the briefcase has the depositions in it", hint: "important briefcase stuff", category: "briefcase matters" },
  { text: "did you file the motion for summary judgment", hint: "paperwork never ends", category: "litigation" },
  { text: "breaking news the fed raised interest rates again", hint: "economy things", category: "news" },
  { text: "lets circle back on this in our next meeting", hint: "corporate speak activated", category: "buzzwords" },
  { text: "the stock portfolio is looking diversified", hint: "don't put eggs in one basket", category: "investments" },
  { text: "please complete kumon levels a through f by friday", hint: "dad means business", category: "kumon assignments" },
  { text: "this deposition transcript is two hundred pages", hint: "reading is fundamental", category: "discovery" },
  { text: "i need a new briefcase this one is wearing out", hint: "executive accessory crisis", category: "fashion" },
  { text: "the quarterly earnings report exceeded projections", hint: "stonks go up", category: "business news" },
  { text: "motion to compel discovery is hereby granted", hint: "legal victory", category: "courtroom wins" },
  { text: "time is money and money is billable hours", hint: "the attorney equation", category: "philosophy" },
  { text: "kids practice your typing then do your kumon", hint: "dad's daily orders", category: "household mgmt" },
  { text: "the market correction is a buying opportunity", hint: "buy the dip", category: "investment advice" },
  { text: "please hold all my calls i am in a deposition", hint: "do not disturb", category: "busy busy" },
];

const DAD_COMBOS = [
  { min: 3, text: "BILLABLE! üí∞", color: "var(--neon-green)" },
  { min: 6, text: "SUSTAINED! ‚öñÔ∏è", color: "var(--neon-yellow)" },
  { min: 10, text: "BRIEFCASE MODE! üíº", color: "var(--neon-blue)" },
  { min: 15, text: "PARTNER TRACK! üìà", color: "var(--neon-purple)" },
  { min: 20, text: "MANAGING PARTNER! üëî", color: "var(--neon-orange)" },
  { min: 30, text: "OBJECTION OVERRULED! ‚öñÔ∏èüëë", color: "var(--neon-pink)" },
];

const DAD_MASCOTS = {
  idle: 'üëî', typing: '‚å®Ô∏è', streak: 'üíº', bigStreak: 'üìà', fire: 'üí∞',
  wrong: 'üìâ', sad: 'üò§', perfect: '‚öñÔ∏è', complete: 'üèÜ', thinking: 'ü§î'
};

// --- MOM (Michelle - Reggaeton Queen) ---
const MOM_PROMPTS = [
  // Reggaeton / Latin pop lyrics and phrases
  { text: "dale dale dale no te detengas", hint: "go go go don't stop - Pitbull vibes", category: "reggaeton" },
  { text: "gasolina dame mas gasolina", hint: "Daddy Yankee classic!", category: "reggaeton legend" },
  { text: "despacito quiero respirar tu cuello despacito", hint: "Luis Fonsi - Despacito", category: "global hit" },
  { text: "yo perreo sola yo perreo sola", hint: "Bad Bunny - Yo Perreo Sola", category: "bad bunny" },
  { text: "vivir mi vida la la la la", hint: "Marc Anthony - Vivir Mi Vida", category: "salsa pop" },
  { text: "suavemente besame que yo quiero sentir tus labios", hint: "Elvis Crespo - Suavemente", category: "classic" },
  { text: "danza kuduro danza kuduro", hint: "Don Omar - throw it back!", category: "dance floor" },
  { text: "la bicicleta me lleva a tu casa", hint: "Shakira & Carlos Vives", category: "shakira" },
  { text: "oye mi canto no te vayas de mi lado", hint: "listen to my song", category: "reggaeton" },
  { text: "ella baila sola cuando suena la cancion", hint: "she dances alone when the song plays", category: "dance" },
  { text: "taki taki rumba suena el drum en la calle", hint: "DJ Snake - Taki Taki", category: "taki taki" },
  { text: "a ella le gusta la gasolina dame mas gasolina", hint: "DALE!!", category: "daddy yankee" },
  { text: "bonita bonita como las flores en mayo", hint: "pretty pretty like flowers in May", category: "romantic" },
  { text: "bailando yo la vi bailando ella me miro bailando", hint: "Enrique Iglesias - Bailando", category: "bailando" },
  { text: "la vida es un carnaval hay que vivir cantando", hint: "Celia Cruz - Life is a carnival!", category: "celia cruz" },
  { text: "azucar azucar azucar", hint: "AZUCAR!! - The Queen Celia Cruz", category: "iconic" },
  { text: "me porto bonito bonito pa ti", hint: "Bad Bunny & Chencho Corleone", category: "bad bunny" },
  { text: "shakira shakira las caderas no mienten", hint: "hips don't lie!", category: "shakira" },
  { text: "waka waka eh eh tsamina mina", hint: "Shakira - World Cup anthem!", category: "shakira" },
  { text: "dime donde estas corazon escondido", hint: "tell me where you are hidden heart", category: "romantic" },
  { text: "calma calma vamos a la playa pa curarte el alma", hint: "Pedro Capo - Calma", category: "island vibes" },
  { text: "la cintura la cintura todo el mundo a bailar", hint: "Alvaro Soler - La Cintura", category: "euro latin" },
  { text: "mi gente todo el mundo singing mi musica", hint: "J Balvin - Mi Gente", category: "j balvin" },
  { text: "felices los cuatro que nos quedemos juntos los cuatro", hint: "Maluma - Felices Los 4", category: "maluma" },
  { text: "una vaina loca loca loca una vaina loca", hint: "something crazy crazy crazy!", category: "fiesta" },
];

const MOM_COMBOS = [
  { min: 3, text: "DALE! üíÉ", color: "var(--neon-pink)" },
  { min: 6, text: "AZUCAR! üé∂", color: "var(--neon-yellow)" },
  { min: 10, text: "REGGAETON! üîä", color: "var(--neon-orange)" },
  { min: 15, text: "PERREO! üíÉüî•", color: "var(--neon-purple)" },
  { min: 20, text: "QUEEN! üëëüíÉ", color: "var(--neon-green)" },
  { min: 30, text: "CELIA CRUZ MODE! üëëüé§", color: "var(--neon-pink)" },
];

const MOM_MASCOTS = {
  idle: 'üíÉ', typing: 'üé§', streak: 'üé∂', bigStreak: 'üîä', fire: 'üéâ',
  wrong: 'üòÖ', sad: 'üò¢', perfect: 'üëë', complete: 'ü•≥', thinking: 'ü§î'
};

// --- ALICE (age 4 - K-Pop Demon Hunters / easy mode) ---
const ALICE_PROMPTS = [
  // Very easy - single letters and tiny words, demon hunter + K-pop theme
  { text: "a b c", hint: "you got this Alice!", category: "letters" },
  { text: "d e f", hint: "keep going!", category: "letters" },
  { text: "g h i", hint: "so cool!", category: "letters" },
  { text: "j k l", hint: "amazing!", category: "letters" },
  { text: "m n o", hint: "wow!", category: "letters" },
  { text: "p q r", hint: "you're a star!", category: "letters" },
  { text: "s t u", hint: "demon hunter in training!", category: "letters" },
  { text: "v w x", hint: "almost there!", category: "letters" },
  { text: "y z", hint: "you know ALL the letters!", category: "letters" },
  { text: "go go go", hint: "K-pop dance time!", category: "k-pop moves" },
  { text: "kick punch", hint: "demon hunter attack!", category: "demon hunter" },
  { text: "run fast", hint: "chase the demon!", category: "demon hunter" },
  { text: "cat dog", hint: "animal friends!", category: "easy words" },
  { text: "big bad", hint: "the big bad demon!", category: "demon hunter" },
  { text: "pop pop", hint: "K-pop! Pop pop!", category: "k-pop" },
  { text: "sing song", hint: "la la la la!", category: "k-pop" },
  { text: "hi bye", hint: "hello goodbye!", category: "easy words" },
  { text: "red sun", hint: "the red sun rises - battle time!", category: "demon hunter" },
  { text: "bad guy", hint: "the demon is the bad guy!", category: "demon hunter" },
  { text: "hit hit", hint: "pow! pow!", category: "demon hunter" },
  { text: "la la la", hint: "sing along!", category: "k-pop" },
  { text: "one two", hint: "counting!", category: "numbers" },
  { text: "up up up", hint: "jump up high!", category: "dance moves" },
  { text: "no no no", hint: "no demons allowed!", category: "demon hunter" },
  { text: "yay yay", hint: "we won!", category: "celebration" },
  { text: "ice fire", hint: "demon hunter powers!", category: "demon hunter" },
  { text: "star moon", hint: "K-pop stars shine bright!", category: "k-pop" },
  { text: "love love", hint: "K-pop is love!", category: "k-pop" },
  { text: "flip kick", hint: "cool demon hunter move!", category: "demon hunter" },
  { text: "win win", hint: "Alice always wins!", category: "victory" },
  { text: "bow wow", hint: "Copper says hi!", category: "friends" },
  { text: "pink bow", hint: "Alice's favorite!", category: "style" },
  { text: "dance now", hint: "K-pop dance break!", category: "k-pop dance" },
  { text: "zap zap", hint: "demon hunter lightning!", category: "demon hunter" },
  { text: "hug mom", hint: "hugs for Michelle!", category: "family" },
  { text: "hug dad", hint: "hugs for Brice!", category: "family" },
];

const ALICE_COMBOS = [
  { min: 3, text: "YAY! üéÄ", color: "var(--neon-pink)" },
  { min: 5, text: "K-POP! üíú", color: "var(--neon-purple)" },
  { min: 8, text: "DEMON SLAYER! ‚öîÔ∏è", color: "var(--neon-orange)" },
  { min: 12, text: "SUPERSTAR! üåü", color: "var(--neon-yellow)" },
  { min: 16, text: "IDOL HUNTER! üíú‚öîÔ∏è", color: "var(--neon-blue)" },
  { min: 20, text: "LEGENDARY ALICE! üëëüéÄ", color: "var(--neon-pink)" },
];

const ALICE_MASCOTS = {
  idle: 'üéÄ', typing: '‚≠ê', streak: 'üíú', bigStreak: '‚öîÔ∏è', fire: 'üî•',
  wrong: 'üôà', sad: 'ü•∫', perfect: 'üëë', complete: 'üéâ', thinking: 'ü§î'
};

// Helper: is this a special profile?
function isSpecialProfile() {
  return ['Copper', 'Dad', 'Mom', 'Alice'].includes(currentPlayer);
}

function getSpecialPrompts() {
  switch(currentPlayer) {
    case 'Copper': return shuffle(COPPER_PROMPTS).slice(0, 20);
    case 'Dad': return shuffle(DAD_PROMPTS).slice(0, 20);
    case 'Mom': return shuffle(MOM_PROMPTS).slice(0, 20);
    case 'Alice': return shuffle(ALICE_PROMPTS).slice(0, 25);
  }
}

function getSpecialCombos() {
  switch(currentPlayer) {
    case 'Copper': return COPPER_COMBOS;
    case 'Dad': return DAD_COMBOS;
    case 'Mom': return MOM_COMBOS;
    case 'Alice': return ALICE_COMBOS;
    default: return COMBO_MESSAGES;
  }
}

function getSpecialMascots() {
  switch(currentPlayer) {
    case 'Copper': return COPPER_MASCOTS;
    case 'Dad': return DAD_MASCOTS;
    case 'Mom': return MOM_MASCOTS;
    case 'Alice': return ALICE_MASCOTS;
    default: return MASCOT_FACES;
  }
}

function getResultTitlesForProfile() {
  switch(currentPlayer) {
    case 'Copper': return [
      { minWpm: 0, title: "Good Try Copper!", sub: "Who's a good boy? You are!", emoji: "üêï", stars: 1 },
      { minWpm: 5, title: "BORK BORK!", sub: "Copper typed with his paws!", emoji: "üêæ", stars: 2 },
      { minWpm: 10, title: "GOOD BOY!", sub: "Treats have been earned", emoji: "ü¶¥", stars: 3 },
      { minWpm: 15, title: "BEST BOI!", sub: "Copper is the smartest doodle", emoji: "üêï‚Äçü¶∫", stars: 4 },
      { minWpm: 20, title: "LEGENDARY DOODLE!", sub: "Golden doodle genius confirmed", emoji: "üëë", stars: 5 },
    ];
    case 'Dad': return [
      { minWpm: 0, title: "Billable Hours: Low", sub: "The partners are concerned", emoji: "üìâ", stars: 1 },
      { minWpm: 15, title: "Associate Level", sub: "Keep grinding counselor", emoji: "üìã", stars: 2 },
      { minWpm: 25, title: "Senior Associate!", sub: "The briefcase is getting heavier", emoji: "üíº", stars: 3 },
      { minWpm: 35, title: "Partner Track!", sub: "The corner office is in sight", emoji: "üìà", stars: 4 },
      { minWpm: 45, title: "Managing Partner!", sub: "Zoecklein Law salutes you", emoji: "‚öñÔ∏è", stars: 5 },
      { minWpm: 60, title: "SUPREME COURT!", sub: "All rise for the typing champion", emoji: "üëë", stars: 5 },
    ];
    case 'Mom': return [
      { minWpm: 0, title: "Calentando!", sub: "Warming up those dancing fingers", emoji: "üéµ", stars: 1 },
      { minWpm: 15, title: "DALE!", sub: "The rhythm is building!", emoji: "üíÉ", stars: 2 },
      { minWpm: 25, title: "REGGAETON FIRE!", sub: "Michelle is on fire!", emoji: "üî•", stars: 3 },
      { minWpm: 35, title: "AZUCAR!", sub: "Celia Cruz would be proud!", emoji: "üé§", stars: 4 },
      { minWpm: 45, title: "REINA DEL REGGAETON!", sub: "The queen of the dance floor!", emoji: "üëë", stars: 5 },
    ];
    case 'Alice': return [
      { minWpm: 0, title: "Great Job Alice!", sub: "You're learning so fast!", emoji: "üéÄ", stars: 2 },
      { minWpm: 3, title: "K-Pop Star!", sub: "Alice is a superstar!", emoji: "‚≠ê", stars: 3 },
      { minWpm: 6, title: "Demon Hunter!", sub: "No demon is safe from Alice!", emoji: "‚öîÔ∏è", stars: 4 },
      { minWpm: 10, title: "K-Pop Demon Queen!", sub: "The most powerful hunter ever!", emoji: "üëë", stars: 5 },
    ];
    default: return RESULT_TITLES;
  }
}

const COMBO_MESSAGES = [
  { min: 5, text: "Nice! üî•", color: "var(--neon-orange)" },
  { min: 10, text: "Sheeeesh! ü•∂", color: "var(--neon-blue)" },
  { min: 15, text: "No Cap! üíØ", color: "var(--neon-yellow)" },
  { min: 20, text: "Sigma Mode! üê∫", color: "var(--neon-purple)" },
  { min: 30, text: "GOATED! üêê", color: "var(--neon-green)" },
  { min: 40, text: "ABSOLUTELY BUSSIN! ü§Ø", color: "var(--neon-pink)" },
  { min: 50, text: "LEGENDARY! üëë", color: "var(--neon-yellow)" },
];

const RESULT_TITLES = [
  { minWpm: 0, title: "Keep Grinding!", sub: "Practice makes perfect, fam", emoji: "üí™", stars: 1 },
  { minWpm: 15, title: "Getting There!", sub: "Your fingers are warming up", emoji: "üå±", stars: 2 },
  { minWpm: 25, title: "Solid Run!", sub: "You're lowkey cracked at this", emoji: "üî•", stars: 3 },
  { minWpm: 35, title: "Sheeeesh!", sub: "Ice cold typing skills fr fr", emoji: "ü•∂", stars: 4 },
  { minWpm: 45, title: "GOATED!", sub: "You just unlocked sigma typing", emoji: "üêê", stars: 5 },
  { minWpm: 60, title: "LEGENDARY!", sub: "Bro you're the final boss of typing", emoji: "üëë", stars: 5 },
];

const MASCOT_FACES = {
  idle: 'üòä', typing: 'üòÑ', streak: 'üòé', bigStreak: 'ü§©', fire: 'üî•',
  wrong: 'üò¨', sad: 'üò¢', perfect: 'ü§Ø', complete: 'ü•≥', thinking: 'ü§î'
};

// ---- KEYBOARD LAYOUT ----
const KB_ROWS = [
  [
    { key: "`", finger: "finger-left-pinky" }, { key: "1", finger: "finger-left-pinky" },
    { key: "2", finger: "finger-left-ring" }, { key: "3", finger: "finger-left-middle" },
    { key: "4", finger: "finger-left-index" }, { key: "5", finger: "finger-left-index" },
    { key: "6", finger: "finger-right-index" }, { key: "7", finger: "finger-right-index" },
    { key: "8", finger: "finger-right-middle" }, { key: "9", finger: "finger-right-ring" },
    { key: "0", finger: "finger-right-pinky" }, { key: "-", finger: "finger-right-pinky" },
    { key: "=", finger: "finger-right-pinky" },
  ],
  [
    { key: "Q", finger: "finger-left-pinky" }, { key: "W", finger: "finger-left-ring" },
    { key: "E", finger: "finger-left-middle" }, { key: "R", finger: "finger-left-index" },
    { key: "T", finger: "finger-left-index" }, { key: "Y", finger: "finger-right-index" },
    { key: "U", finger: "finger-right-index" }, { key: "I", finger: "finger-right-middle" },
    { key: "O", finger: "finger-right-ring" }, { key: "P", finger: "finger-right-pinky" },
  ],
  [
    { key: "A", finger: "finger-left-pinky" }, { key: "S", finger: "finger-left-ring" },
    { key: "D", finger: "finger-left-middle" }, { key: "F", finger: "finger-left-index", home: true },
    { key: "G", finger: "finger-left-index" }, { key: "H", finger: "finger-right-index" },
    { key: "J", finger: "finger-right-index", home: true }, { key: "K", finger: "finger-right-middle" },
    { key: "L", finger: "finger-right-ring" }, { key: ";", finger: "finger-right-pinky" },
  ],
  [
    { key: "Z", finger: "finger-left-pinky" }, { key: "X", finger: "finger-left-ring" },
    { key: "C", finger: "finger-left-middle" }, { key: "V", finger: "finger-left-index" },
    { key: "B", finger: "finger-left-index" }, { key: "N", finger: "finger-right-index" },
    { key: "M", finger: "finger-right-index" }, { key: ",", finger: "finger-right-middle" },
    { key: ".", finger: "finger-right-ring" },
  ],
  [
    { key: "SPACE", finger: "finger-thumb", wide: "space" },
  ]
];

// ============================================================
//  AUDIO ENGINE - Music + Sound Effects
// ============================================================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let masterGain, sfxGain, musicGain;
let musicEnabled = true, sfxEnabled = true;
let masterVolume = 0.5;
let musicPlaying = false;
let musicNodes = [];

function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new AudioCtx();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = masterVolume;
    masterGain.connect(audioCtx.destination);
    sfxGain = audioCtx.createGain();
    sfxGain.gain.value = 1.0;
    sfxGain.connect(masterGain);
    musicGain = audioCtx.createGain();
    musicGain.gain.value = 0.35;
    musicGain.connect(masterGain);
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

// --- Volume / Mute Controls ---
function toggleMusic() {
  musicEnabled = !musicEnabled;
  const btn = document.getElementById('btn-music');
  btn.textContent = musicEnabled ? 'üéµ' : 'üö´';
  btn.classList.toggle('muted', !musicEnabled);
  if (musicEnabled && musicPlaying) {
    musicGain.gain.setTargetAtTime(0.35, audioCtx.currentTime, 0.1);
  } else {
    ensureAudio();
    musicGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
  }
}

function toggleSFX() {
  sfxEnabled = !sfxEnabled;
  const btn = document.getElementById('btn-sfx');
  btn.textContent = sfxEnabled ? 'üîä' : 'üîá';
  btn.classList.toggle('muted', !sfxEnabled);
}

function setVolume(val) {
  masterVolume = val / 100;
  if (masterGain) masterGain.gain.setTargetAtTime(masterVolume, audioCtx.currentTime, 0.05);
}

// --- Core tone player ---
function playTone(freq, duration, type = 'sine', vol = 0.06) {
  if (!sfxEnabled) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.setValueAtTime(vol, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  o.connect(g); g.connect(sfxGain);
  o.start(); o.stop(audioCtx.currentTime + duration);
}

// --- Noise generator for percussive sounds ---
function playNoise(duration, vol = 0.03) {
  if (!sfxEnabled) return;
  ensureAudio();
  const bufferSize = audioCtx.sampleRate * duration;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
  const source = audioCtx.createBufferSource();
  source.buffer = buffer;
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(vol, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  // Bandpass for click feel
  const filter = audioCtx.createBiquadFilter();
  filter.type = 'bandpass';
  filter.frequency.value = 4000;
  filter.Q.value = 1;
  source.connect(filter); filter.connect(g); g.connect(sfxGain);
  source.start(); source.stop(audioCtx.currentTime + duration);
}

// --- Enhanced Sound Effects ---
function sfxCorrect() {
  // Satisfying click + high tone
  playNoise(0.03, 0.025);
  playTone(1200, 0.05, 'sine', 0.035);
}

function sfxWrong() {
  // Buzzy error
  playTone(150, 0.1, 'sawtooth', 0.03);
  playTone(120, 0.15, 'square', 0.02);
  playNoise(0.06, 0.02);
}

function sfxCombo() {
  // Ascending arpeggio
  [660, 830, 990, 1320].forEach((f, i) =>
    setTimeout(() => playTone(f, 0.1, 'sine', 0.04), i * 50)
  );
}

function sfxLevelUp() {
  // Fanfare
  const notes = [523, 659, 784, 880, 1047, 1319];
  notes.forEach((f, i) => setTimeout(() => {
    playTone(f, 0.22, 'sine', 0.04);
    playTone(f * 1.5, 0.18, 'triangle', 0.02);
  }, i * 100));
  setTimeout(() => playNoise(0.15, 0.03), notes.length * 100);
}

function sfxComplete() {
  // Victory jingle
  const melody = [523, 523, 659, 784, 659, 784, 1047];
  melody.forEach((f, i) => setTimeout(() => {
    playTone(f, 0.2, 'triangle', 0.04);
    if (i >= 4) playTone(f * 0.5, 0.25, 'sine', 0.025);
  }, i * 120));
}

function sfxPerfect() {
  // Sparkly perfect sound
  const notes = [784, 988, 1175, 1319, 1568, 1760];
  notes.forEach((f, i) => setTimeout(() => {
    playTone(f, 0.12, 'sine', 0.03);
    playTone(f * 2, 0.08, 'sine', 0.015);
  }, i * 60));
}

function sfxClick() {
  // UI click
  playNoise(0.02, 0.02);
  playTone(800, 0.03, 'sine', 0.025);
}

function sfxMenuSelect() {
  // Deeper menu selection
  playTone(440, 0.06, 'sine', 0.03);
  setTimeout(() => playTone(660, 0.08, 'sine', 0.03), 50);
}

function sfxCountdown() {
  // Timer warning tick
  playTone(1000, 0.08, 'square', 0.03);
  playNoise(0.03, 0.02);
}

function sfxGameStart() {
  // Game start whoosh + chime
  const notes = [330, 440, 554, 660, 880];
  notes.forEach((f, i) => setTimeout(() => {
    playTone(f, 0.15, 'sine', 0.035);
  }, i * 70));
  setTimeout(() => playNoise(0.1, 0.025), 350);
}

// ============================================================
//  BACKGROUND MUSIC ENGINE - Genre-Aware Beat Machine
// ============================================================

// Chord progressions per genre
const MUSIC_GENRES = {
  default: {
    bpm: 115,
    chords: [
      [261.63, 329.63, 392.00],  // C major
      [220.00, 277.18, 329.63],  // A minor
      [349.23, 440.00, 523.25],  // F major
      [392.00, 493.88, 587.33],  // G major
    ],
    scale: [261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33, 659.25],
    style: 'synthwave',
  },
  reggaeton: {
    bpm: 95,
    chords: [
      [220.00, 277.18, 329.63],  // Am
      [349.23, 440.00, 523.25],  // F
      [261.63, 329.63, 392.00],  // C
      [392.00, 493.88, 587.33],  // G
    ],
    scale: [220.00, 261.63, 293.66, 329.63, 392.00, 440.00, 523.25],
    style: 'reggaeton',
  },
  battle: {
    bpm: 140,
    chords: [
      [220.00, 261.63, 329.63],  // Am
      [196.00, 246.94, 293.66],  // Gm-ish
      [233.08, 293.66, 349.23],  // Bb
      [261.63, 329.63, 392.00],  // C
    ],
    scale: [220.00, 261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 523.25],
    style: 'battle',
  },
  mystery: {
    bpm: 90,
    chords: [
      [220.00, 261.63, 329.63],  // Am
      [196.00, 233.08, 293.66],  // G
      [174.61, 220.00, 261.63],  // Fm
      [196.00, 246.94, 293.66],  // G
    ],
    scale: [220.00, 246.94, 261.63, 329.63, 349.23, 392.00, 440.00],
    style: 'mystery',
  },
  business: {
    bpm: 108,
    chords: [
      [261.63, 329.63, 392.00],  // C
      [293.66, 369.99, 440.00],  // Dm
      [220.00, 277.18, 329.63],  // Am
      [392.00, 493.88, 587.33],  // G
    ],
    scale: [261.63, 329.63, 392.00, 440.00, 493.88, 523.25, 587.33, 659.25],
    style: 'lofi',
  },
  copper: {
    bpm: 120,
    chords: [
      [293.66, 369.99, 440.00],  // D
      [329.63, 415.30, 493.88],  // E
      [220.00, 277.18, 329.63],  // A
      [220.00, 277.18, 329.63],  // A
    ],
    scale: [220.00, 246.94, 277.18, 329.63, 369.99, 440.00, 493.88],
    style: 'funk',
  },
};

let musicBeat = 0;
let musicInterval = null;
let currentPattern = 0;
let currentGenre = MUSIC_GENRES.default;
let BPM = 115;
let BEAT_MS = 60000 / BPM / 4;

function getGenreForPlayer() {
  switch (currentPlayer) {
    case 'Mom': return MUSIC_GENRES.reggaeton;
    case 'Alice': return MUSIC_GENRES.battle;
    case 'Bryson': case 'Angelina': return MUSIC_GENRES.mystery;
    case 'Dad': return MUSIC_GENRES.business;
    case 'Copper': return MUSIC_GENRES.copper;
    default: return MUSIC_GENRES.default;
  }
}

function startMusic() {
  ensureAudio();
  musicPlaying = true;
  musicBeat = 0;
  currentPattern = 0;
  currentGenre = getGenreForPlayer();
  BPM = currentGenre.bpm;
  BEAT_MS = 60000 / BPM / 4;

  if (musicInterval) clearInterval(musicInterval);
  musicInterval = setInterval(musicTick, BEAT_MS);

  if (musicEnabled) {
    musicGain.gain.setTargetAtTime(0.35, audioCtx.currentTime, 0.3);
  }
}

function stopMusic() {
  musicPlaying = false;
  if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
  if (musicGain) musicGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.3);
}

function musicNote(freq, duration, type = 'sine', vol = 0.04) {
  if (!musicEnabled) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.setValueAtTime(vol, audioCtx.currentTime);
  g.gain.setTargetAtTime(vol * 0.6, audioCtx.currentTime + duration * 0.2, duration * 0.15);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  o.connect(g); g.connect(musicGain);
  o.start(); o.stop(audioCtx.currentTime + duration);
}

// Filtered bass with sub-oscillator
function playBass(freq, duration, vol = 0.045) {
  if (!musicEnabled) return;
  // Sub oscillator
  const sub = audioCtx.createOscillator();
  sub.type = 'sine'; sub.frequency.value = freq;
  const subG = audioCtx.createGain();
  subG.gain.setValueAtTime(vol * 0.7, audioCtx.currentTime);
  subG.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  sub.connect(subG); subG.connect(musicGain);
  sub.start(); sub.stop(audioCtx.currentTime + duration);
  // Saw with filter
  const saw = audioCtx.createOscillator();
  saw.type = 'sawtooth'; saw.frequency.value = freq;
  const flt = audioCtx.createBiquadFilter();
  flt.type = 'lowpass'; flt.frequency.value = freq * 4; flt.Q.value = 2;
  flt.frequency.setValueAtTime(freq * 6, audioCtx.currentTime);
  flt.frequency.exponentialRampToValueAtTime(freq * 2, audioCtx.currentTime + duration * 0.5);
  const sawG = audioCtx.createGain();
  sawG.gain.setValueAtTime(vol * 0.5, audioCtx.currentTime);
  sawG.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  saw.connect(flt); flt.connect(sawG); sawG.connect(musicGain);
  saw.start(); saw.stop(audioCtx.currentTime + duration);
}

// Punchy kick drum with click transient
function playKick(vol = 0.1) {
  if (!musicEnabled) return;
  // Body
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.setValueAtTime(180, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(35, audioCtx.currentTime + 0.08);
  g.gain.setValueAtTime(vol, audioCtx.currentTime);
  g.gain.setValueAtTime(vol * 0.8, audioCtx.currentTime + 0.02);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
  o.connect(g); g.connect(musicGain);
  o.start(); o.stop(audioCtx.currentTime + 0.2);
  // Click transient
  const cl = audioCtx.createOscillator();
  cl.type = 'square'; cl.frequency.value = 3000;
  const cg = audioCtx.createGain();
  cg.gain.setValueAtTime(vol * 0.3, audioCtx.currentTime);
  cg.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.01);
  cl.connect(cg); cg.connect(musicGain);
  cl.start(); cl.stop(audioCtx.currentTime + 0.02);
}

// Snare with noise + tone
function playSnare(vol = 0.06) {
  if (!musicEnabled) return;
  // Noise body
  const bufLen = audioCtx.sampleRate * 0.12;
  const buf = audioCtx.createBuffer(1, bufLen, audioCtx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < bufLen; i++) d[i] = Math.random() * 2 - 1;
  const src = audioCtx.createBufferSource(); src.buffer = buf;
  const ng = audioCtx.createGain();
  ng.gain.setValueAtTime(vol, audioCtx.currentTime);
  ng.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.12);
  const bp = audioCtx.createBiquadFilter();
  bp.type = 'bandpass'; bp.frequency.value = 3000; bp.Q.value = 0.8;
  src.connect(bp); bp.connect(ng); ng.connect(musicGain);
  src.start(); src.stop(audioCtx.currentTime + 0.13);
  // Tone body
  const o = audioCtx.createOscillator();
  o.type = 'triangle'; o.frequency.value = 200;
  const og = audioCtx.createGain();
  og.gain.setValueAtTime(vol * 0.6, audioCtx.currentTime);
  og.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.06);
  o.connect(og); og.connect(musicGain);
  o.start(); o.stop(audioCtx.currentTime + 0.07);
}

// Clap (layered noise bursts)
function playClap(vol = 0.04) {
  if (!musicEnabled) return;
  for (let n = 0; n < 3; n++) {
    const delay = n * 0.008;
    const bufLen = audioCtx.sampleRate * 0.03;
    const buf = audioCtx.createBuffer(1, bufLen, audioCtx.sampleRate);
    const d = buf.getChannelData(0);
    for (let i = 0; i < bufLen; i++) d[i] = Math.random() * 2 - 1;
    const src = audioCtx.createBufferSource(); src.buffer = buf;
    const g = audioCtx.createGain();
    g.gain.setValueAtTime(vol, audioCtx.currentTime + delay);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + 0.08);
    const hp = audioCtx.createBiquadFilter();
    hp.type = 'highpass'; hp.frequency.value = 1200;
    src.connect(hp); hp.connect(g); g.connect(musicGain);
    src.start(audioCtx.currentTime + delay); src.stop(audioCtx.currentTime + delay + 0.1);
  }
}

// Hi-hat (closed and open)
function playHiHat(open = false, vol = 0.025) {
  if (!musicEnabled) return;
  const dur = open ? 0.12 : 0.04;
  const bufLen = audioCtx.sampleRate * dur;
  const buf = audioCtx.createBuffer(1, bufLen, audioCtx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < bufLen; i++) d[i] = Math.random() * 2 - 1;
  const src = audioCtx.createBufferSource(); src.buffer = buf;
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(vol, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
  const hp = audioCtx.createBiquadFilter();
  hp.type = 'highpass'; hp.frequency.value = open ? 6000 : 8000;
  const bp = audioCtx.createBiquadFilter();
  bp.type = 'peaking'; bp.frequency.value = 10000; bp.gain.value = 4;
  src.connect(hp); hp.connect(bp); bp.connect(g); g.connect(musicGain);
  src.start(); src.stop(audioCtx.currentTime + dur + 0.01);
}

// Warm pad chord
function playPad(freqs, duration, vol = 0.012) {
  if (!musicEnabled) return;
  freqs.forEach(f => {
    ['sine', 'triangle'].forEach((type, i) => {
      const o = audioCtx.createOscillator();
      o.type = type;
      o.frequency.value = f * (1 + (i * 0.003)); // slight detune for width
      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0, audioCtx.currentTime);
      g.gain.linearRampToValueAtTime(vol / (i + 1), audioCtx.currentTime + 0.1);
      g.gain.setValueAtTime(vol / (i + 1), audioCtx.currentTime + duration - 0.2);
      g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
      const flt = audioCtx.createBiquadFilter();
      flt.type = 'lowpass'; flt.frequency.value = 2000;
      o.connect(flt); flt.connect(g); g.connect(musicGain);
      o.start(); o.stop(audioCtx.currentTime + duration);
    });
  });
}

function musicTick() {
  if (!musicEnabled || !musicPlaying) { musicBeat++; return; }

  const G = currentGenre;
  const bar = Math.floor(musicBeat / 16) % 8;
  const beat = musicBeat % 16;
  const chordIdx = Math.floor(bar / 2) % G.chords.length;
  const chord = G.chords[chordIdx];
  const beatDur = BEAT_MS / 1000;
  const barDur = beatDur * 16;

  switch (G.style) {

  // --- REGGAETON (Mom) - dembow rhythm ---
  case 'reggaeton': {
    // Dembow kick pattern: 1, &2, 3, &4
    if (beat === 0 || beat === 3 || beat === 8 || beat === 11) playKick(0.1);
    // Snare on 2 and 4
    if (beat === 4 || beat === 12) playSnare(0.06);
    // Clap layered with snare
    if (beat === 4 || beat === 12) playClap(0.035);
    // Hi-hats: 8th notes with open hat on &
    if (beat % 2 === 0) playHiHat(false, 0.02);
    if (beat % 4 === 2) playHiHat(true, 0.015);
    // Reggaeton bass - bouncy
    if (beat === 0 || beat === 8) playBass(chord[0] / 2, beatDur * 3, 0.05);
    if (beat === 6 || beat === 14) playBass(chord[0] / 2 * 1.25, beatDur * 1.5, 0.035);
    // Stab chord on off-beats
    if (beat === 2 || beat === 10) {
      chord.forEach(f => musicNote(f, 0.08, 'sawtooth', 0.015));
    }
    // Pad
    if (beat === 0) playPad(chord, barDur, 0.008);
    // Melody lead
    const regMel = [0,null,2,null,4,null,3,null,2,null,null,1,null,0,null,null];
    if (regMel[beat] !== null && regMel[beat] !== undefined) {
      const f = G.scale[regMel[beat] % G.scale.length] * 2;
      musicNote(f, beatDur * 1.5, 'square', 0.015);
    }
    break;
  }

  // --- BATTLE (Alice) - intense, driving ---
  case 'battle': {
    // Four on the floor kick
    if (beat % 4 === 0) playKick(0.12);
    // Double kick hits
    if (beat === 6 || beat === 14) playKick(0.08);
    // Snare on 2 and 4
    if (beat === 4 || beat === 12) { playSnare(0.07); playClap(0.04); }
    // Hi-hats: every 16th for intensity
    playHiHat(false, beat % 4 === 0 ? 0.025 : 0.015);
    if (beat === 6 || beat === 14) playHiHat(true, 0.02);
    // Aggressive bass
    if (beat % 4 === 0) playBass(chord[0] / 2, beatDur * 3, 0.05);
    if (beat === 2 || beat === 10) playBass(chord[0] / 2 * 1.5, beatDur, 0.035);
    // Power chords (distorted feel)
    if (beat === 0) {
      chord.forEach(f => musicNote(f, barDur * 0.8, 'sawtooth', 0.012));
    }
    // Fast arpeggio
    if (beat % 2 === 0) {
      const f = G.scale[(beat / 2) % G.scale.length] * 2;
      musicNote(f, beatDur, 'square', 0.018);
    }
    break;
  }

  // --- MYSTERY (Bryson/Angelina) - ambient, eerie ---
  case 'mystery': {
    // Sparse kick
    if (beat === 0 || beat === 10) playKick(0.06);
    // Rimshot snare
    if (beat === 8) playSnare(0.035);
    // Gentle hi-hat
    if (beat % 4 === 0) playHiHat(false, 0.012);
    if (beat === 12) playHiHat(true, 0.01);
    // Deep ambient bass
    if (beat === 0) playBass(chord[0] / 4, barDur * 0.9, 0.04);
    // Lush pad
    if (beat === 0) playPad(chord, barDur, 0.015);
    // Mysterious melody - sparse and haunting
    const mysMel = [0,null,null,null,null,null,3,null,null,null,2,null,null,null,null,null];
    if (bar % 2 === 0 && mysMel[beat] !== null && mysMel[beat] !== undefined) {
      const f = G.scale[mysMel[beat] % G.scale.length] * 2;
      musicNote(f, beatDur * 4, 'sine', 0.02);
      musicNote(f * 2.01, beatDur * 3, 'sine', 0.006); // shimmer
    }
    // Ambient texture on some bars
    if (bar % 4 === 2 && beat === 0) {
      for (let i = 0; i < 3; i++) {
        const f = G.scale[Math.floor(Math.random() * G.scale.length)] * 4;
        musicNote(f, barDur * 0.5, 'sine', 0.004);
      }
    }
    break;
  }

  // --- LO-FI (Dad) - chill hop beats ---
  case 'lofi': {
    // Boom-bap kick
    if (beat === 0 || beat === 5 || beat === 8) playKick(0.08);
    // Snare
    if (beat === 4 || beat === 12) playSnare(0.045);
    // Swing hi-hats
    if (beat % 2 === 0) playHiHat(false, 0.018);
    if (beat === 6 || beat === 14) playHiHat(false, 0.012);
    if (beat === 3 || beat === 11) playHiHat(true, 0.01);
    // Warm bass
    if (beat === 0) playBass(chord[0] / 2, beatDur * 6, 0.04);
    if (beat === 10) playBass(chord[2] / 2, beatDur * 3, 0.03);
    // Rhodes-style chord stabs
    if (beat === 0 || beat === 6) {
      chord.forEach(f => musicNote(f, beatDur * 3, 'sine', 0.012));
      chord.forEach(f => musicNote(f * 2.005, beatDur * 3, 'sine', 0.004)); // detuned shimmer
    }
    // Pad
    if (beat === 0) playPad(chord, barDur, 0.006);
    // Chill melody
    const lofiMel = [0,null,null,2,null,null,3,null,null,null,4,null,null,2,null,null];
    if (lofiMel[beat] !== null && lofiMel[beat] !== undefined) {
      const f = G.scale[lofiMel[beat] % G.scale.length] * 2;
      musicNote(f, beatDur * 2, 'triangle', 0.015);
    }
    break;
  }

  // --- FUNK (Copper) - bouncy, playful ---
  case 'funk': {
    // Funky kick
    if (beat === 0 || beat === 4 || beat === 10) playKick(0.09);
    // Snare on 2 and 4
    if (beat === 4 || beat === 12) playSnare(0.05);
    // Clap accent
    if (beat === 12) playClap(0.03);
    // Shuffled hats
    if (beat % 2 === 0) playHiHat(false, 0.02);
    if (beat % 4 === 3) playHiHat(false, 0.012);
    if (beat === 7 || beat === 15) playHiHat(true, 0.015);
    // Slap bass
    if (beat === 0) playBass(chord[0] / 2, beatDur * 2, 0.05);
    if (beat === 6) playBass(chord[0] / 2 * 1.5, beatDur, 0.04);
    if (beat === 10) playBass(chord[2] / 2, beatDur * 2, 0.04);
    // Wah chord stabs
    if (beat === 2 || beat === 8 || beat === 14) {
      chord.forEach(f => musicNote(f, 0.1, 'sawtooth', 0.012));
    }
    // Bouncy melody
    const funkMel = [0,null,2,null,4,3,null,null,2,null,0,null,null,4,null,null];
    if (funkMel[beat] !== null && funkMel[beat] !== undefined) {
      const f = G.scale[funkMel[beat] % G.scale.length] * 2;
      musicNote(f, beatDur * 1.5, 'square', 0.016);
    }
    break;
  }

  // --- SYNTHWAVE (default) - retro driving ---
  default: {
    // Four on the floor
    if (beat % 4 === 0) playKick(0.09);
    // Snare on 2 and 4
    if (beat === 4 || beat === 12) playSnare(0.055);
    // Clap with snare
    if (beat === 4 || beat === 12) playClap(0.03);
    // Hi-hats: 8ths with open on &
    if (beat % 2 === 0) playHiHat(false, 0.02);
    if (beat % 4 === 2) playHiHat(true, 0.012);
    // Synth bass
    if (beat % 4 === 0) playBass(chord[0] / 2, beatDur * 3.5, 0.045);
    if (beat === 6 || beat === 14) playBass(chord[0] / 2 * 1.25, beatDur * 1.5, 0.03);
    // Pad
    if (beat === 0) playPad(chord, barDur, 0.01);
    // Arpeggio
    if (beat % 2 === 0 && (bar >= 2 && bar <= 3 || bar >= 6)) {
      const f = chord[beat % chord.length] * 2;
      musicNote(f, beatDur * 1.5, 'sawtooth', 0.012);
    }
    // Lead melody
    const swMel = [0,null,4,null,2,null,3,null,1,null,null,null,4,null,2,null];
    const mi = swMel[beat];
    if (mi !== null && mi !== undefined) {
      const f = G.scale[mi % G.scale.length] * 2;
      musicNote(f, beatDur * 2, 'square', 0.018);
      if (bar >= 4 && beat % 4 === 0) musicNote(f * 2, beatDur, 'sine', 0.006);
    }
    break;
  }
  }

  musicBeat++;
}

// ============================================================
//  UI HELPERS
// ============================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
  const screen = document.getElementById(id);
  screen.style.display = 'flex';
  // Trigger reflow before adding active class for animation
  void screen.offsetWidth;
  screen.classList.add('active');
  // Show/hide bone button
  document.getElementById('bone-btn').style.display =
    (currentPlayer === 'Copper' && id === 'screen-game') ? 'block' : 'none';
}

function selectPlayer(el) {
  document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  currentPlayer = el.dataset.player;
  document.getElementById('btn-start').disabled = false;
  sfxMenuSelect();
}

function showModeSelect() {
  // Special profiles skip mode select and go straight to their custom game
  if (isSpecialProfile()) {
    sfxClick();
    startGame('special');
    return;
  }
  const greetings = [
    `What's good ${currentPlayer}? Pick your challenge!`,
    `${currentPlayer} is in the building! Choose wisely:`,
    `Alright ${currentPlayer}, time to level up!`,
    `${currentPlayer} said bet, let's go!`,
  ];
  document.getElementById('mode-greeting').textContent = greetings[Math.floor(Math.random() * greetings.length)];
  sfxClick();
  showScreen('screen-modes');
}

// Build keyboard
function buildKeyboard() {
  const kb = document.getElementById('keyboard');
  kb.innerHTML = '';
  KB_ROWS.forEach(row => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'kb-row';
    row.forEach(k => {
      const keyDiv = document.createElement('div');
      keyDiv.className = `kb-key ${k.finger}${k.wide ? ' ' + k.wide : ''}${k.home ? ' home-row' : ''}`;
      keyDiv.textContent = k.key === 'SPACE' ? 'SPACE' : k.key;
      keyDiv.dataset.key = k.key;
      rowDiv.appendChild(keyDiv);
    });
    kb.appendChild(rowDiv);
  });
}
buildKeyboard();

function highlightKey(char, correct) {
  const keyStr = char === ' ' ? 'SPACE' : char.toUpperCase();
  const keyEl = document.querySelector(`.kb-key[data-key="${keyStr}"]`);
  if (!keyEl) return;
  keyEl.classList.add(correct ? 'pressed-correct' : 'pressed-wrong');
  setTimeout(() => keyEl.classList.remove('pressed-correct', 'pressed-wrong'), 180);
}

function showNextKey(char) {
  document.querySelectorAll('.kb-key').forEach(k => k.classList.remove('active'));
  const keyStr = char === ' ' ? 'SPACE' : char.toUpperCase();
  const keyEl = document.querySelector(`.kb-key[data-key="${keyStr}"]`);
  if (keyEl) keyEl.classList.add('active');
}

// Mascot
function setMascot(face, extraClass) {
  const box = document.getElementById('mascot-box');
  const faces = getSpecialMascots();
  box.textContent = faces[face] || faces.idle;
  box.className = 'mascot-box';
  if (extraClass) box.classList.add(extraClass);
}

// Particles
function spawnParticles(x, y, color, count = 8) {
  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const angle = (Math.PI * 2 / count) * i + Math.random() * 0.5;
    const dist = 30 + Math.random() * 50;
    const size = 3 + Math.random() * 5;
    p.style.cssText = `left:${x}px;top:${y}px;width:${size}px;height:${size}px;background:${color};--dx:${Math.cos(angle)*dist}px;--dy:${Math.sin(angle)*dist}px;`;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 800);
  }
}

// Confetti (enhanced with sway)
function launchConfetti() {
  const colors = ['#ff2d95','#00d4ff','#39ff14','#b026ff','#fff700','#ff6e00'];
  const shapes = ['50%', '3px', '0'];
  for (let i = 0; i < 80; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    const w = 5 + Math.random() * 10;
    const h = 5 + Math.random() * 10;
    c.style.cssText = `
      left:${Math.random()*100}%;top:-20px;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      width:${w}px;height:${h}px;
      border-radius:${shapes[Math.floor(Math.random()*shapes.length)]};
      --dur:${2.5+Math.random()*3}s;
      --sway:${(Math.random()-0.5)*80}px;
      animation-delay:${Math.random()*2}s;
      animation-duration:var(--dur);
    `;
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 6000);
  }
}

// Combo popup
function showCombo(text, color) {
  const popup = document.getElementById('combo-popup');
  popup.textContent = text;
  popup.style.color = color;
  popup.classList.remove('show');
  void popup.offsetWidth;
  popup.classList.add('show');
  sfxCombo();
}

// Float points
function showFloatPoints(points, x, y) {
  const el = document.createElement('div');
  el.className = 'float-points';
  el.textContent = `+${points}`;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1200);
}

// Perfect prompt flash
function showPerfect() {
  const el = document.createElement('div');
  el.className = 'perfect-flash';
  el.textContent = 'PERFECT! ‚ú®';
  document.body.appendChild(el);
  sfxPerfect();
  setTimeout(() => el.remove(), 1000);
}

// Screen shake
function screenShake() {
  const area = document.getElementById('typing-area');
  area.classList.remove('shake');
  void area.offsetWidth;
  area.classList.add('shake');
}

// Level up overlay
function showLevelUp(level) {
  const emojis = ['üéØ','‚ö°','üî•','üíé','üåü','üëë','üèÜ','üêê'];
  document.getElementById('lu-emoji').textContent = emojis[Math.min(level-1, emojis.length-1)];
  document.getElementById('lu-text').textContent = `LEVEL ${level}!`;
  const subs = [
    "You're just getting started!",
    "Warming up fr fr!",
    "Okay okay I see you!",
    "Straight bussin!",
    "No cap you're cracked!",
    "Built different!",
    "Main character energy!",
    "GOAT status unlocked!",
  ];
  document.getElementById('lu-sub').textContent = subs[Math.min(level-1, subs.length-1)];
  document.getElementById('level-up-overlay').classList.add('show');
  sfxLevelUp();
  launchConfetti();
  setTimeout(() => document.getElementById('level-up-overlay').classList.remove('show'), 2000);
}

// Progress dots
function updateProgressDots() {
  const container = document.getElementById('progress-dots');
  container.innerHTML = '';
  const total = gameState.prompts.length;
  // Cap visible dots
  const maxDots = Math.min(total, 30);
  for (let i = 0; i < maxDots; i++) {
    const dot = document.createElement('div');
    dot.className = 'progress-dot';
    if (i < gameState.currentIndex) dot.classList.add('done');
    else if (i === gameState.currentIndex) dot.classList.add('current');
    else dot.classList.add('upcoming');
    container.appendChild(dot);
  }
}

// ============================================================
//  GAME ENGINE
// ============================================================
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function getAllVocab() {
  return Object.entries(VOCAB).flatMap(([cat, words]) => words.map(w => ({ ...w, category: cat })));
}

function generatePrompts(mode) {
  switch(mode) {
    case 'vocab': {
      const all = shuffle(getAllVocab()).slice(0, 25);
      return all.map(w => ({
        text: w.es, hintSpanish: w.es, hintEnglish: w.en,
        hintCategory: w.category, spanishWords: [{ es: w.es, en: w.en }],
      }));
    }
    case 'phrases': {
      const all = shuffle(PHRASES).slice(0, 20);
      return all.map(p => ({
        text: p.text, hintSpanish: p.text, hintEnglish: p.en,
        hintCategory: 'Spanish phrase', spanishWords: p.text.split(' ').map(w => ({ es: w, en: '' })),
      }));
    }
    case 'spanglish': {
      const all = shuffle(SPANGLISH).slice(0, 20);
      return all.map(s => ({
        text: s.text, hintSpanish: s.spanish.map(w => w.es).join(', '),
        hintEnglish: s.spanish.map(w => `${w.es} = ${w.en}`).join(' | '),
        hintCategory: 'Spanglish remix', spanishWords: s.spanish,
      }));
    }
    case 'boss': {
      const all = shuffle(BOSS_SENTENCES).slice(0, 10);
      return all.map(s => ({
        text: s.text, hintSpanish: s.text.slice(0, 40) + '...',
        hintEnglish: s.en, hintCategory: 'Boss level - full Spanish!', spanishWords: [],
      }));
    }
    case 'race': {
      const vocabItems = shuffle(getAllVocab()).slice(0, 20).map(w => ({
        text: w.es, hintSpanish: w.es, hintEnglish: w.en,
        hintCategory: w.category, spanishWords: [{ es: w.es, en: w.en }],
      }));
      const phraseItems = shuffle(SPANGLISH).slice(0, 10).map(s => ({
        text: s.text, hintSpanish: s.spanish.map(w => w.es).join(', '),
        hintEnglish: s.spanish.map(w => `${w.es} = ${w.en}`).join(' | '),
        hintCategory: 'Spanglish remix', spanishWords: s.spanish,
      }));
      return shuffle([...vocabItems, ...phraseItems]);
    }
    case 'story': {
      const story = STORIES[Math.floor(Math.random() * STORIES.length)];
      return story.lines.map(line => ({
        text: line.text, hintSpanish: story.title,
        hintEnglish: line.en || line.hint, hintCategory: line.hint || 'Story mode', spanishWords: [],
      }));
    }
    case 'special': {
      const prompts = getSpecialPrompts();
      return prompts.map(p => ({
        text: p.text,
        hintSpanish: p.text,
        hintEnglish: p.hint || '',
        hintCategory: p.category || currentPlayer + ' mode',
        spanishWords: [],
      }));
    }
  }
}

function startGame(mode) {
  currentMode = mode;
  const prompts = generatePrompts(mode);

  gameState = {
    mode, prompts, currentIndex: 0, charIndex: 0,
    score: 0, streak: 0, bestStreak: 0,
    totalCorrect: 0, totalTyped: 0,
    promptCorrect: 0, promptTyped: 0,
    level: 1, xp: 0, xpNeeded: 200,
    startTime: null, wordsCompleted: 0,
    allSpanishWords: [], timerInterval: null,
    timeLeft: 60, raceActive: mode === 'race',
    charResults: {},
  };

  sfxGameStart();
  showScreen('screen-game');
  startMusic();
  setMascot('idle');
  updateHUD();
  updateProgressDots();

  document.getElementById('hud-timer-box').style.display = mode === 'race' ? 'block' : 'none';
  document.getElementById('click-hint').style.display = 'block';

  // Reset typing area glow
  const area = document.getElementById('typing-area');
  area.className = 'typing-area';

  loadPrompt();

  const input = document.getElementById('hidden-input');
  input.value = '';
  input.focus();
  document.getElementById('typing-area').onclick = () => { input.focus(); document.getElementById('click-hint').style.display = 'none'; };
}

function loadPrompt() {
  const prompt = gameState.prompts[gameState.currentIndex];
  if (!prompt) { endGame(); return; }

  gameState.charIndex = 0;
  gameState.promptCorrect = 0;
  gameState.promptTyped = 0;
  gameState.charResults = {};

  document.getElementById('hint-spanish').textContent = prompt.hintSpanish;
  document.getElementById('hint-english').textContent = prompt.hintEnglish;
  document.getElementById('hint-category').textContent = prompt.hintCategory;

  if (prompt.spanishWords) {
    prompt.spanishWords.forEach(w => {
      if (w.es && !gameState.allSpanishWords.find(x => x.es === w.es)) {
        gameState.allSpanishWords.push(w);
      }
    });
  }

  renderChars();
  updateProgressDots();

  if (prompt.text.length > 0) showNextKey(prompt.text[0]);
}

function renderChars() {
  const prompt = gameState.prompts[gameState.currentIndex];
  const container = document.getElementById('prompt-text');
  container.innerHTML = '';

  for (let i = 0; i < prompt.text.length; i++) {
    const span = document.createElement('span');
    span.className = 'char';
    if (prompt.text[i] === ' ') span.classList.add('space-char');
    span.textContent = prompt.text[i] === ' ' ? '\u00A0' : prompt.text[i];

    if (i < gameState.charIndex) {
      span.classList.add(gameState.charResults[i] ? 'correct' : 'incorrect');
    } else if (i === gameState.charIndex) {
      span.classList.add('current');
    } else {
      span.classList.add('upcoming');
    }
    container.appendChild(span);
  }
}

function updateHUD() {
  const scoreEl = document.getElementById('hud-score');
  const oldScore = scoreEl.textContent;
  scoreEl.textContent = gameState.score;
  if (scoreEl.textContent !== oldScore) {
    scoreEl.classList.remove('score-pop');
    void scoreEl.offsetWidth;
    scoreEl.classList.add('score-pop');
  }

  document.getElementById('hud-streak').textContent = gameState.streak > 0 ? `${gameState.streak} üî•` : '0';
  document.getElementById('hud-level').textContent = gameState.level;

  let wpm = 0;
  if (gameState.startTime) {
    const elapsed = (Date.now() - gameState.startTime) / 1000 / 60;
    if (elapsed > 0) wpm = Math.round(gameState.wordsCompleted / elapsed);
  }
  document.getElementById('hud-wpm').textContent = wpm;

  document.getElementById('xp-bar').style.width =
    Math.min(100, (gameState.xp / gameState.xpNeeded) * 100) + '%';

  if (gameState.raceActive) {
    document.getElementById('hud-timer').textContent = gameState.timeLeft;
  }

  // Typing area glow based on streak
  const area = document.getElementById('typing-area');
  area.classList.remove('streak-glow', 'big-streak-glow');
  if (gameState.streak >= 20) area.classList.add('big-streak-glow');
  else if (gameState.streak >= 10) area.classList.add('streak-glow');

  // Mascot reaction
  if (gameState.streak >= 20) setMascot('fire', 'fire');
  else if (gameState.streak >= 10) setMascot('bigStreak', 'happy');
  else if (gameState.streak >= 5) setMascot('streak', 'happy');
  else if (gameState.streak > 0) setMascot('typing', 'happy');
}

function addXP(amount) {
  gameState.xp += amount;
  while (gameState.xp >= gameState.xpNeeded) {
    gameState.xp -= gameState.xpNeeded;
    gameState.level++;
    gameState.xpNeeded = Math.floor(gameState.xpNeeded * 1.6);
    showLevelUp(gameState.level);
  }
}

// ---- INPUT HANDLING ----
document.getElementById('hidden-input').addEventListener('input', function(e) {
  document.getElementById('click-hint').style.display = 'none';

  if (!gameState.startTime) {
    gameState.startTime = Date.now();
    if (gameState.raceActive) startRaceTimer();
  }

  const typed = e.data;
  if (!typed) return;

  const prompt = gameState.prompts[gameState.currentIndex];
  if (!prompt) return;

  const expected = prompt.text[gameState.charIndex];
  if (expected === undefined) return;

  gameState.totalTyped++;
  gameState.promptTyped++;

  if (typed === expected) {
    gameState.charResults[gameState.charIndex] = true;
    gameState.totalCorrect++;
    gameState.promptCorrect++;
    gameState.streak++;
    if (gameState.streak > gameState.bestStreak) gameState.bestStreak = gameState.streak;

    let points = 10;
    const multiplier = Math.min(5, 1 + Math.floor(gameState.streak / 5));
    points *= multiplier;
    gameState.score += points;
    addXP(Math.floor(points / 5));

    sfxCorrect();
    highlightKey(expected, true);

    if (gameState.streak % 5 === 0 && gameState.streak > 0) {
      const rect = document.getElementById('typing-area').getBoundingClientRect();
      showFloatPoints(points, rect.left + Math.random() * rect.width * 0.8 + rect.width * 0.1, rect.top);
    }

    const combos = getSpecialCombos();
    for (let i = combos.length - 1; i >= 0; i--) {
      if (gameState.streak === combos[i].min) {
        showCombo(combos[i].text, combos[i].color);
        break;
      }
    }

    if (gameState.streak > 0 && gameState.streak % 10 === 0) {
      const rect = document.getElementById('hud-streak').getBoundingClientRect();
      spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, 'var(--neon-orange)', 12);
    }

    gameState.charIndex++;

    if (gameState.charIndex >= prompt.text.length) {
      completePrompt();
    } else {
      renderChars();
      showNextKey(prompt.text[gameState.charIndex]);
    }

  } else {
    gameState.charResults[gameState.charIndex] = false;
    gameState.streak = 0;
    sfxWrong();
    highlightKey(expected, false);
    screenShake();
    setMascot('wrong', 'sad');
    setTimeout(() => { if (gameState.streak === 0) setMascot('idle'); }, 600);

    gameState.charIndex++;
    if (gameState.charIndex >= prompt.text.length) {
      completePrompt();
    } else {
      renderChars();
      showNextKey(prompt.text[gameState.charIndex]);
    }
  }

  updateHUD();
  this.value = '';
});

document.getElementById('hidden-input').addEventListener('keydown', function(e) {
  if (e.key === 'Backspace') {
    e.preventDefault();
    if (gameState.charIndex > 0) {
      gameState.charIndex--;
      delete gameState.charResults[gameState.charIndex];
      renderChars();
      const prompt = gameState.prompts[gameState.currentIndex];
      showNextKey(prompt.text[gameState.charIndex]);
    }
  }
  if (e.key === 'Tab') e.preventDefault();
  if (e.key === 'Escape') {
    if (confirm('Quit this round?')) {
      if (gameState.timerInterval) clearInterval(gameState.timerInterval);
      stopMusic();
      showModeSelect();
    }
  }
});

function completePrompt() {
  const prompt = gameState.prompts[gameState.currentIndex];
  const words = prompt.text.split(' ').length;
  gameState.wordsCompleted += words;

  // Check for perfect prompt
  const isPerfect = gameState.promptCorrect === gameState.promptTyped && gameState.promptTyped > 0;
  if (isPerfect && prompt.text.length > 3) {
    gameState.score += 50;
    addXP(15);
    showPerfect();
    setMascot('perfect');
  } else {
    setMascot('complete');
  }

  setTimeout(() => { if (gameState.streak >= 5) setMascot('streak', 'happy'); else setMascot('idle'); }, 800);

  gameState.currentIndex++;

  if (gameState.currentIndex >= gameState.prompts.length && !gameState.raceActive) {
    endGame();
  } else if (gameState.raceActive && gameState.currentIndex >= gameState.prompts.length) {
    gameState.prompts = [...gameState.prompts, ...generatePrompts(currentMode)];
    loadPrompt();
  } else {
    loadPrompt();
  }
}

function startRaceTimer() {
  gameState.timerInterval = setInterval(() => {
    gameState.timeLeft--;
    const timerEl = document.getElementById('hud-timer');
    timerEl.textContent = gameState.timeLeft;
    if (gameState.timeLeft <= 10) {
      timerEl.style.color = gameState.timeLeft % 2 === 0 ? 'var(--neon-pink)' : '#fff';
      timerEl.style.transform = gameState.timeLeft % 2 === 0 ? 'scale(1.2)' : 'scale(1)';
      sfxCountdown();
    }
    if (gameState.timeLeft <= 0) {
      clearInterval(gameState.timerInterval);
      endGame();
    }
  }, 1000);
}

function endGame() {
  if (gameState.timerInterval) clearInterval(gameState.timerInterval);
  stopMusic();

  sfxComplete();
  setTimeout(() => launchConfetti(), 300);

  const elapsed = gameState.startTime ? (Date.now() - gameState.startTime) / 1000 / 60 : 1;
  const wpm = elapsed > 0 ? Math.round(gameState.wordsCompleted / elapsed) : 0;
  const accuracy = gameState.totalTyped > 0 ? Math.round((gameState.totalCorrect / gameState.totalTyped) * 100) : 0;

  let resultInfo = RESULT_TITLES[0];
  const resultTitles = getResultTitlesForProfile();
  for (const r of resultTitles) {
    if (wpm >= r.minWpm) resultInfo = r;
  }

  // Rank emoji
  document.getElementById('results-rank').textContent = resultInfo.emoji;
  document.getElementById('results-title').textContent = resultInfo.title;
  document.getElementById('results-subtitle').textContent = `${resultInfo.sub} ‚Äî ${currentPlayer}`;

  // Stars
  const starContainer = document.getElementById('star-rating');
  starContainer.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const star = document.createElement('span');
    star.className = `star ${i < resultInfo.stars ? 'filled' : 'empty'}`;
    star.textContent = i < resultInfo.stars ? '‚≠ê' : '‚òÜ';
    star.style.animationDelay = `${i * 0.15}s`;
    starContainer.appendChild(star);
  }

  // Animated stat counters
  animateCounter('res-score', gameState.score, 1000);
  animateCounter('res-wpm', wpm, 800);
  document.getElementById('res-accuracy').textContent = accuracy + '%';
  animateCounter('res-streak', gameState.bestStreak, 600);

  // Achievements
  const achieveContainer = document.getElementById('achievements');
  achieveContainer.innerHTML = '';
  const achievements = [];
  if (accuracy >= 100) achievements.push({ icon: 'üéØ', text: 'Perfect Accuracy!' });
  if (accuracy >= 90) achievements.push({ icon: 'üíé', text: '90%+ Accuracy' });
  if (gameState.bestStreak >= 20) achievements.push({ icon: 'üî•', text: 'Hot Streak (20+)' });
  if (gameState.bestStreak >= 10) achievements.push({ icon: '‚ö°', text: 'On Fire (10+ streak)' });
  if (wpm >= 40) achievements.push({ icon: 'üèéÔ∏è', text: 'Speed Demon' });
  if (wpm >= 25) achievements.push({ icon: 'üí®', text: 'Quick Fingers' });
  if (gameState.allSpanishWords.length >= 10) achievements.push({ icon: 'üá™üá∏', text: '10+ Spanish Words' });
  if (gameState.score >= 1000) achievements.push({ icon: 'üèÜ', text: '1000+ Points' });

  achievements.forEach((a, i) => {
    const el = document.createElement('div');
    el.className = 'achievement';
    el.textContent = `${a.icon} ${a.text}`;
    el.style.animationDelay = `${0.3 + i * 0.15}s`;
    achieveContainer.appendChild(el);
  });

  // Spanish words
  const wordsDiv = document.getElementById('words-learned');
  wordsDiv.innerHTML = '';
  const uniqueWords = gameState.allSpanishWords.slice(0, 20);
  if (uniqueWords.length > 0) {
    uniqueWords.forEach(w => {
      const chip = document.createElement('div');
      chip.className = 'word-chip';
      chip.innerHTML = `${w.es} <span>= ${w.en}</span>`;
      wordsDiv.appendChild(chip);
    });
    document.getElementById('spanish-learned').style.display = 'block';
  } else {
    document.getElementById('spanish-learned').style.display = 'none';
  }

  showScreen('screen-results');
  setTimeout(() => launchConfetti(), 1500);
}

// Animated counter
function animateCounter(elementId, target, duration) {
  const el = document.getElementById(elementId);
  const start = 0;
  const startTime = performance.now();

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    // Ease out cubic
    const eased = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.round(start + (target - start) * eased);
    if (progress < 1) requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
}

// Keep input focused
document.addEventListener('keydown', function(e) {
  const gameScreen = document.getElementById('screen-game');
  if (gameScreen.classList.contains('active')) {
    const input = document.getElementById('hidden-input');
    if (document.activeElement !== input) input.focus();
  }
});

// ============================================================
//  BONE BUTTON VISIBILITY
// ============================================================
// Show/hide bone button when Copper is playing on the game screen
const boneObserver = new MutationObserver(() => {
  const gameActive = document.getElementById('screen-game').classList.contains('active');
  document.getElementById('bone-btn').style.display =
    (currentPlayer === 'Copper' && gameActive) ? 'block' : 'none';
});
boneObserver.observe(document.getElementById('screen-game'), { attributes: true, attributeFilter: ['class'] });

// ============================================================
//  RIDDLE GAME - Copper's Bone Riddles -> Dad Prizes
// ============================================================
const RIDDLES = [
  {
    q: "What has four legs in the morning, two legs at noon, and three legs in the evening?",
    opts: ["A dog doing tricks", "A human (baby, adult, old with cane)", "A table that's falling apart", "A spider losing legs"],
    answer: 1,
    fun: "The Sphinx's riddle! Oedipus got it right, and so did you!"
  },
  {
    q: "I speak without a mouth and hear without ears. I have no body, but I come alive with wind. What am I?",
    opts: ["A ghost", "An echo", "A kite", "A whistle"],
    answer: 1,
    fun: "Echoooo! Echoooo! See what I did there?"
  },
  {
    q: "The more you take, the more you leave behind. What am I?",
    opts: ["Money", "Cookies", "Footsteps", "Naps"],
    answer: 2,
    fun: "Every step you take leaves one behind! Mind = blown."
  },
  {
    q: "What has keys but no locks, space but no room, and you can enter but can't go inside?",
    opts: ["A haunted house", "A keyboard", "A treasure map", "A puzzle box"],
    answer: 1,
    fun: "You're literally using one right now! Meta riddle."
  },
  {
    q: "I have cities, but no houses. I have mountains, but no trees. I have water, but no fish. What am I?",
    opts: ["A video game", "A map", "A dream", "A painting"],
    answer: 1,
    fun: "Maps have everything except the real thing!"
  },
  {
    q: "What gets wetter the more it dries?",
    opts: ["A sponge", "The sun", "A towel", "Ice cream"],
    answer: 2,
    fun: "A towel! It dries you off but gets soaked doing it."
  },
  {
    q: "What can travel around the world while staying in a corner?",
    opts: ["A spider", "Wi-Fi", "A stamp", "A passport"],
    answer: 2,
    fun: "A little stamp in the corner of an envelope goes everywhere!"
  },
  {
    q: "What has a head and a tail but no body?",
    opts: ["A snake", "A coin", "A ghost", "Copper the dog"],
    answer: 1,
    fun: "Heads or tails! Flip that coin!"
  },
  {
    q: "I'm tall when I'm young and short when I'm old. What am I?",
    opts: ["A person", "A candle", "A tree", "A giraffe"],
    answer: 1,
    fun: "A candle melts down as it burns! Deep stuff."
  },
  {
    q: "What can you break, even if you never pick it up or touch it?",
    opts: ["A world record", "A promise", "The silence", "All of the above"],
    answer: 3,
    fun: "You can break all of those! But 'all of the above' gets you the most points."
  },
  {
    q: "What has many teeth but cannot bite?",
    opts: ["A grandpa", "A comb", "A zipper", "A saw"],
    answer: 1,
    fun: "A comb has tons of teeth but zero bite force!"
  },
  {
    q: "What building has the most stories?",
    opts: ["The Empire State Building", "A library", "A skyscraper", "Hogwarts"],
    answer: 1,
    fun: "A library! Get it? Stories? Books? I'll see myself out."
  },
  {
    q: "If you drop me, I'm sure to crack. Give me a smile and I'll smile back. What am I?",
    opts: ["An egg", "A phone", "A mirror", "A cookie"],
    answer: 2,
    fun: "A mirror smiles back at you! Unless it's a fun house mirror."
  },
  {
    q: "What invention lets you look right through a wall?",
    opts: ["X-ray glasses", "A window", "A telescope", "Superman's eyes"],
    answer: 1,
    fun: "A window! The original wall hack."
  },
  {
    q: "What word is spelled incorrectly in every dictionary?",
    opts: ["Supercalifragilistic", "Incorrectly", "Pneumonia", "Rhythm"],
    answer: 1,
    fun: "The word 'incorrectly' is always spelled... incorrectly! Wait..."
  },
];

const DAD_PRIZES = [
  {
    emoji: "üç¶", title: "Ice Cream Trip!",
    desc: "Dad has to take the kids for ice cream! Any flavor, any toppings. Dad pays.",
    coupon: "ONE FREE ICE CREAM TRIP",
    code: "COPPER-BONE-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
    fine: "* Valid anytime. Dad cannot argue. Copper gets a puppuccino."
  },
  {
    emoji: "üéÆ", title: "Extra Screen Time!",
    desc: "30 minutes of bonus screen time, approved by Copper himself.",
    coupon: "30 MIN EXTRA SCREEN TIME",
    code: "BORK-BONUS-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
    fine: "* Must be redeemed same day. Dad cannot revoke. Kumon can wait."
  },
  {
    emoji: "üçï", title: "Pizza Night!",
    desc: "Dad orders pizza for dinner tonight. No healthy substitutions allowed.",
    coupon: "ONE PIZZA NIGHT - ANY TOPPINGS",
    code: "WOOF-PIZZA-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
    fine: "* Breadsticks mandatory. Dad tips the driver. Copper gets a crust."
  },
  {
    emoji: "üé¨", title: "Movie Night Pick!",
    desc: "You get to pick the family movie tonight. Dad can't say 'we already saw that.'",
    coupon: "PICK ANY MOVIE - NO VETOES",
    code: "DOODLE-FILM-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
    fine: "* Popcorn included. Dad makes it. Extra butter is non-negotiable."
  },
  {
    emoji: "üèñÔ∏è", title: "Park Day!",
    desc: "Dad takes the family to the park this weekend. Copper comes too!",
    coupon: "ONE GUARANTEED PARK TRIP",
    code: "FETCH-PARK-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
    fine: "* Rain check allowed but must be rescheduled within 7 days. Bring Copper's ball."
  },
  {
    emoji: "üò¥", title: "Late Bedtime!",
    desc: "Stay up 30 minutes past bedtime tonight! Dad-approved!",
    coupon: "30 MIN LATE BEDTIME PASS",
    code: "SNOOZE-NOPE-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
    fine: "* One-time use. Cannot be combined with other bedtime extensions. No whining tomorrow."
  },
  {
    emoji: "üßÅ", title: "Bakery Trip!",
    desc: "Dad takes you to pick out any treat from the bakery. One each!",
    coupon: "ONE BAKERY TREAT - YOUR CHOICE",
    code: "TREAT-PAWS-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
    fine: "* Cupcakes, cookies, cake pops ‚Äî anything goes. Dad also gets one (it's only fair)."
  },
  {
    emoji: "üé±", title: "Dad Does Your Chore!",
    desc: "Pick ONE chore and Dad has to do it for you today. Choose wisely.",
    coupon: "DAD DOES ONE CHORE FOR YOU",
    code: "LAZY-PAWS-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
    fine: "* Does not include 'all chores forever.' One chore. One day. Copper supervises."
  },
];

let riddleState = {};

function startRiddleGame() {
  // Pause the typing game music
  stopMusic();

  const selected = shuffle(RIDDLES).slice(0, 3);
  riddleState = {
    riddles: selected,
    current: 0,
    correct: 0,
    answered: false,
  };

  showScreen('screen-riddle');
  loadRiddle();
}

function loadRiddle() {
  const r = riddleState.riddles[riddleState.current];
  riddleState.answered = false;

  document.getElementById('riddle-progress').textContent =
    `Riddle ${riddleState.current + 1} of ${riddleState.riddles.length}`;
  document.getElementById('riddle-question').textContent = r.q;
  document.getElementById('riddle-feedback').textContent = '';
  document.getElementById('riddle-feedback').style.color = '';

  const icons = ['ü¶¥', 'üêæ', 'üéÅ'];
  document.getElementById('riddle-icon').textContent = icons[riddleState.current % icons.length];

  const optsContainer = document.getElementById('riddle-options');
  optsContainer.innerHTML = '';
  r.opts.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'riddle-opt';
    btn.textContent = opt;
    btn.onclick = () => answerRiddle(i);
    optsContainer.appendChild(btn);
  });
}

function answerRiddle(idx) {
  if (riddleState.answered) return;
  riddleState.answered = true;

  const r = riddleState.riddles[riddleState.current];
  const opts = document.querySelectorAll('.riddle-opt');
  const feedback = document.getElementById('riddle-feedback');

  // Disable all options
  opts.forEach(o => o.classList.add('disabled'));

  // Highlight correct/wrong
  opts[r.answer].classList.add('correct');

  if (idx === r.answer) {
    riddleState.correct++;
    feedback.textContent = "Correct! " + r.fun;
    feedback.style.color = 'var(--neon-green)';
    sfxPerfect();
  } else {
    opts[idx].classList.add('wrong');
    feedback.textContent = "Not quite! " + r.fun;
    feedback.style.color = 'var(--neon-orange)';
    sfxWrong();
  }

  // Auto advance after delay
  setTimeout(() => {
    riddleState.current++;
    if (riddleState.current >= riddleState.riddles.length) {
      showPrize();
    } else {
      loadRiddle();
    }
  }, 2500);
}

function showPrize() {
  // Pick a random prize
  const prize = DAD_PRIZES[Math.floor(Math.random() * DAD_PRIZES.length)];

  document.getElementById('prize-emoji').textContent = prize.emoji;
  document.getElementById('prize-desc').textContent = prize.desc;
  document.getElementById('prize-text').textContent = prize.coupon;
  document.getElementById('prize-code').textContent = prize.code;
  document.getElementById('prize-fine-print').textContent = prize.fine;

  // Title based on how many riddles they got right
  const titles = [
    "Participation Prize!",
    "Nice Try Prize!",
    "Great Job Prize!",
    "PERFECT SCORE PRIZE!",
  ];
  document.getElementById('prize-title').textContent = titles[riddleState.correct] || "Dad Prize Unlocked!";

  showScreen('screen-prize');
  launchConfetti();
  sfxComplete();
  setTimeout(() => launchConfetti(), 1500);
}

function closePrize() {
  // Return to Copper's game
  startGame('special');
}

// ============================================================
//  THEME SYSTEM
// ============================================================
function setTheme(theme) {
  if (theme) {
    document.body.setAttribute('data-theme', theme);
  } else {
    document.body.removeAttribute('data-theme');
  }
}

// Override showScreen with fade transition
const _origShowScreen = showScreen;
function showScreenFade(id) {
  const current = document.querySelector('.screen.active');
  if (current && current.id !== id) {
    current.classList.add('screen-fade-out');
    setTimeout(() => {
      current.classList.remove('screen-fade-out');
      _origShowScreen(id);
    }, 280);
  } else {
    _origShowScreen(id);
  }
}

// Override selectPlayer to route special profiles to their custom games
const _origShowModeSelect = showModeSelect;
showModeSelect = function() {
  sfxClick();
  switch (currentPlayer) {
    case 'Mom': setTheme('mom'); startMomGame(); return;
    case 'Dad': setTheme('dad'); startDadGame(); return;
    case 'Alice': setTheme('alice'); startAliceGame(); return;
    case 'Copper': setTheme('copper'); startCopperGame(); return;
    case 'Bryson':
    case 'Angelina':
      setTheme(null); startLessonGame(); return;
    default:
      setTheme(null); _origShowModeSelect();
  }
};

// ============================================================
//  MOM - DANCE FLOOR GAME üåπ
// ============================================================
const DANCE_ARROWS = ['left', 'up', 'down', 'right'];
const DANCE_KEYS = { ArrowLeft: 'left', ArrowUp: 'up', ArrowDown: 'down', ArrowRight: 'right' };
const DANCE_SYMBOLS = { left: '‚Üê', up: '‚Üë', down: '‚Üì', right: '‚Üí' };
const DANCE_LANES = { left: 0, up: 1, down: 2, right: 3 };

const REGGAETON_LYRICS = [
  "Dale dale dale no te detengas...",
  "Gasolina! Dame mas gasolina!",
  "Despacito... quiero respirar tu cuello...",
  "Yo perreo sola, yo perreo sola...",
  "Vivir mi vida, la la la la!",
  "Suavemente, besame...",
  "Danza kuduro, danza kuduro!",
  "Azucar! Azucar!",
  "Shakira, Shakira! Las caderas no mienten!",
  "Bailando, yo la vi bailando...",
  "Calma, calma, vamos a la playa...",
  "Mi gente! Todo el mundo!",
  "Taki taki rumba!",
  "Waka waka eh eh!",
  "Bonita, bonita como las flores...",
  "Me porto bonito, bonito pa ti...",
];

let danceState = null;

function startMomGame() {
  ensureAudio();
  danceState = {
    score: 0, combo: 0, maxCombo: 0,
    perfect: 0, good: 0, miss: 0,
    arrows: [], arrowId: 0,
    active: true, startTime: Date.now(),
    spawnInterval: null, animFrame: null,
    totalArrows: 60, spawned: 0,
    lyricsIdx: 0,
  };

  document.getElementById('dance-score').textContent = '0';
  document.getElementById('dance-combo').textContent = '0';
  document.getElementById('dance-rating').textContent = '‚Äî';
  document.getElementById('dance-lyrics').textContent = REGGAETON_LYRICS[0];

  // Clear old arrows
  document.querySelectorAll('.dance-arrow').forEach(a => a.remove());

  showScreen('screen-mom');
  startMusic();

  // Spawn arrows synced to beat
  const beatInterval = 60000 / BPM; // quarter note
  danceState.spawnInterval = setInterval(() => {
    if (!danceState.active) return;
    if (danceState.spawned >= danceState.totalArrows) {
      clearInterval(danceState.spawnInterval);
      setTimeout(() => endMomGame(), 3000);
      return;
    }
    spawnDanceArrow();
    danceState.spawned++;
    // Cycle lyrics
    if (danceState.spawned % 8 === 0) {
      danceState.lyricsIdx = (danceState.lyricsIdx + 1) % REGGAETON_LYRICS.length;
      document.getElementById('dance-lyrics').textContent = REGGAETON_LYRICS[danceState.lyricsIdx];
    }
  }, beatInterval);

  // Animation loop
  function animateDance() {
    if (!danceState || !danceState.active) return;
    const stage = document.getElementById('dance-stage');
    const stageH = stage.offsetHeight;
    const hitY = 60; // hit zone top position
    const now = Date.now();

    danceState.arrows.forEach(arrow => {
      if (arrow.hit) return;
      const elapsed = now - arrow.spawnTime;
      const travelTime = 2500; // ms to travel full stage
      const y = stageH + 30 - (elapsed / travelTime) * (stageH + 80);
      arrow.el.style.top = y + 'px';

      // Miss detection - arrow passed above hit zone
      if (y < hitY - 60 && !arrow.hit) {
        arrow.hit = true;
        arrow.el.classList.add('hit-miss');
        danceState.miss++;
        danceState.combo = 0;
        showDanceJudgment('Miss!', 'var(--neon-pink)');
        document.getElementById('dance-combo').textContent = '0';
        setTimeout(() => arrow.el.remove(), 300);
      }
    });

    danceState.arrows = danceState.arrows.filter(a => !a.hit || a.el.parentNode);
    danceState.animFrame = requestAnimationFrame(animateDance);
  }
  danceState.animFrame = requestAnimationFrame(animateDance);
}

function spawnDanceArrow() {
  const dir = DANCE_ARROWS[Math.floor(Math.random() * DANCE_ARROWS.length)];
  const stage = document.getElementById('dance-stage');
  const el = document.createElement('div');
  el.className = `dance-arrow ${dir}`;
  el.textContent = DANCE_SYMBOLS[dir];

  const laneX = 42 + DANCE_LANES[dir] * 72;
  el.style.left = laneX + 'px';
  el.style.top = (stage.offsetHeight + 30) + 'px';

  stage.appendChild(el);
  danceState.arrows.push({
    id: danceState.arrowId++, dir, el,
    spawnTime: Date.now(), hit: false,
  });
}

function showDanceJudgment(text, color) {
  const stage = document.getElementById('dance-stage');
  const j = document.createElement('div');
  j.className = 'dance-judgment';
  j.textContent = text;
  j.style.color = color;
  stage.appendChild(j);
  setTimeout(() => j.remove(), 600);
}

function spawnRoseParticles(x, y) {
  for (let i = 0; i < 6; i++) {
    const r = document.createElement('div');
    r.className = 'rose-particle';
    r.textContent = 'üåπ';
    const rx = (Math.random() - 0.5) * 120;
    const ry = -40 - Math.random() * 80;
    r.style.cssText = `left:${x}px;top:${y}px;--rx:${rx}px;--ry:${ry}px;`;
    document.body.appendChild(r);
    setTimeout(() => r.remove(), 1500);
  }
}

// Dance key handler
document.addEventListener('keydown', function(e) {
  if (!danceState || !danceState.active) return;
  const dir = DANCE_KEYS[e.key];
  if (!dir) return;
  e.preventDefault();

  const hitY = 60;
  const hitRange = 50;
  let bestArrow = null;
  let bestDist = Infinity;

  danceState.arrows.forEach(arrow => {
    if (arrow.hit || arrow.dir !== dir) return;
    const top = parseInt(arrow.el.style.top);
    const dist = Math.abs(top - hitY);
    if (dist < bestDist) { bestDist = dist; bestArrow = arrow; }
  });

  if (bestArrow && bestDist < hitRange * 2) {
    bestArrow.hit = true;
    let points = 0;
    if (bestDist < 15) {
      points = 100;
      danceState.perfect++;
      bestArrow.el.classList.add('hit-perfect');
      showDanceJudgment('Perfecto! ‚ú®', 'var(--neon-green)');
      sfxPerfect();
      const rect = bestArrow.el.getBoundingClientRect();
      spawnRoseParticles(rect.left + 25, rect.top + 25);
    } else if (bestDist < hitRange) {
      points = 50;
      danceState.good++;
      bestArrow.el.classList.add('hit-good');
      showDanceJudgment('Bueno!', 'var(--neon-yellow)');
      sfxCorrect();
    } else {
      points = 20;
      danceState.good++;
      bestArrow.el.classList.add('hit-good');
      showDanceJudgment('OK', 'var(--neon-blue)');
      sfxCorrect();
    }

    danceState.combo++;
    if (danceState.combo > danceState.maxCombo) danceState.maxCombo = danceState.combo;
    const multiplier = Math.min(4, 1 + Math.floor(danceState.combo / 5));
    points *= multiplier;
    danceState.score += points;

    document.getElementById('dance-score').textContent = danceState.score;
    document.getElementById('dance-combo').textContent = danceState.combo;

    // Rose particles on combos
    if (danceState.combo > 0 && danceState.combo % 5 === 0) {
      const stageRect = document.getElementById('dance-stage').getBoundingClientRect();
      spawnRoseParticles(stageRect.left + stageRect.width / 2, stageRect.top + 100);
    }

    setTimeout(() => bestArrow.el.remove(), 300);
  }
});

function endMomGame() {
  if (!danceState) return;
  danceState.active = false;
  if (danceState.spawnInterval) clearInterval(danceState.spawnInterval);
  if (danceState.animFrame) cancelAnimationFrame(danceState.animFrame);
  stopMusic();

  const total = danceState.perfect + danceState.good + danceState.miss;
  const pct = total > 0 ? ((danceState.perfect + danceState.good) / total * 100) : 0;
  let rating = 'Bronze';
  let stars = 2;
  if (pct >= 95 && danceState.perfect > danceState.good) { rating = 'Platinum'; stars = 5; }
  else if (pct >= 85) { rating = 'Gold'; stars = 4; }
  else if (pct >= 70) { rating = 'Silver'; stars = 3; }

  document.getElementById('dance-rating').textContent = rating;

  // Show results via main results screen
  const wpm = Math.round(danceState.score / 100);
  document.getElementById('results-rank').textContent = 'üåπ';
  document.getElementById('results-title').textContent = rating + ' Dance Rating!';
  document.getElementById('results-subtitle').textContent = `${danceState.perfect} Perfecto / ${danceState.good} Bueno / ${danceState.miss} Miss ‚Äî Mom`;

  const starContainer = document.getElementById('star-rating');
  starContainer.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const s = document.createElement('span');
    s.className = `star ${i < stars ? 'filled' : 'empty'}`;
    s.textContent = i < stars ? '‚≠ê' : '‚òÜ';
    s.style.animationDelay = `${i * 0.15}s`;
    starContainer.appendChild(s);
  }

  document.getElementById('res-score').textContent = danceState.score;
  document.getElementById('res-wpm').textContent = danceState.maxCombo;
  document.getElementById('res-accuracy').textContent = Math.round(pct) + '%';
  document.getElementById('res-streak').textContent = danceState.maxCombo;

  document.getElementById('achievements').innerHTML = '';
  document.getElementById('spanish-learned').style.display = 'none';

  sfxComplete();
  showScreen('screen-results');
  setTimeout(() => launchConfetti(), 300);
  setTimeout(() => launchConfetti(), 1500);
}

// ============================================================
//  BRYSON / ANGELINA - PROGRESSIVE LESSONS + MYSTERY
// ============================================================
const LESSON_DEFS = [
  { name: 'Home Row Basics', keys: 'asdf jkl;', desc: 'Home row keys: A S D F J K L ;' },
  { name: 'Home Row Practice', keys: 'asdf jkl;', desc: 'Get comfortable with home row' },
  { name: 'Home Row Speed', keys: 'asdf jkl;', desc: 'Speed up those home row fingers!' },
  { name: 'Adding Top Row', keys: 'asdf jkl; qwer uiop', desc: 'Now adding Q W E R U I O P' },
  { name: 'Top + Home Mix', keys: 'asdf jkl; qwer uiop', desc: 'Mix top row with home row' },
  { name: 'Two Row Master', keys: 'asdf jkl; qwer uiop', desc: 'Master two rows!' },
  { name: 'Full Keyboard', keys: 'asdf jkl; qwer uiop zxcv bnm', desc: 'All three rows!' },
  { name: 'Full Speed', keys: 'asdf jkl; qwer uiop zxcv bnm', desc: 'Type with all keys!' },
  { name: 'Keyboard Master', keys: 'asdf jkl; qwer uiop zxcv bnm', desc: 'Prove your mastery!' },
  { name: 'Spanish Vocabulary', keys: 'spanish', desc: 'Spanish words mixed in!' },
  { name: 'Spanish Sentences', keys: 'spanish', desc: 'Full Spanish phrases!' },
  { name: 'Bilingual Master', keys: 'spanish', desc: 'English + Spanish mix!' },
];

const MYSTERY_STORIES = [
  {
    text: "You stand at the entrance of a dark, ancient cave. Strange glowing symbols cover the walls. A faint breeze carries whispers from deep inside...",
    prompt: "Type your choice:",
    choices: [
      { word: "ENTER", next: "You step inside. The symbols glow brighter as you pass, revealing a hidden passage to the LEFT and a staircase going DOWN." },
      { word: "SEARCH", next: "You search around the entrance and find an old map scratched into the rock. It shows a treasure deep within!" },
      { word: "LISTEN", next: "You listen carefully. The whispers seem to say 'follow the light...' A golden glow appears ahead." },
    ]
  },
  {
    text: "Deep in the enchanted forest, you find a crossroads. A wise owl watches from above. Three paths stretch before you: one covered in flowers, one shrouded in mist, and one lit by fireflies.",
    prompt: "Which path? Type your choice:",
    choices: [
      { word: "FLOWERS", next: "The flower path leads to a garden where a friendly fairy offers you a magic key! 'This opens the treasure room,' she says." },
      { word: "MIST", next: "Through the mist you find a sleeping dragon guarding a chest. Maybe you can sneak past..." },
      { word: "FIREFLIES", next: "The fireflies guide you to a hidden waterfall. Behind it, a secret door with a golden lock!" },
    ]
  },
  {
    text: "You've found the treasure room! But there are three chests: one gold, one silver, and one wooden. The inscription reads: 'Only one holds the real treasure. Choose wisely!'",
    prompt: "Which chest? Type your choice:",
    choices: [
      { word: "GOLD", next: "The gold chest opens to reveal... a mirror! It shows your reflection and reads: 'The real treasure is knowledge!' You've leveled up!" },
      { word: "SILVER", next: "The silver chest contains a glowing crystal that hums with energy. It grants you the power of fast typing!" },
      { word: "WOODEN", next: "The simple wooden chest holds a beautiful journal full of stories from ancient explorers. Wisdom is the greatest treasure!" },
    ]
  },
];

let lessonState = null;

function getLessonProgress(player) {
  try {
    const data = JSON.parse(localStorage.getItem(`typingFiesta_lessons_${player}`) || '{}');
    return { currentLesson: data.currentLesson || 1, ...data };
  } catch { return { currentLesson: 1 }; }
}

function saveLessonProgress(player, lesson) {
  const data = getLessonProgress(player);
  data.currentLesson = Math.max(data.currentLesson, lesson);
  localStorage.setItem(`typingFiesta_lessons_${player}`, JSON.stringify(data));
}

function generateLessonPrompts(lessonNum) {
  const def = LESSON_DEFS[Math.min(lessonNum - 1, LESSON_DEFS.length - 1)];
  if (def.keys === 'spanish') {
    // Spanish lessons use vocab
    const words = shuffle(getAllVocab()).slice(0, 12);
    return words.map(w => w.es);
  }
  const chars = def.keys.replace(/\s/g, '');
  const prompts = [];
  for (let i = 0; i < 12; i++) {
    let word = '';
    const len = 3 + Math.floor(Math.random() * 4);
    for (let j = 0; j < len; j++) {
      word += chars[Math.floor(Math.random() * chars.length)];
    }
    prompts.push(word);
  }
  return prompts;
}

function startLessonGame() {
  const progress = getLessonProgress(currentPlayer);
  const lessonNum = progress.currentLesson;
  const def = LESSON_DEFS[Math.min(lessonNum - 1, LESSON_DEFS.length - 1)];
  const prompts = generateLessonPrompts(lessonNum);

  lessonState = {
    player: currentPlayer, lessonNum, prompts,
    currentIndex: 0, charIndex: 0,
    totalCorrect: 0, totalTyped: 0,
    charResults: {},
    completed: false,
  };

  document.getElementById('lesson-title').textContent = `Lesson ${lessonNum}: ${def.name}`;
  document.getElementById('lesson-badge').textContent = def.desc;
  document.getElementById('lesson-progress-fill').style.width =
    ((lessonNum - 1) / LESSON_DEFS.length * 100) + '%';
  document.getElementById('lesson-accuracy').textContent = '100%';
  document.getElementById('lesson-progress-text').textContent = `0/${prompts.length}`;

  showScreen('screen-lesson');
  ensureAudio();
  startMusic();
  loadLessonPrompt();

  const input = document.getElementById('lesson-hidden-input');
  input.value = '';
  input.focus();
  document.getElementById('lesson-typing-area').onclick = () => input.focus();

  // Spawn mystery particles for Bryson/Angelina
  spawnMysteryParticles();
}

function loadLessonPrompt() {
  if (!lessonState || lessonState.currentIndex >= lessonState.prompts.length) {
    endLesson();
    return;
  }
  lessonState.charIndex = 0;
  lessonState.charResults = {};
  renderLessonChars();
}

function renderLessonChars() {
  const text = lessonState.prompts[lessonState.currentIndex];
  const container = document.getElementById('lesson-prompt-text');
  container.innerHTML = '';
  for (let i = 0; i < text.length; i++) {
    const span = document.createElement('span');
    span.className = 'char';
    if (text[i] === ' ') span.classList.add('space-char');
    span.textContent = text[i] === ' ' ? '\u00A0' : text[i];
    if (i < lessonState.charIndex) {
      span.classList.add(lessonState.charResults[i] ? 'correct' : 'incorrect');
    } else if (i === lessonState.charIndex) {
      span.classList.add('current');
    } else {
      span.classList.add('upcoming');
    }
    container.appendChild(span);
  }
}

document.getElementById('lesson-hidden-input').addEventListener('input', function(e) {
  if (!lessonState || lessonState.completed) return;
  const typed = e.data;
  if (!typed) return;
  const text = lessonState.prompts[lessonState.currentIndex];
  const expected = text[lessonState.charIndex];
  if (expected === undefined) return;

  lessonState.totalTyped++;
  if (typed === expected) {
    lessonState.charResults[lessonState.charIndex] = true;
    lessonState.totalCorrect++;
    sfxCorrect();
  } else {
    lessonState.charResults[lessonState.charIndex] = false;
    sfxWrong();
  }
  lessonState.charIndex++;

  if (lessonState.charIndex >= text.length) {
    lessonState.currentIndex++;
    document.getElementById('lesson-progress-text').textContent =
      `${lessonState.currentIndex}/${lessonState.prompts.length}`;
    loadLessonPrompt();
  } else {
    renderLessonChars();
  }

  const acc = lessonState.totalTyped > 0
    ? Math.round(lessonState.totalCorrect / lessonState.totalTyped * 100) : 100;
  document.getElementById('lesson-accuracy').textContent = acc + '%';
  this.value = '';
});

document.getElementById('lesson-hidden-input').addEventListener('keydown', function(e) {
  if (e.key === 'Backspace') {
    e.preventDefault();
    if (lessonState && lessonState.charIndex > 0) {
      lessonState.charIndex--;
      delete lessonState.charResults[lessonState.charIndex];
      renderLessonChars();
    }
  }
  if (e.key === 'Escape') {
    stopMusic();
    clearMysteryParticles();
    showScreen('screen-title');
  }
});

function endLesson() {
  lessonState.completed = true;
  stopMusic();
  const acc = lessonState.totalTyped > 0
    ? Math.round(lessonState.totalCorrect / lessonState.totalTyped * 100) : 0;

  if (acc >= 90) {
    saveLessonProgress(lessonState.player, lessonState.lessonNum + 1);
    sfxLevelUp();
    // Show mystery narrative between lessons
    showMysteryNarrative();
  } else {
    sfxComplete();
    // Didn't pass - show results and let them retry
    document.getElementById('results-rank').textContent = 'üìù';
    document.getElementById('results-title').textContent = 'Keep Practicing!';
    document.getElementById('results-subtitle').textContent = `Need 90%+ to advance. You got ${acc}% ‚Äî ${currentPlayer}`;
    const starContainer = document.getElementById('star-rating');
    starContainer.innerHTML = '';
    for (let i = 0; i < 5; i++) {
      const s = document.createElement('span');
      s.className = `star ${i < 2 ? 'filled' : 'empty'}`;
      s.textContent = i < 2 ? '‚≠ê' : '‚òÜ';
      s.style.animationDelay = `${i * 0.15}s`;
      starContainer.appendChild(s);
    }
    document.getElementById('res-score').textContent = acc + '%';
    document.getElementById('res-wpm').textContent = '‚Äî';
    document.getElementById('res-accuracy').textContent = acc + '%';
    document.getElementById('res-streak').textContent = '‚Äî';
    document.getElementById('achievements').innerHTML = '';
    document.getElementById('spanish-learned').style.display = 'none';
    clearMysteryParticles();
    showScreen('screen-results');
  }
}

let mysteryParticleEls = [];
function spawnMysteryParticles() {
  clearMysteryParticles();
  for (let i = 0; i < 8; i++) {
    const p = document.createElement('div');
    p.className = 'mystery-particle';
    p.textContent = '‚ùì';
    p.style.left = (Math.random() * 90 + 5) + '%';
    p.style.top = (Math.random() * 80 + 10) + '%';
    p.style.animationDelay = (Math.random() * 5) + 's';
    document.body.appendChild(p);
    mysteryParticleEls.push(p);
  }
}

function clearMysteryParticles() {
  mysteryParticleEls.forEach(p => p.remove());
  mysteryParticleEls = [];
}

let mysteryState = null;

function showMysteryNarrative() {
  const story = MYSTERY_STORIES[Math.floor(Math.random() * MYSTERY_STORIES.length)];
  mysteryState = {
    story, choiceMade: false, typed: '',
    choices: story.choices,
  };

  document.getElementById('mystery-text').textContent = story.text;
  document.getElementById('mystery-choice-prompt').textContent =
    story.prompt + ' ' + story.choices.map(c => c.word).join(' / ');
  document.getElementById('mystery-typing-area').textContent = '';
  document.getElementById('mystery-continue-btn').style.display = 'none';

  showScreen('screen-mystery');
  const input = document.getElementById('mystery-hidden-input');
  input.value = '';
  input.focus();
}

document.getElementById('mystery-hidden-input').addEventListener('input', function(e) {
  if (!mysteryState || mysteryState.choiceMade) return;
  const typed = e.data;
  if (!typed) return;
  mysteryState.typed += typed.toUpperCase();
  document.getElementById('mystery-typing-area').textContent = mysteryState.typed;

  // Check if any choice matches
  for (const choice of mysteryState.choices) {
    if (mysteryState.typed === choice.word) {
      mysteryState.choiceMade = true;
      sfxPerfect();
      document.getElementById('mystery-text').textContent = choice.next;
      document.getElementById('mystery-choice-prompt').textContent = '';
      document.getElementById('mystery-typing-area').textContent = '‚ú® ' + choice.word + ' ‚ú®';
      document.getElementById('mystery-continue-btn').style.display = 'inline-block';
      launchConfetti();
      break;
    }
  }
  this.value = '';
});

document.getElementById('mystery-hidden-input').addEventListener('keydown', function(e) {
  if (e.key === 'Backspace') {
    e.preventDefault();
    if (mysteryState && !mysteryState.choiceMade) {
      mysteryState.typed = mysteryState.typed.slice(0, -1);
      document.getElementById('mystery-typing-area').textContent = mysteryState.typed;
    }
  }
  if (e.key === 'Escape') {
    clearMysteryParticles();
    showScreen('screen-title');
  }
});

function continueFromMystery() {
  sfxClick();
  clearMysteryParticles();
  startLessonGame(); // Start next lesson
}

// ============================================================
//  DAD - BRIEFCASE COLLECTOR / NEWS GAME üíº
// ============================================================
const DAD_NEWS_HEADLINES = [
  "the federal reserve announced rate decision today",
  "supreme court rules on landmark property case",
  "local firm wins record settlement for client",
  "stock market reaches new all time high today",
  "florida bar announces new ethics requirements",
  "commercial real estate market shows strong growth",
  "billable hour rates increase across major firms",
  "new legislation affects contract law provisions",
  "mergers and acquisitions activity surges this quarter",
  "cryptocurrency regulations face legal challenges",
];

const DAD_BREAKING = [
  "dow jones surges five hundred points on earnings",
  "breaking supreme court issues major ruling today",
  "flash florida governor signs new business law",
  "alert interest rates cut by fifty basis points",
];

let dadState = null;

function startDadGame() {
  const prompts = shuffle([...DAD_PROMPTS]).slice(0, 20);
  dadState = {
    prompts, currentIndex: 0, charIndex: 0,
    charResults: {},
    money: 0, briefcases: 0, briefcaseMeter: 0,
    streak: 0, totalCorrect: 0, totalTyped: 0,
    startTime: null, wordsCompleted: 0,
    breakingActive: false, breakingTimeout: null,
  };

  document.getElementById('dad-money').textContent = '$0.00';
  document.getElementById('dad-briefcases').textContent = '0';
  document.getElementById('dad-streak').textContent = '0';
  document.getElementById('dad-wpm').textContent = '0';
  document.getElementById('dad-briefcase-fill').style.width = '0%';
  document.getElementById('dad-breaking-news').classList.remove('show');

  showScreen('screen-dad');
  ensureAudio();
  startMusic();
  loadDadPrompt();

  const input = document.getElementById('dad-hidden-input');
  input.value = '';
  input.focus();
  document.getElementById('dad-typing-area').onclick = () => input.focus();

  // Schedule random breaking news
  scheduleDadBreaking();
}

function loadDadPrompt() {
  if (!dadState || dadState.currentIndex >= dadState.prompts.length) {
    endDadGame();
    return;
  }
  const p = dadState.prompts[dadState.currentIndex];
  dadState.charIndex = 0;
  dadState.charResults = {};
  document.getElementById('dad-hint').textContent = p.hint;
  document.getElementById('dad-category').textContent = p.category;
  renderDadChars();
}

function renderDadChars() {
  const text = dadState.prompts[dadState.currentIndex].text;
  const container = document.getElementById('dad-prompt-text');
  container.innerHTML = '';
  for (let i = 0; i < text.length; i++) {
    const span = document.createElement('span');
    span.className = 'char';
    if (text[i] === ' ') span.classList.add('space-char');
    span.textContent = text[i] === ' ' ? '\u00A0' : text[i];
    if (i < dadState.charIndex) {
      span.classList.add(dadState.charResults[i] ? 'correct' : 'incorrect');
    } else if (i === dadState.charIndex) {
      span.classList.add('current');
    } else {
      span.classList.add('upcoming');
    }
    container.appendChild(span);
  }
}

document.getElementById('dad-hidden-input').addEventListener('input', function(e) {
  if (!dadState) return;
  const typed = e.data;
  if (!typed) return;

  if (!dadState.startTime) dadState.startTime = Date.now();

  const text = dadState.prompts[dadState.currentIndex].text;
  const expected = text[dadState.charIndex];
  if (expected === undefined) return;

  dadState.totalTyped++;
  if (typed === expected) {
    dadState.charResults[dadState.charIndex] = true;
    dadState.totalCorrect++;
    dadState.streak++;
    const multiplier = dadState.breakingActive ? 2 : 1;
    const earned = (0.50 + dadState.streak * 0.10) * multiplier;
    dadState.money += earned;
    dadState.briefcaseMeter += 2;
    sfxCorrect();
  } else {
    dadState.charResults[dadState.charIndex] = false;
    dadState.streak = 0;
    dadState.money = Math.max(0, dadState.money - 0.25);
    sfxWrong();
  }

  document.getElementById('dad-money').textContent = '$' + dadState.money.toFixed(2);
  document.getElementById('dad-streak').textContent = dadState.streak;

  // Briefcase meter
  if (dadState.briefcaseMeter >= 100) {
    dadState.briefcaseMeter = 0;
    dadState.briefcases++;
    document.getElementById('dad-briefcases').textContent = dadState.briefcases;
    sfxCombo();
    showCombo('BRIEFCASE FILLED! üíº', 'var(--neon-green)');
  }
  document.getElementById('dad-briefcase-fill').style.width = dadState.briefcaseMeter + '%';

  // WPM
  if (dadState.startTime) {
    const elapsed = (Date.now() - dadState.startTime) / 60000;
    if (elapsed > 0) document.getElementById('dad-wpm').textContent = Math.round(dadState.wordsCompleted / elapsed);
  }

  dadState.charIndex++;
  if (dadState.charIndex >= text.length) {
    dadState.wordsCompleted += text.split(' ').length;
    dadState.currentIndex++;
    if (dadState.breakingActive) {
      dadState.breakingActive = false;
      document.getElementById('dad-breaking-news').classList.remove('show');
    }
    loadDadPrompt();
  } else {
    renderDadChars();
  }
  this.value = '';
});

document.getElementById('dad-hidden-input').addEventListener('keydown', function(e) {
  if (e.key === 'Backspace') {
    e.preventDefault();
    if (dadState && dadState.charIndex > 0) {
      dadState.charIndex--;
      delete dadState.charResults[dadState.charIndex];
      renderDadChars();
    }
  }
  if (e.key === 'Escape') {
    if (dadState && dadState.breakingTimeout) clearTimeout(dadState.breakingTimeout);
    stopMusic();
    showScreen('screen-title');
  }
});

function scheduleDadBreaking() {
  if (!dadState) return;
  const delay = 15000 + Math.random() * 20000;
  dadState.breakingTimeout = setTimeout(() => {
    if (!dadState || dadState.currentIndex >= dadState.prompts.length) return;
    // Insert a breaking news prompt
    const headline = DAD_BREAKING[Math.floor(Math.random() * DAD_BREAKING.length)];
    dadState.breakingActive = true;
    document.getElementById('dad-breaking-text').textContent = headline;
    document.getElementById('dad-breaking-news').classList.add('show');
    // Replace current prompt with breaking news
    dadState.prompts[dadState.currentIndex] = {
      text: headline, hint: '‚ö° BREAKING NEWS - 2x BONUS! ‚ö°', category: 'BREAKING NEWS'
    };
    dadState.charIndex = 0;
    dadState.charResults = {};
    loadDadPrompt();
    sfxLevelUp();
    // Auto-dismiss if not typed in time
    setTimeout(() => {
      if (dadState && dadState.breakingActive) {
        dadState.breakingActive = false;
        document.getElementById('dad-breaking-news').classList.remove('show');
      }
    }, 15000);
    // Schedule next
    scheduleDadBreaking();
  }, delay);
}

function endDadGame() {
  if (dadState && dadState.breakingTimeout) clearTimeout(dadState.breakingTimeout);
  stopMusic();
  sfxComplete();

  const ceoRatings = ['Intern', 'Analyst', 'Associate', 'VP', 'Director', 'CFO', 'CEO'];
  const ratingIdx = Math.min(ceoRatings.length - 1, Math.floor(dadState.briefcases / 2));
  const rating = ceoRatings[ratingIdx];
  const stars = Math.min(5, Math.max(1, Math.floor(ratingIdx * 5 / ceoRatings.length) + 1));

  document.getElementById('results-rank').textContent = 'üíº';
  document.getElementById('results-title').textContent = rating + ' Rating!';
  document.getElementById('results-subtitle').textContent =
    `$${dadState.money.toFixed(2)} earned, ${dadState.briefcases} briefcases ‚Äî Dad`;

  const starContainer = document.getElementById('star-rating');
  starContainer.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const s = document.createElement('span');
    s.className = `star ${i < stars ? 'filled' : 'empty'}`;
    s.textContent = i < stars ? '‚≠ê' : '‚òÜ';
    s.style.animationDelay = `${i * 0.15}s`;
    starContainer.appendChild(s);
  }

  document.getElementById('res-score').textContent = '$' + dadState.money.toFixed(2);
  document.getElementById('res-wpm').textContent = document.getElementById('dad-wpm').textContent;
  const acc = dadState.totalTyped > 0 ? Math.round(dadState.totalCorrect / dadState.totalTyped * 100) : 0;
  document.getElementById('res-accuracy').textContent = acc + '%';
  document.getElementById('res-streak').textContent = dadState.briefcases + ' üíº';
  document.getElementById('achievements').innerHTML = '';
  document.getElementById('spanish-learned').style.display = 'none';

  showScreen('screen-results');
  setTimeout(() => launchConfetti(), 300);
}

// ============================================================
//  ALICE - K-POP DEMON HUNTERS BATTLE üëæ
// ============================================================
const DEMON_EMOJIS = ['üëæ', 'üëπ', 'üßü', 'üíÄ', 'ü¶á', 'üêâ', 'üëª', 'üï∑Ô∏è'];
const ALICE_BATTLE_PROMPTS = [
  'a b', 'go', 'hi', 'pow', 'kick', 'zap', 'run', 'hit',
  'yay', 'pop', 'bam', 'yes', 'no no', 'la la', 'star',
  'sing', 'up up', 'big', 'fun', 'win', 'bow', 'jump',
  'fast', 'cool', 'fire', 'ice', 'moon',
];
const ALICE_TOYS = [
  { emoji: 'üß∏', name: 'Giant Teddy Bear', desc: 'A huge fluffy teddy bear to cuddle!' },
  { emoji: 'üé®', name: 'Art Supply Kit', desc: 'Crayons, markers, and sparkly stickers!' },
  { emoji: 'üëë', name: 'Princess Crown Set', desc: 'A sparkly crown with matching jewelry!' },
  { emoji: 'ü¶Ñ', name: 'Unicorn Plushie', desc: 'A magical rainbow unicorn!' },
  { emoji: 'üé™', name: 'Play-Doh Mega Set', desc: 'All the colors of Play-Doh!' },
  { emoji: 'üß©', name: 'Puzzle Adventure Box', desc: 'Fun puzzles with sparkly pieces!' },
  { emoji: 'üé§', name: 'K-Pop Microphone', desc: 'A real working karaoke mic!' },
  { emoji: 'üåà', name: 'Rainbow Slime Kit', desc: 'Make your own glitter slime!' },
];

let aliceState = null;

function startAliceGame() {
  aliceState = {
    wave: 1, totalWaves: 3, demonsDefeated: 0,
    demonHp: 100, demonMaxHp: 100,
    prompts: shuffle([...ALICE_BATTLE_PROMPTS]),
    promptIndex: 0, charIndex: 0, charResults: {},
    combo: 0, totalDamage: 0,
    active: true,
  };

  showScreen('screen-alice');
  ensureAudio();
  startMusic();
  loadAliceDemon();

  // Build keyboard for Alice (bigger display)
  buildAliceKeyboard();

  const input = document.getElementById('alice-hidden-input');
  input.value = '';
  input.focus();
}

function buildAliceKeyboard() {
  const kb = document.getElementById('alice-keyboard');
  kb.innerHTML = '';
  // Simplified keyboard for Alice - just letters
  const rows = [
    'QWERTYUIOP'.split(''),
    'ASDFGHJKL'.split(''),
    'ZXCVBNM'.split(''),
  ];
  rows.forEach(row => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'kb-row';
    row.forEach(k => {
      const keyDiv = document.createElement('div');
      keyDiv.className = 'kb-key';
      keyDiv.textContent = k;
      keyDiv.dataset.key = k;
      keyDiv.style.fontSize = '1rem';
      keyDiv.style.fontWeight = '900';
      rowDiv.appendChild(keyDiv);
    });
    kb.appendChild(rowDiv);
  });
  // Space bar
  const spaceRow = document.createElement('div');
  spaceRow.className = 'kb-row';
  const spaceKey = document.createElement('div');
  spaceKey.className = 'kb-key space';
  spaceKey.textContent = 'SPACE';
  spaceKey.dataset.key = 'SPACE';
  spaceRow.appendChild(spaceKey);
  kb.appendChild(spaceRow);
}

function loadAliceDemon() {
  const hp = 60 + aliceState.wave * 20;
  aliceState.demonMaxHp = hp;
  aliceState.demonHp = hp;
  aliceState.promptIndex = 0;
  aliceState.prompts = shuffle([...ALICE_BATTLE_PROMPTS]);

  const demonEl = document.getElementById('alice-demon');
  demonEl.textContent = DEMON_EMOJIS[Math.floor(Math.random() * DEMON_EMOJIS.length)];
  demonEl.classList.remove('hit', 'defeated');

  document.getElementById('alice-wave').textContent = `Wave ${aliceState.wave} / ${aliceState.totalWaves}`;
  updateAliceHp();
  loadAlicePrompt();
}

function loadAlicePrompt() {
  if (aliceState.promptIndex >= aliceState.prompts.length) {
    aliceState.prompts = shuffle([...ALICE_BATTLE_PROMPTS]);
    aliceState.promptIndex = 0;
  }
  aliceState.charIndex = 0;
  aliceState.charResults = {};
  renderAliceChars();
}

function renderAliceChars() {
  const text = aliceState.prompts[aliceState.promptIndex];
  const container = document.getElementById('alice-prompt-text');
  container.innerHTML = '';
  for (let i = 0; i < text.length; i++) {
    const span = document.createElement('span');
    span.className = 'char';
    span.textContent = text[i] === ' ' ? '\u00A0' : text[i];
    if (i < aliceState.charIndex) {
      span.classList.add(aliceState.charResults[i] ? 'correct' : 'incorrect');
    } else if (i === aliceState.charIndex) {
      span.classList.add('current');
    } else {
      span.classList.add('upcoming');
    }
    container.appendChild(span);
  }
}

function updateAliceHp() {
  const pct = Math.max(0, aliceState.demonHp / aliceState.demonMaxHp * 100);
  document.getElementById('alice-hp-fill').style.width = pct + '%';
  document.getElementById('alice-hp-text').textContent =
    `HP: ${Math.max(0, Math.round(aliceState.demonHp))} / ${aliceState.demonMaxHp}`;
}

function aliceHitDemon() {
  const el = document.getElementById('alice-demon');
  el.classList.remove('hit');
  void el.offsetWidth;
  el.classList.add('hit');
  setTimeout(() => el.classList.remove('hit'), 300);
}

document.getElementById('alice-hidden-input').addEventListener('input', function(e) {
  if (!aliceState || !aliceState.active) return;
  const typed = e.data;
  if (!typed) return;

  const text = aliceState.prompts[aliceState.promptIndex];
  const expected = text[aliceState.charIndex];
  if (expected === undefined) return;

  if (typed === expected) {
    aliceState.charResults[aliceState.charIndex] = true;
    aliceState.combo++;
    sfxCorrect();

    // Highlight key on Alice keyboard
    const keyStr = expected === ' ' ? 'SPACE' : expected.toUpperCase();
    const keyEl = document.querySelector('#alice-keyboard .kb-key[data-key="' + keyStr + '"]');
    if (keyEl) {
      keyEl.classList.add('pressed-correct');
      setTimeout(() => keyEl.classList.remove('pressed-correct'), 180);
    }
  } else {
    aliceState.charResults[aliceState.charIndex] = false;
    aliceState.combo = 0;
    sfxWrong();
  }

  document.getElementById('alice-combo').textContent = aliceState.combo;
  aliceState.charIndex++;

  if (aliceState.charIndex >= text.length) {
    // Prompt complete - deal damage!
    const baseDamage = 15 + Math.floor(Math.random() * 10);
    const comboBonus = Math.min(20, aliceState.combo * 2);
    const damage = baseDamage + comboBonus;
    aliceState.demonHp -= damage;
    aliceState.totalDamage += damage;
    document.getElementById('alice-damage').textContent = aliceState.totalDamage;

    aliceHitDemon();
    updateAliceHp();
    showCombo(`-${damage} HP! ‚öîÔ∏è`, 'var(--neon-pink)');

    if (aliceState.demonHp <= 0) {
      // Demon defeated!
      aliceState.demonsDefeated++;
      document.getElementById('alice-demon').classList.add('defeated');
      sfxLevelUp();
      launchConfetti();

      if (aliceState.demonsDefeated >= aliceState.totalWaves) {
        // All demons defeated - show toy prize!
        setTimeout(() => showAlicePrize(), 1000);
      } else {
        // Next wave
        aliceState.wave++;
        setTimeout(() => loadAliceDemon(), 1200);
      }
    } else {
      aliceState.promptIndex++;
      loadAlicePrompt();
    }
  } else {
    renderAliceChars();
  }
  this.value = '';
});

document.getElementById('alice-hidden-input').addEventListener('keydown', function(e) {
  if (e.key === 'Backspace') {
    e.preventDefault();
    if (aliceState && aliceState.charIndex > 0) {
      aliceState.charIndex--;
      delete aliceState.charResults[aliceState.charIndex];
      renderAliceChars();
    }
  }
  if (e.key === 'Escape') {
    stopMusic();
    showScreen('screen-title');
  }
});

function showAlicePrize() {
  stopMusic();
  const toy = ALICE_TOYS[Math.floor(Math.random() * ALICE_TOYS.length)];
  document.getElementById('alice-toy-emoji').textContent = toy.emoji;
  document.getElementById('alice-toy-name').textContent = toy.name;
  document.getElementById('alice-toy-desc').textContent = toy.desc;

  showScreen('screen-alice-prize');
  sfxComplete();
  launchConfetti();
  setTimeout(() => launchConfetti(), 1500);
}

// ============================================================
//  COPPER - FIND THE BONE YARD GRID ü¶¥
// ============================================================
const COPPER_SNIFF_PROMPTS = [
  'snif snif snif', 'bork bork snif', 'woof woof dig',
  'snif bnoe snif', 'wher iz bnoe', 'dig dig dig',
  'i smel somthin', 'bnoe detekted', 'snif the yrad',
];

let copperState = null;

function startCopperGame() {
  copperState = {
    round: 1, totalRounds: 3, bonesFound: 0, totalDigs: 0,
    bonePos: Math.floor(Math.random() * 9),
    phase: 'sniff', // 'sniff' -> 'dig'
    charIndex: 0, charResults: {},
    currentPrompt: '',
    gridRevealed: [],
    active: true,
  };

  document.getElementById('copper-round').textContent = 'Round 1 of 3';
  document.getElementById('copper-bones').textContent = '0';
  document.getElementById('copper-digs').textContent = '0';
  document.getElementById('copper-hint').textContent = 'Type the sniff prompt to start searching!';

  buildYardGrid();
  showScreen('screen-copper');
  ensureAudio();
  startMusic();
  loadCopperSniff();

  const input = document.getElementById('copper-hidden-input');
  input.value = '';
  input.focus();
  document.getElementById('copper-sniff-area').onclick = () => input.focus();

  // Keep bone button accessible for riddle system
  document.getElementById('bone-btn').style.display = 'block';
}

function buildYardGrid() {
  const grid = document.getElementById('yard-grid');
  grid.innerHTML = '';
  for (let i = 0; i < 9; i++) {
    const spot = document.createElement('div');
    spot.className = 'yard-spot';
    spot.innerHTML = `üåø<span class="spot-number">${i + 1}</span>`;
    spot.dataset.idx = i;
    spot.onclick = () => digSpot(i);
    grid.appendChild(spot);
  }
}

function loadCopperSniff() {
  copperState.phase = 'sniff';
  copperState.currentPrompt = COPPER_SNIFF_PROMPTS[Math.floor(Math.random() * COPPER_SNIFF_PROMPTS.length)];
  copperState.charIndex = 0;
  copperState.charResults = {};
  document.getElementById('copper-hint').textContent = 'üêï Sniff around to find the bone!';
  renderCopperChars();
}

function renderCopperChars() {
  const text = copperState.currentPrompt;
  const container = document.getElementById('copper-prompt-text');
  container.innerHTML = '';
  for (let i = 0; i < text.length; i++) {
    const span = document.createElement('span');
    span.className = 'char';
    if (text[i] === ' ') span.classList.add('space-char');
    span.textContent = text[i] === ' ' ? '\u00A0' : text[i];
    if (i < copperState.charIndex) {
      span.classList.add(copperState.charResults[i] ? 'correct' : 'incorrect');
    } else if (i === copperState.charIndex) {
      span.classList.add('current');
    } else {
      span.classList.add('upcoming');
    }
    container.appendChild(span);
  }
}

document.getElementById('copper-hidden-input').addEventListener('input', function(e) {
  if (!copperState || !copperState.active) return;
  const typed = e.data;
  if (!typed) return;

  const text = copperState.currentPrompt;
  const expected = text[copperState.charIndex];
  if (expected === undefined) return;

  if (typed === expected) {
    copperState.charResults[copperState.charIndex] = true;
    sfxCorrect();
  } else {
    copperState.charResults[copperState.charIndex] = false;
    sfxWrong();
  }

  copperState.charIndex++;

  if (copperState.charIndex >= text.length) {
    if (copperState.phase === 'sniff') {
      // Sniff complete - now in dig phase
      copperState.phase = 'dig';
      document.getElementById('copper-hint').textContent =
        'üî• Now type a number (1-9) to dig that spot!';
      copperState.currentPrompt = '';
      document.getElementById('copper-prompt-text').innerHTML =
        '<span style="color:var(--neon-yellow);font-family:Fredoka One,cursive;">Type 1-9 to dig!</span>';
    }
  } else {
    renderCopperChars();
  }
  this.value = '';
});

document.getElementById('copper-hidden-input').addEventListener('keydown', function(e) {
  if (!copperState || !copperState.active) return;

  if (e.key === 'Backspace') {
    e.preventDefault();
    if (copperState.phase === 'sniff' && copperState.charIndex > 0) {
      copperState.charIndex--;
      delete copperState.charResults[copperState.charIndex];
      renderCopperChars();
    }
    return;
  }

  if (e.key === 'Escape') {
    stopMusic();
    showScreen('screen-title');
    return;
  }

  // Dig phase - type a number
  if (copperState.phase === 'dig' && e.key >= '1' && e.key <= '9') {
    e.preventDefault();
    digSpot(parseInt(e.key) - 1);
  }
});

function digSpot(idx) {
  if (!copperState || copperState.phase !== 'dig') return;
  if (copperState.gridRevealed.includes(idx)) return;

  copperState.gridRevealed.push(idx);
  copperState.totalDigs++;
  document.getElementById('copper-digs').textContent = copperState.totalDigs;

  const spots = document.querySelectorAll('.yard-spot');
  const spot = spots[idx];
  spot.classList.add('dug');

  if (idx === copperState.bonePos) {
    // Found the bone!
    spot.innerHTML = `ü¶¥<span class="spot-number">${idx + 1}</span>`;
    spot.classList.add('found-bone');
    copperState.bonesFound++;
    document.getElementById('copper-bones').textContent = copperState.bonesFound;
    document.getElementById('copper-hint').textContent = 'ü¶¥ BONE FOUND! BORK BORK BORK!';
    sfxLevelUp();
    launchConfetti();

    // Next round or end
    if (copperState.round >= copperState.totalRounds) {
      setTimeout(() => endCopperGame(), 2000);
    } else {
      copperState.round++;
      setTimeout(() => {
        copperState.bonePos = Math.floor(Math.random() * 9);
        copperState.gridRevealed = [];
        document.getElementById('copper-round').textContent =
          `Round ${copperState.round} of ${copperState.totalRounds}`;
        buildYardGrid();
        loadCopperSniff();
      }, 1500);
    }
  } else {
    // Not here - give hint
    const boneRow = Math.floor(copperState.bonePos / 3);
    const boneCol = copperState.bonePos % 3;
    const digRow = Math.floor(idx / 3);
    const digCol = idx % 3;
    const dist = Math.abs(boneRow - digRow) + Math.abs(boneCol - digCol);

    let hint, emoji;
    if (dist <= 1) { hint = 'HOT! üî• Very close!'; emoji = 'üî•'; }
    else if (dist <= 2) { hint = 'Warm... getting closer!'; emoji = '‚òÄÔ∏è'; }
    else { hint = 'Cold... try somewhere else!'; emoji = '‚ùÑÔ∏è'; }

    spot.innerHTML = `${emoji}<span class="spot-number">${idx + 1}</span>`;
    document.getElementById('copper-hint').textContent = hint;
    sfxWrong();

    // Go back to sniff phase for another attempt
    setTimeout(() => {
      if (copperState && copperState.active && copperState.phase === 'dig') {
        loadCopperSniff();
      }
    }, 800);
  }
}

function endCopperGame() {
  copperState.active = false;
  stopMusic();
  sfxComplete();

  const stars = Math.min(5, copperState.bonesFound + 2);
  document.getElementById('results-rank').textContent = 'ü¶¥';
  document.getElementById('results-title').textContent =
    copperState.bonesFound === 3 ? 'BEST BOI! All Bones Found!' : `${copperState.bonesFound}/3 Bones Found!`;
  document.getElementById('results-subtitle').textContent =
    `${copperState.totalDigs} digs total ‚Äî Copper`;

  const starContainer = document.getElementById('star-rating');
  starContainer.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const s = document.createElement('span');
    s.className = `star ${i < stars ? 'filled' : 'empty'}`;
    s.textContent = i < stars ? '‚≠ê' : '‚òÜ';
    s.style.animationDelay = `${i * 0.15}s`;
    starContainer.appendChild(s);
  }

  document.getElementById('res-score').textContent = copperState.bonesFound;
  document.getElementById('res-wpm').textContent = '‚Äî';
  document.getElementById('res-accuracy').textContent =
    copperState.totalDigs > 0 ? Math.round(copperState.bonesFound / copperState.totalDigs * 100) + '%' : '‚Äî';
  document.getElementById('res-streak').textContent = copperState.bonesFound + ' ü¶¥';
  document.getElementById('achievements').innerHTML = '';
  document.getElementById('spanish-learned').style.display = 'none';

  showScreen('screen-results');
  setTimeout(() => launchConfetti(), 300);
}
</script>
</body>
</html>